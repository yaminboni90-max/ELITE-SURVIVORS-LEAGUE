<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ESL Admin Panel</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
        :root {
            --primary: #FF4500;
            --primary-dark: #CC3700;
            --bg: #0a0a0a;
            --bg-card: #161616;
            --bg-input: #0f0f0f;
            --text: #ffffff;
            --text-muted: #888;
            --border: #2a2a2a;
            --success: #00e676;
            --danger: #ff1744;
            --warning: #ffab00;
            --nav-height: 64px;
            --header-height: 56px;
        }
        html, body { height:100%; overflow:hidden; background:var(--bg); color:var(--text); font-family:'Poppins',sans-serif; }

        /* ======= LOGIN ======= */
        #loginPage {
            position:fixed; inset:0; background:var(--bg);
            display:flex; flex-direction:column; align-items:center; justify-content:center;
            padding:24px; z-index:1000;
        }

        .login-logo { text-align:center; margin-bottom:40px; position:relative; }
        .login-logo .icon { font-size:48px; margin-bottom:12px; display:block; }
        .login-logo h1 { font-family:'Poppins',sans-serif; font-size:22px; font-weight:900; color:var(--primary); letter-spacing:2px; }
        .login-logo p { color:var(--text-muted); font-size:13px; margin-top:4px; }
        .login-box { width:100%; max-width:380px; position:relative; }
        .login-field { margin-bottom:18px; }
        .login-field label { display:block; font-size:12px; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; margin-bottom:8px; }
        .login-field input { width:100%; padding:16px 18px; background:var(--bg-card); border:2px solid var(--border); border-radius:12px; color:var(--text); font-size:16px; font-family:'Poppins',sans-serif; outline:none; transition:border-color .2s; }
        .login-field input:focus { border-color:var(--primary); }
        .btn-login { width:100%; padding:18px; background:linear-gradient(135deg,var(--primary),var(--primary-dark)); border:none; border-radius:12px; color:#fff; font-size:17px; font-weight:700; font-family:'Poppins',sans-serif; letter-spacing:1px; cursor:pointer; margin-top:8px; box-shadow:0 8px 24px rgba(255,69,0,0.35); }
        .btn-login:active { transform:scale(0.98); }

        /* ======= MAIN APP ======= */
        #adminPanel { display:none; position:fixed; inset:0; flex-direction:column; }
        #adminPanel.show { display:flex; }

        /* Header */
        .app-header { height:var(--header-height); background:var(--bg-card); border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; padding:0 16px; flex-shrink:0; position:relative; z-index:50; }
        .header-menu-btn { font-size:22px; background:none; border:none; color:var(--text); cursor:pointer; padding:8px; }
        .header-title { font-family:'Poppins',sans-serif; font-size:13px; font-weight:900; color:var(--primary); letter-spacing:1px; text-align:center; flex:1; }
        .header-page { font-size:11px; color:var(--text-muted); text-align:center; font-weight:500; text-transform:uppercase; letter-spacing:0.5px; }
        .header-right { display:flex; align-items:center; gap:8px; }
        .btn-logout-sm { padding:8px 14px; background:var(--danger); border:none; border-radius:8px; color:#fff; font-size:12px; font-weight:700; cursor:pointer; font-family:'Poppins',sans-serif; }

        /* Content */
        .app-body { flex:1; overflow-y:auto; padding:16px 16px 80px; -webkit-overflow-scrolling:touch; }

        /* Bottom Nav */
        .bottom-nav { height:var(--nav-height); background:var(--bg-card); border-top:1px solid var(--border); display:flex; align-items:stretch; flex-shrink:0; position:relative; z-index:50; }
        .nav-item { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:3px; cursor:pointer; transition:all .2s; border:none; background:none; color:var(--text-muted); font-family:'Poppins',sans-serif; }
        .nav-item.active { color:var(--primary); }
        .nav-item .nav-icon { font-size:20px; line-height:1; }
        .nav-item .nav-label { font-size:9px; font-weight:600; text-transform:uppercase; letter-spacing:0.5px; }

        /* Slide Drawer */
        .drawer-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:200; }
        .drawer-overlay.open { display:block; }
        .drawer { position:fixed; left:-280px; top:0; width:280px; height:100%; background:var(--bg-card); border-right:1px solid var(--border); z-index:201; transition:left .3s ease; display:flex; flex-direction:column; overflow-y:auto; }
        .drawer.open { left:0; }
        .drawer-header { padding:24px 20px 20px; border-bottom:1px solid var(--border); }
        .drawer-header h2 { font-family:'Poppins',sans-serif; font-size:16px; color:var(--primary); font-weight:900; }
        .drawer-header p { font-size:12px; color:var(--text-muted); margin-top:4px; }
        .drawer-section { padding:12px 0; border-bottom:1px solid var(--border); }
        .drawer-section-label { padding:8px 20px 4px; font-size:10px; color:var(--text-muted); text-transform:uppercase; letter-spacing:1.5px; font-weight:600; }
        .drawer-item { padding:14px 20px; display:flex; align-items:center; gap:14px; cursor:pointer; transition:background .15s; font-size:15px; font-weight:500; color:var(--text); }
        .drawer-item:active, .drawer-item.active { background:rgba(255,69,0,0.12); color:var(--primary); }
        .drawer-item .d-icon { font-size:18px; width:24px; text-align:center; }

        /* Content Sections */
        .section { display:none; }
        .section.active { display:block; animation:fadeUp .25s ease; }
        @keyframes fadeUp { from{opacity:0;transform:translateY(12px)} to{opacity:1;transform:translateY(0)} }

        /* Stats Grid */
        .stats-grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:16px; }
        .stat-card { background:var(--bg-card); border-radius:14px; border:1px solid var(--border); padding:16px; position:relative; overflow:hidden; }
        .stat-card::before { content:''; position:absolute; top:0; left:0; right:0; height:3px; background:linear-gradient(90deg,var(--primary),var(--primary-dark)); }
        .stat-icon { font-size:24px; margin-bottom:8px; }
        .stat-val { font-family:'Poppins',sans-serif; font-size:26px; font-weight:900; line-height:1; }
        .stat-lbl { font-size:11px; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px; margin-top:4px; font-weight:500; }

        /* Section Header */
        .sec-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; }
        .sec-title { font-family:'Poppins',sans-serif; font-size:14px; font-weight:700; }
        .btn-add { padding:10px 18px; background:var(--primary); border:none; border-radius:10px; color:#fff; font-size:13px; font-weight:700; cursor:pointer; font-family:'Poppins',sans-serif; }
        .btn-add:active { transform:scale(0.97); }

        /* Cards */
        .card { background:var(--bg-card); border:1px solid var(--border); border-radius:14px; padding:16px; margin-bottom:12px; }
        .card-row { display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; }
        .card-row:last-child { margin-bottom:0; }
        .card-label { font-size:11px; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px; }
        .card-value { font-size:14px; font-weight:600; }
        .card-title { font-size:16px; font-weight:700; margin-bottom:8px; }
        .card-actions { display:flex; gap:8px; margin-top:12px; }
        .btn-sm { flex:1; padding:10px 8px; border:none; border-radius:8px; font-size:12px; font-weight:700; cursor:pointer; font-family:'Poppins',sans-serif; text-transform:uppercase; letter-spacing:0.5px; }
        .btn-approve { background:var(--success); color:#000; }
        .btn-reject { background:var(--danger); color:#fff; }
        .btn-delete { background:var(--danger); color:#fff; }
        .btn-edit-sm { background:#1a73e8; color:#fff; }
        .btn-sm:active { transform:scale(0.96); }

        /* Badge */
        .badge { padding:4px 10px; border-radius:20px; font-size:11px; font-weight:700; text-transform:uppercase; }
        .badge-pending { background:rgba(255,171,0,0.2); color:var(--warning); }
        .badge-approved { background:rgba(0,230,118,0.15); color:var(--success); }
        .badge-rejected { background:rgba(255,23,68,0.15); color:var(--danger); }
        .badge-active { background:rgba(255,69,0,0.2); color:var(--primary); }
        .badge-completed { background:rgba(0,230,118,0.15); color:var(--success); }

        /* Forms */
        .form-group { margin-bottom:16px; }
        .form-group label { display:block; font-size:12px; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px; margin-bottom:8px; font-weight:600; }
        .form-group input, .form-group select, .form-group textarea { width:100%; padding:14px 16px; background:var(--bg-input); border:2px solid var(--border); border-radius:10px; color:var(--text); font-size:16px; font-family:'Poppins',sans-serif; outline:none; transition:border-color .2s; -webkit-appearance:none; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color:var(--primary); }
        .form-group textarea { min-height:100px; resize:vertical; }
        .form-grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; }

        /* Bottom Sheet Modal */
        .sheet-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:300; }
        .sheet-overlay.open { display:block; }
        .sheet { position:fixed; bottom:-100%; left:0; right:0; background:var(--bg-card); border-radius:20px 20px 0 0; border-top:1px solid var(--border); z-index:301; transition:bottom .35s cubic-bezier(.32,.72,0,1); max-height:90vh; display:flex; flex-direction:column; }
        .sheet.open { bottom:0; }
        .sheet-handle { width:40px; height:4px; background:var(--border); border-radius:2px; margin:12px auto 0; }
        .sheet-header { padding:16px 20px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; flex-shrink:0; }
        .sheet-title { font-family:'Poppins',sans-serif; font-size:15px; font-weight:700; }
        .sheet-close { background:none; border:none; color:var(--text-muted); font-size:22px; cursor:pointer; padding:4px; line-height:1; }
        .sheet-body { overflow-y:auto; padding:20px; flex:1; -webkit-overflow-scrolling:touch; }
        .sheet-footer { padding:16px 20px; border-top:1px solid var(--border); display:flex; gap:12px; flex-shrink:0; }
        .btn-full { flex:1; padding:16px; border:none; border-radius:12px; font-size:16px; font-weight:700; cursor:pointer; font-family:'Poppins',sans-serif; }
        .btn-primary-full { background:linear-gradient(135deg,var(--primary),var(--primary-dark)); color:#fff; box-shadow:0 6px 20px rgba(255,69,0,0.3); }
        .btn-secondary-full { background:var(--border); color:var(--text-muted); }
        .btn-full:active { transform:scale(0.98); }

        /* Empty state */
        .empty { text-align:center; padding:40px 20px; }
        .empty .empty-icon { font-size:48px; margin-bottom:12px; opacity:0.5; }
        .empty p { color:var(--text-muted); font-size:14px; }

        /* Content box */
        .content-box { background:var(--bg-input); border:1px solid var(--border); border-radius:12px; padding:16px; }
        .content-box h3 { color:var(--primary); font-size:16px; margin-bottom:8px; }
        .content-box p { font-size:14px; line-height:1.6; color:var(--text); }
        .content-box small { color:var(--text-muted); font-size:12px; }

        /* Settings */
        .settings-card { background:var(--bg-card); border:1px solid var(--border); border-radius:14px; padding:16px; margin-bottom:16px; }
        .settings-card h3 { font-size:13px; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; margin-bottom:14px; font-weight:600; }

        /* Toast */
        #toast { position:fixed; bottom:80px; left:50%; transform:translateX(-50%) translateY(20px); background:var(--bg-card); border:1px solid var(--border); border-radius:12px; padding:12px 24px; font-size:14px; font-weight:600; opacity:0; transition:all .3s; z-index:999; white-space:nowrap; box-shadow:0 8px 32px rgba(0,0,0,0.4); }
        #toast.show { opacity:1; transform:translateX(-50%) translateY(0); }
        #toast.success { border-color:var(--success); color:var(--success); }
        #toast.error { border-color:var(--danger); color:var(--danger); }

        /* ======= DISTRIBUTE PRIZES MODAL ======= */
        .modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:400; align-items:center; justify-content:center; padding:16px; }
        .modal-overlay.open { display:flex; }
        .modal-box { background:#fff; border-radius:20px; width:100%; max-width:420px; max-height:85vh; display:flex; flex-direction:column; overflow:hidden; }
        
        /* ‚úÖ Responsive: Make modal bigger on PC/desktop */
        @media (min-width: 768px) {
            .modal-box { max-width: 800px; max-height: 90vh; }
        }
        
        .modal-header { padding:20px 20px 0; display:flex; align-items:center; justify-content:space-between; }
        .modal-title { font-family:'Poppins',sans-serif; font-size:20px; font-weight:700; color:#111; }
        .modal-close-btn { width:36px; height:36px; border-radius:10px; background:#f0f0f0; border:none; cursor:pointer; font-size:16px; color:#666; display:flex; align-items:center; justify-content:center; font-weight:700; }
        .modal-divider { height:1px; background:#e8e8e8; margin:14px 0 0; }
        .modal-body { overflow-y:auto; flex:1; -webkit-overflow-scrolling:touch; }
        .modal-footer { padding:16px 20px; border-top:1px solid #e8e8e8; }

        /* Prize Table */
        .prize-table { width:100%; border-collapse:collapse; }
        .prize-table thead tr { background:#f5f5f5; }
        .prize-table th { padding:10px 8px; text-align:left; font-size:11px; color:#888; text-transform:uppercase; letter-spacing:0.5px; font-weight:600; font-family:'Poppins',sans-serif; }
        .prize-table tbody tr { border-bottom:1px solid #f0f0f0; }
        .prize-table td { padding:12px 8px; font-size:14px; color:#111; font-family:'Poppins',sans-serif; font-weight:500; }
        .prize-table .td-uid { color:#888; font-size:12px; }
        .prize-input { width:72px; padding:8px 10px; background:#fff; border:2px solid #e0e0e0; border-radius:8px; color:#111; font-size:14px; font-family:'Poppins',sans-serif; outline:none; text-align:center; transition:border-color .2s; -webkit-appearance:none; appearance:none; }
        .prize-input:focus { border-color:#FF4500; }

        /* Submit & Distribute button */
        .btn-distribute { width:100%; padding:16px; background:#00c853; border:none; border-radius:12px; color:#fff; font-size:16px; font-weight:700; font-family:'Poppins',sans-serif; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px; }
        .btn-distribute:active { transform:scale(0.98); background:#00b548; }

        /* Result table */
        .result-table-wrap { overflow-x:auto; }
        .result-table { width:100%; border-collapse:collapse; }
        .result-table thead tr { background:var(--bg-card); border-bottom:2px solid var(--border); }
        .result-table th { padding:12px 10px; text-align:left; font-size:11px; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px; font-weight:600; white-space:nowrap; }
        .result-table tbody tr { border-bottom:1px solid var(--border); transition:background .15s; }
        .result-table tbody tr:hover { background:rgba(255,69,0,0.04); }
        .result-table td { padding:12px 10px; font-size:14px; color:var(--text); vertical-align:middle; }
        .declare-btn { background:linear-gradient(135deg,var(--primary),var(--primary-dark)); color:#fff; border:none; border-radius:8px; padding:8px 16px; font-size:12px; font-weight:700; cursor:pointer; font-family:'Poppins',sans-serif; white-space:nowrap; }
        .declare-btn:active { transform:scale(0.96); }
        .joined-badge { display:inline-block; background:var(--bg-card); border:1px solid var(--border); border-radius:8px; padding:4px 12px; font-size:13px; font-weight:700; color:var(--primary); }

        /* Winner Board Styling - ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡ßÄ‡¶®‡¶∂‡¶ü ‡¶è‡¶∞ ‡¶Æ‡¶§‡ßã */
        .winner-card { background:var(--bg-card); border:1px solid var(--border); border-radius:16px; padding:0; margin-bottom:16px; overflow:hidden; position:relative; }
        .winner-card-actions { position:absolute; top:12px; right:12px; display:flex; gap:6px; z-index:10; }
        .winner-action-btn { width:32px; height:32px; border-radius:8px; border:none; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:14px; transition:all 0.2s; box-shadow:0 2px 8px rgba(0,0,0,0.15); }
        .winner-edit-btn { background:rgba(30,144,255,0.9); color:#fff; }
        .winner-edit-btn:hover { background:#1E90FF; transform:scale(1.05); }
        .winner-delete-btn { background:rgba(255,23,68,0.9); color:#fff; }
        .winner-delete-btn:hover { background:var(--danger); transform:scale(1.05); }
        .winner-card-header { background:linear-gradient(135deg, rgba(255,69,0,0.1), rgba(255,69,0,0.05)); padding:16px; padding-right:85px; border-bottom:1px solid var(--border); }
        .winner-card-title { font-size:16px; font-weight:800; color:var(--text); margin-bottom:8px; display:flex; align-items:center; gap:8px; }
        .winner-card-meta { display:flex; justify-content:space-between; align-items:center; margin-top:8px; }
        .winner-card-date { font-size:12px; color:var(--text-muted); }
        .winner-info-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:12px; padding:16px; background:var(--bg-input); border-bottom:1px solid var(--border); }
        .winner-info-item { text-align:center; }
        .winner-info-label { font-size:10px; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px; margin-bottom:4px; }
        .winner-info-value { font-size:18px; font-weight:800; color:var(--text); }
        .winner-info-value.success { color:var(--success); }
        .winner-section-header { background:#FFA500; color:#000; padding:10px 16px; text-align:center; font-size:13px; font-weight:800; text-transform:uppercase; letter-spacing:1px; }
        .winner-section-header.full { background:#1E90FF; color:#fff; }
        .winner-list-header { background:#1E90FF; color:#fff; padding:10px 16px; display:grid; grid-template-columns:60px 150px 80px 100px; gap:8px; font-size:11px; font-weight:700; text-transform:uppercase; border-left:2px solid var(--border); border-right:2px solid var(--border); min-width:390px; }
        .winner-item { display:grid; grid-template-columns:60px 150px 80px 100px; gap:8px; padding:12px 16px; border:1px solid var(--border); align-items:center; background:var(--bg); min-width:390px; }
        .winner-item:last-child { border-bottom:1px solid var(--border); }
        .winner-rank { font-size:16px; font-weight:700; text-align:center; color:var(--text-muted); }
        .winner-name { font-size:14px; font-weight:600; color:var(--text); text-align:left; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
        .winner-kills { font-size:14px; text-align:center; color:var(--text); font-weight:600; }
        .winner-prize { font-size:15px; font-weight:800; text-align:right; color:var(--success); }
        
        /* Horizontal scroll wrapper for winner tables */
        .winner-table-wrapper { overflow-x:auto; -webkit-overflow-scrolling:touch; margin:16px; border:3px solid; border-radius:12px; }

        ::-webkit-scrollbar { width:4px; }
        ::-webkit-scrollbar-track { background:transparent; }
        ::-webkit-scrollbar-thumb { background:var(--border); border-radius:2px; }
        
        /* ======= IMAGE VIEWER MODAL ======= */
        .image-viewer-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .image-viewer-overlay.active {
            display: flex;
        }
        .image-viewer-container {
            position: relative;
            max-width: 100%;
            max-height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .image-viewer-close {
            position: absolute;
            top: -50px;
            right: 0;
            background: var(--danger);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            color: white;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        .image-viewer-img {
            max-width: 100%;
            max-height: 80vh;
            object-fit: contain;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }
        .image-viewer-title {
            margin-top: 16px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            text-align: center;
        }
    </style>
</head>
<body>

<!-- ========== LOGIN ========== -->
<div id="loginPage">
    <div class="login-logo">
        <span class="icon">üéÆ</span>
        <h1>ESL ADMIN</h1>
        <p>Elite Survivors League</p>
    </div>
    <div class="login-box">
        <div class="login-field">
            <label>Admin Password</label>
            <input type="password" id="loginPassword" placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶¶‡¶ø‡¶®" value="12345">
        </div>
        <button class="btn-login" onclick="doLogin()">‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>
</div>

<!-- ========== ADMIN PANEL ========== -->
<div id="adminPanel">
    <div class="app-header">
        <button class="header-menu-btn" onclick="toggleDrawer()">‚ò∞</button>
        <div style="text-align:center; flex:1;">
            <div class="header-title">ESL ADMIN</div>
            <div class="header-page" id="headerPage">Dashboard</div>
        </div>
        <button class="btn-logout-sm" onclick="doLogout()">Logout</button>
    </div>

    <div class="app-body" id="appBody">

        <!-- Dashboard -->
        <div id="sec-dashboard" class="section active">
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-icon">üë•</div><div class="stat-val" id="totalUsers">0</div><div class="stat-lbl">Total Users</div></div>
                <div class="stat-card"><div class="stat-icon">üí∞</div><div class="stat-val" id="pendingDeposits">0</div><div class="stat-lbl">Pending Dep.</div></div>
                <div class="stat-card"><div class="stat-icon">üéÆ</div><div class="stat-val" id="activeMatches">0</div><div class="stat-lbl">Active Match</div></div>
                <div class="stat-card"><div class="stat-icon">‚ö†Ô∏è</div><div class="stat-val" id="pendingWithdraw">0</div><div class="stat-lbl">Pending With.</div></div>
            </div>
            
            <!-- New Prize Status Cards -->
            <div class="stats-grid" style="margin-top:16px;">
                <div class="stat-card" style="background:linear-gradient(135deg, rgba(255,193,7,0.1), rgba(255,193,7,0.05)); cursor:pointer;" onclick="showPrizePendingMatches()">
                    <div class="stat-icon">üèÜ</div>
                    <div class="stat-val" id="prizePending">0</div>
                    <div class="stat-lbl">Prize Pending</div>
                </div>
                <div class="stat-card" style="background:linear-gradient(135deg, rgba(255,23,68,0.1), rgba(255,23,68,0.05)); cursor:pointer;" onclick="showPrizeMismatches()">
                    <div class="stat-icon">‚ö†Ô∏è</div>
                    <div class="stat-val" id="prizeMismatch">0</div>
                    <div class="stat-lbl">Prize Mismatch</div>
                </div>
            </div>
            
            <!-- New Analytics Section -->
            <div style="margin-top:24px; margin-bottom:12px;">
                <div style="font-size:15px; font-weight:700; color:var(--text); margin-bottom:12px;">üìä Daily Analytics</div>
                <div style="margin-bottom:12px;">
                    <label style="font-size:12px; color:var(--text-muted); display:block; margin-bottom:6px;">Select Date:</label>
                    <input type="date" id="analyticsDateSelector" style="width:100%; padding:12px; background:var(--bg-card); border:1px solid var(--border); border-radius:8px; color:var(--text); font-size:14px;" onchange="loadAnalytics()">
                </div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card" style="background:linear-gradient(135deg, rgba(0,230,118,0.1), rgba(0,230,118,0.05));"><div class="stat-icon">üíµ</div><div class="stat-val" id="totalDepositAccepted">0‡ß≥</div><div class="stat-lbl">Deposit Accepted</div></div>
                <div class="stat-card" style="background:linear-gradient(135deg, rgba(255,23,68,0.1), rgba(255,23,68,0.05));"><div class="stat-icon">üí∏</div><div class="stat-val" id="totalWithdrawAccepted">0‡ß≥</div><div class="stat-lbl">Withdraw Accepted</div></div>
            </div>
            
            <div class="card" style="background:linear-gradient(135deg,rgba(255,69,0,0.1),rgba(0,0,0,0)); border-color:rgba(255,69,0,0.3);">
                <div style="font-size:13px; color:var(--text-muted); margin-bottom:4px;">Welcome back,</div>
                <div style="font-size:16px; font-weight:700;" id="adminEmail">Admin</div>
            </div>
        </div>

        <!-- Wallet Summary Section -->
        <div id="sec-wallet-summary" class="section">

            <!-- Section Header -->
            <div style="margin-bottom:16px;">
                <div style="font-size:15px; font-weight:700; color:var(--text); margin-bottom:4px;">üíº Wallet Summary</div>
                <div style="font-size:12px; color:var(--text-muted);">‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ ‡¶Ü‡¶≤‡¶æ‡¶¶‡¶æ‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®</div>
            </div>

            <!-- Date Selector -->
            <div class="card" style="margin-bottom:14px; background:linear-gradient(135deg,rgba(255,69,0,0.08),rgba(0,0,0,0)); border-color:rgba(255,69,0,0.25);">
                <div style="display:flex; align-items:center; gap:8px; margin-bottom:10px;">
                    <span style="font-size:18px;">üìÖ</span>
                    <div style="font-size:11px; font-weight:700; color:var(--text); text-transform:uppercase; letter-spacing:1px;">‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</div>
                </div>
                <input type="date" id="ws-date"
                    style="width:100%; padding:12px 14px; background:var(--bg-input); border:2px solid rgba(255,69,0,0.3); border-radius:10px; color:var(--text); font-size:15px; font-family:'Poppins',sans-serif; outline:none; box-sizing:border-box; transition:border-color .2s;"
                    onfocus="this.style.borderColor='var(--primary)'"
                    onblur="this.style.borderColor='rgba(255,69,0,0.3)'"
                    onchange="loadWalletSummaryForDate()">
                <div style="display:flex; gap:8px; margin-top:10px;">
                    <button onclick="saveWalletSummary()"
                        style="flex:1; padding:11px; background:linear-gradient(135deg,var(--primary),var(--primary-dark)); border:none; border-radius:10px; color:#fff; font-size:13px; font-weight:700; cursor:pointer; font-family:'Poppins',sans-serif;">
                        üíæ ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®
                    </button>
                    <button onclick="editWalletSummary()"
                        style="padding:11px 14px; background:rgba(100,181,246,0.15); border:1px solid rgba(100,181,246,0.4); border-radius:10px; color:#64b5f6; font-size:13px; font-weight:700; cursor:pointer; font-family:'Poppins',sans-serif;">
                        ‚úèÔ∏è ‡¶è‡¶°‡¶ø‡¶ü
                    </button>
                    <button onclick="deleteWalletSummary()"
                        style="padding:11px 14px; background:rgba(255,23,68,0.12); border:1px solid rgba(255,23,68,0.35); border-radius:10px; color:#ff1744; font-size:13px; font-weight:700; cursor:pointer; font-family:'Poppins',sans-serif;">
                        üóëÔ∏è
                    </button>
                </div>
            </div>

            <!-- Input Fields -->
            <!-- Total Deposit -->
            <div class="card" style="margin-bottom:10px; background:linear-gradient(135deg,rgba(0,230,118,0.07),rgba(0,0,0,0)); border-color:rgba(0,230,118,0.2);">
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                    <div style="width:36px;height:36px;background:rgba(0,230,118,0.15);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;">üíµ</div>
                    <div>
                        <div style="font-size:12px; font-weight:700; color:#00e676; text-transform:uppercase; letter-spacing:0.5px;">Total Deposit</div>
                        <div style="font-size:11px; color:var(--text-muted);">‡¶Ü‡¶ú‡¶ï‡ßá ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶∞‡¶æ ‡¶ï‡¶§ ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá‡¶õ‡ßá</div>
                    </div>
                </div>
                <input type="number" id="ws-deposit" placeholder="0" min="0" step="1"
                    style="width:100%; padding:13px 14px; background:var(--bg-input); border:2px solid rgba(0,230,118,0.25); border-radius:10px; color:#00e676; font-size:22px; font-weight:800; font-family:'Poppins',sans-serif; outline:none; box-sizing:border-box; transition:border-color .2s;"
                    onfocus="this.style.borderColor='#00e676'"
                    onblur="this.style.borderColor='rgba(0,230,118,0.25)'"
                    oninput="calcWalletResult()">
            </div>

            <!-- Total Withdraw -->
            <div class="card" style="margin-bottom:10px; background:linear-gradient(135deg,rgba(255,23,68,0.07),rgba(0,0,0,0)); border-color:rgba(255,23,68,0.2);">
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                    <div style="width:36px;height:36px;background:rgba(255,23,68,0.15);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;">üí∏</div>
                    <div>
                        <div style="font-size:12px; font-weight:700; color:#ff1744; text-transform:uppercase; letter-spacing:0.5px;">Total Withdraw</div>
                        <div style="font-size:11px; color:var(--text-muted);">‡¶ì‡¶Ø‡¶º‡ßá‡¶¨‡¶∏‡¶æ‡¶á‡¶ü ‡¶•‡ßá‡¶ï‡ßá ‡¶ï‡¶§ ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶¨‡ßá‡¶∞ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá</div>
                    </div>
                </div>
                <input type="number" id="ws-withdraw" placeholder="0" min="0" step="1"
                    style="width:100%; padding:13px 14px; background:var(--bg-input); border:2px solid rgba(255,23,68,0.25); border-radius:10px; color:#ff1744; font-size:22px; font-weight:800; font-family:'Poppins',sans-serif; outline:none; box-sizing:border-box; transition:border-color .2s;"
                    onfocus="this.style.borderColor='#ff1744'"
                    onblur="this.style.borderColor='rgba(255,23,68,0.25)'"
                    oninput="calcWalletResult()">
            </div>

            <!-- Past Bkash Balance -->
            <div class="card" style="margin-bottom:10px; background:linear-gradient(135deg,rgba(233,30,99,0.07),rgba(0,0,0,0)); border-color:rgba(233,30,99,0.2);">
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                    <div style="width:36px;height:36px;background:rgba(233,30,99,0.15);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;">üí≥</div>
                    <div>
                        <div style="font-size:12px; font-weight:700; color:#e91e63; text-transform:uppercase; letter-spacing:0.5px;">Past Bkash Balance</div>
                        <div style="font-size:11px; color:var(--text-muted);">‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂‡ßá ‡¶Ü‡¶ó‡ßá ‡¶ï‡¶§ ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶õ‡¶ø‡¶≤</div>
                    </div>
                </div>
                <input type="number" id="ws-past-bkash" placeholder="0" min="0" step="1"
                    style="width:100%; padding:13px 14px; background:var(--bg-input); border:2px solid rgba(233,30,99,0.25); border-radius:10px; color:#e91e63; font-size:22px; font-weight:800; font-family:'Poppins',sans-serif; outline:none; box-sizing:border-box; transition:border-color .2s;"
                    onfocus="this.style.borderColor='#e91e63'"
                    onblur="this.style.borderColor='rgba(233,30,99,0.25)'"
                    oninput="calcWalletResult()">
            </div>

            <!-- Past Nagad Balance -->
            <div class="card" style="margin-bottom:10px; background:linear-gradient(135deg,rgba(255,152,0,0.07),rgba(0,0,0,0)); border-color:rgba(255,152,0,0.2);">
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                    <div style="width:36px;height:36px;background:rgba(255,152,0,0.15);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;">üí∞</div>
                    <div>
                        <div style="font-size:12px; font-weight:700; color:#ff9800; text-transform:uppercase; letter-spacing:0.5px;">Past Nagad Balance</div>
                        <div style="font-size:11px; color:var(--text-muted);">‡¶®‡¶ó‡¶¶‡ßá ‡¶Ü‡¶ó‡ßá ‡¶ï‡¶§ ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶õ‡¶ø‡¶≤</div>
                    </div>
                </div>
                <input type="number" id="ws-past-nagad" placeholder="0" min="0" step="1"
                    style="width:100%; padding:13px 14px; background:var(--bg-input); border:2px solid rgba(255,152,0,0.25); border-radius:10px; color:#ff9800; font-size:22px; font-weight:800; font-family:'Poppins',sans-serif; outline:none; box-sizing:border-box; transition:border-color .2s;"
                    onfocus="this.style.borderColor='#ff9800'"
                    onblur="this.style.borderColor='rgba(255,152,0,0.25)'"
                    oninput="calcWalletResult()">
            </div>

            <!-- Result Box (Auto) -->
            <div class="card" id="ws-result-card" style="margin-bottom:14px; background:linear-gradient(135deg,rgba(255,69,0,0.12),rgba(0,0,0,0)); border-color:rgba(255,69,0,0.35); border-width:2px;">
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:12px;">
                    <div style="width:36px;height:36px;background:rgba(255,69,0,0.2);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;">üßÆ</div>
                    <div>
                        <div style="font-size:12px; font-weight:700; color:var(--primary); text-transform:uppercase; letter-spacing:0.5px;">‡¶´‡¶≤‡¶æ‡¶´‡¶≤ (Auto)</div>
                        <div style="font-size:11px; color:var(--text-muted);">Past Balance + Deposit - Withdraw</div>
                    </div>
                    <div style="margin-left:auto; background:rgba(255,69,0,0.2); padding:3px 8px; border-radius:6px; font-size:10px; color:var(--primary); font-weight:700;">‡¶Ö‡¶ü‡ßã</div>
                </div>
                <div id="ws-result-display"
                    style="padding:16px; background:rgba(255,69,0,0.08); border:2px dashed rgba(255,69,0,0.3); border-radius:12px; text-align:center;">
                    <div id="ws-result-value" style="font-size:32px; font-weight:900; color:var(--primary); font-family:'Poppins',sans-serif; line-height:1;">0‡ß≥</div>
                    <div id="ws-result-diff" style="font-size:12px; margin-top:6px; color:var(--text-muted);"></div>
                </div>
            </div>

            <!-- Divider -->
            <div style="height:1px; background:var(--border); margin:6px 0 14px;"></div>

            <!-- Total Earning (Automatic - Deposit Accepted - Withdraw Accepted) -->
            <div class="card" style="background:linear-gradient(135deg,rgba(156,39,176,0.12),rgba(0,0,0,0)); border-color:rgba(156,39,176,0.35); border-width:2px;">
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:12px;">
                    <div style="width:36px;height:36px;background:rgba(156,39,176,0.2);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;">üëë</div>
                    <div style="flex:1;">
                        <div style="font-size:12px; font-weight:700; color:#ce93d8; text-transform:uppercase; letter-spacing:0.5px;">Total Earning</div>
                        <div style="font-size:11px; color:var(--text-muted);">‡¶∏‡¶∞‡ßç‡¶¨‡¶Æ‡ßã‡¶ü ‡¶Ü‡¶Ø‡¶º ‚Äî ‡¶∏‡ßç‡¶¨‡¶Ø‡¶º‡¶Ç‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨</div>
                    </div>
                    <div style="background:rgba(156,39,176,0.2); padding:3px 8px; border-radius:6px; font-size:10px; color:#ce93d8; font-weight:700;">Auto</div>
                </div>

                <!-- Current Total Display -->
                <div style="padding:16px; background:rgba(156,39,176,0.08); border-radius:12px; text-align:center; margin-bottom:12px; position:relative;">
                    <div style="font-size:11px; color:var(--text-muted); margin-bottom:4px;">‡¶∏‡¶∞‡ßç‡¶¨‡¶Æ‡ßã‡¶ü ‡¶Ü‡¶Ø‡¶º</div>
                    <div id="ws-total-earning" style="font-size:36px; font-weight:900; color:#ce93d8; font-family:'Poppins',sans-serif; line-height:1;">0‡ß≥</div>
                    <div style="font-size:11px; color:var(--text-muted); margin-top:6px;">Deposit - Withdraw = Total Earning</div>
                    <!-- ‚úÖ Removed Edit & Reset buttons - Now automatic -->
                </div>

                <!-- Formula Display -->
                <div style="background:rgba(156,39,176,0.06); border:1px dashed rgba(156,39,176,0.35); border-radius:12px; padding:14px;">
                    <div style="font-size:11px; color:var(--text-muted); margin-bottom:8px; text-align:center;">üìä Calculation Formula</div>
                    <div style="display:flex; align-items:center; justify-content:space-around; gap:8px;">
                        <div style="text-align:center;">
                            <div style="font-size:10px; color:var(--text-muted);">Deposit</div>
                            <div id="ws-total-deposit-lifetime" style="font-size:16px; font-weight:800; color:#00e676;">0‡ß≥</div>
                        </div>
                        <div style="font-size:20px; color:var(--text-muted);">‚àí</div>
                        <div style="text-align:center;">
                            <div style="font-size:10px; color:var(--text-muted);">Withdraw</div>
                            <div id="ws-total-withdraw-lifetime" style="font-size:16px; font-weight:800; color:#ff1744;">0‡ß≥</div>
                        </div>
                        <div style="font-size:20px; color:var(--text-muted)">=</div>
                        <div style="text-align:center;">
                            <div style="font-size:10px; color:var(--text-muted);">Earning</div>
                            <div id="ws-earning-result" style="font-size:16px; font-weight:800; color:#ce93d8;">0‡ß≥</div>
                        </div>
                    </div>
                    <div style="font-size:10px; color:var(--text-muted); margin-top:8px; text-align:center;">‚úÖ ‡¶∏‡ßç‡¶¨‡¶Ø‡¶º‡¶Ç‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ ‚Äî ‡¶ï‡¶ñ‡¶®‡ßã ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶π‡¶¨‡ßá ‡¶®‡¶æ</div>
                </div>
            </div>

        </div>

        <!-- Earning Section -->
        <div id="sec-earning" class="section">
            <div style="margin-bottom:20px;">
                <div style="font-size:18px; font-weight:700; color:var(--text); margin-bottom:4px;">üíé Earning Analytics</div>
                <div style="font-size:12px; color:var(--text-muted);">Track your daily match earnings & profits</div>
            </div>
            
            <div style="margin-bottom:16px;">
                <label style="font-size:12px; color:var(--text-muted); display:block; margin-bottom:6px;">Select Date:</label>
                <input type="date" id="earningDateSelector" style="width:100%; padding:12px; background:var(--bg-card); border:1px solid var(--border); border-radius:8px; color:var(--text); font-size:14px;" onchange="loadEarningData()">
            </div>
            
            <div class="stats-grid">
                <div class="stat-card" style="background:linear-gradient(135deg, rgba(0,200,255,0.1), rgba(0,200,255,0.05));"><div class="stat-icon">üéÆ</div><div class="stat-val" id="totalEntryFee">0‡ß≥</div><div class="stat-lbl">Total Entry Fee</div></div>
                <div class="stat-card" style="background:linear-gradient(135deg, rgba(255,171,0,0.1), rgba(255,171,0,0.05));"><div class="stat-icon">üèÜ</div><div class="stat-val" id="totalWinningPrize">0‡ß≥</div><div class="stat-lbl">Winning Prize</div></div>
            </div>
            
            <div style="background:linear-gradient(135deg, rgba(0,230,118,0.15), rgba(0,230,118,0.05)); border:2px solid rgba(0,230,118,0.3); border-radius:14px; padding:20px; text-align:center; margin-top:16px;">
                <div style="font-size:12px; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; margin-bottom:8px;">üí∞ Net Earning (Profit)</div>
                <div id="netEarning" style="font-size:32px; font-weight:900; color:var(--success);">0‡ß≥</div>
                <div id="earningPercentage" style="font-size:11px; color:var(--text-muted); margin-top:4px;">-</div>
            </div>
            
            <div style="margin-top:20px;">
                <div style="font-size:13px; font-weight:700; color:var(--text); margin-bottom:12px;">üìà Detailed Breakdown</div>
                <div id="earningBreakdown" style="background:var(--bg-card); border:1px solid var(--border); border-radius:10px; padding:16px;">
                    <div style="text-align:center; color:var(--text-muted); padding:20px;">Select a date to view details</div>
                </div>
            </div>
        </div>

        <!-- Users -->
        <div id="sec-users" class="section">
            <div class="sec-header"><span class="sec-title">All Users</span><button class="btn-add" onclick="loadUsers()">üîÑ Refresh</button></div>
            <div id="usersList"></div>
        </div>

        <!-- Manual Deposit -->
        <div id="sec-manual-deposit" class="section">
            <div class="sec-header"><span class="sec-title">Manual Deposit</span><button class="btn-add" onclick="openSheet('sheetManualDeposit'); loadUsersForManualDeposit(); document.getElementById('manualTransactionType').value='add'; updateTransactionUI();">+ Add</button></div>
            <div id="manualDepositList"></div>
        </div>

        <!-- Deposit Requests -->
        <div id="sec-deposit-requests" class="section">
            <div class="sec-header">
                <span class="sec-title">Deposit Requests</span>
                <div style="display:flex; gap:8px;">
                    <button class="btn-add" onclick="toggleDepositFilter()" id="depositFilterBtn" style="background:#666;">üìã Show All</button>
                    <button class="btn-add" onclick="loadDepositRequests()">üîÑ Refresh</button>
                </div>
            </div>
            <div id="depositList"></div>
        </div>

        <!-- Withdraw Requests -->
        <div id="sec-withdraw-requests" class="section">
            <div class="sec-header">
                <span class="sec-title">Withdraw Requests</span>
                <div style="display:flex; gap:8px;">
                    <button class="btn-add" onclick="toggleWithdrawFilter()" id="withdrawFilterBtn" style="background:#666;">üìã Show All</button>
                    <button class="btn-add" onclick="loadWithdrawRequests()">üîÑ Refresh</button>
                </div>
            </div>
            <div id="withdrawList"></div>
        </div>

        <!-- Tournaments -->
        <div id="sec-tournaments" class="section">
            <div class="sec-header">
                <span class="sec-title">Tournaments</span>
                <button class="btn-add" onclick="openCreateTournament()">+ Create</button>
            </div>
            <div id="tournamentList"></div>
        </div>

        <!-- Result Submission -->
        <div id="sec-results" class="section">
            <div class="sec-header"><span class="sec-title">Result Submission</span><button class="btn-add" onclick="loadPendingMatches()">üîÑ Refresh</button></div>
            <div id="resultsList"><div class="empty"><div class="empty-icon">‚è≥</div><p>Loading pending matches...</p></div></div>
        </div>

        <!-- Winners -->
        <div id="sec-winners" class="section">
            <div class="sec-header">
                <span class="sec-title">Winner Board</span>
                <button class="btn-add" onclick="openManualWinnerEntry()">+ Manual Entry</button>
            </div>
            <div id="winnersList"><div class="empty"><div class="empty-icon">ü•á</div><p>No winners yet</p></div></div>
        </div>

        <!-- Noticeboard -->
        <div id="sec-noticeboard" class="section">
            <div class="sec-header"><span class="sec-title">Noticeboard</span><button class="btn-add" onclick="openSheet('sheetNotice')">+ Add Notice</button></div>
            <div id="currentNotice"><div class="empty"><div class="empty-icon">üì¢</div><p>No notices added</p></div></div>
        </div>

        <!-- Categories -->
        <div id="sec-categories" class="section">
            <div class="sec-header"><span class="sec-title">Categories</span><button class="btn-add" onclick="openSheet('sheetCategory')">+ Add</button></div>
            <div id="categoriesList"></div>
        </div>

        <!-- Rules -->
        <div id="sec-rules" class="section">
            <div class="sec-header"><span class="sec-title">Game Rules</span><button class="btn-add" onclick="openSheet('sheetRules')">‚úèÔ∏è Edit</button></div>
            <div id="currentRules"><div class="empty"><div class="empty-icon">üìã</div><p>No rules set</p></div></div>
        </div>

        <!-- Notifications -->
        <div id="sec-notifications" class="section">
            <div class="sec-header"><span class="sec-title">Notifications</span><button class="btn-add" onclick="openSheet('sheetNotification')">+ Send</button></div>
            <div id="notificationList"></div>

            <!-- BROADCAST MESSAGE -->
            <div style="margin-top:20px;">
                <div style="font-size:15px; font-weight:700; color:var(--text); margin-bottom:12px;">üì¢ Broadcast Message</div>
                <div class="card" style="background:linear-gradient(135deg,rgba(255,69,0,0.08),rgba(0,0,0,0)); border-color:rgba(255,69,0,0.25);">
                    <div style="font-size:12px; color:var(--text-muted); margin-bottom:10px;">‡¶∏‡¶¨ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ screen ‡¶è ‡¶è‡¶á message ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá</div>
                    <div class="form-group" style="margin-bottom:10px;">
                        <textarea id="broadcastMsg" placeholder="‡¶Ø‡ßá‡¶Æ‡¶®: ‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ match ‡¶∞‡¶æ‡¶§ ‡ßÆ‡¶ü‡¶æ‡¶Ø‡¶º ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶π‡¶¨‡ßá..." rows="3"
                            style="width:100%; padding:12px; background:var(--bg-input); border:2px solid rgba(255,69,0,0.2); border-radius:10px; color:var(--text); font-size:14px; font-family:'Poppins',sans-serif; resize:none; outline:none; box-sizing:border-box;"
                            onfocus="this.style.borderColor='var(--primary)'"
                            onblur="this.style.borderColor='rgba(255,69,0,0.2)'"></textarea>
                    </div>
                    <button onclick="sendBroadcast()"
                        style="width:100%; padding:12px; background:linear-gradient(135deg,var(--primary),var(--primary-dark)); border:none; border-radius:10px; color:#fff; font-size:14px; font-weight:700; cursor:pointer; font-family:'Poppins',sans-serif;">
                        üì¢ ‡¶∏‡¶¨ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶ï‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶®
                    </button>
                </div>

                <!-- Last broadcast preview -->
                <div id="lastBroadcastPreview" style="margin-top:10px; font-size:12px; color:var(--text-muted); text-align:center;"></div>
            </div>

            <!-- AUTO REFUND -->
            <div style="margin-top:20px;">
                <div style="font-size:15px; font-weight:700; color:var(--text); margin-bottom:12px;">üí∏ Auto Refund (Match Cancel)</div>
                <div class="card" style="background:linear-gradient(135deg,rgba(255,23,68,0.08),rgba(0,0,0,0)); border-color:rgba(255,23,68,0.2);">
                    <div style="font-size:12px; color:var(--text-muted); margin-bottom:12px;">Tournament ID ‡¶¶‡¶ø‡¶® ‚Äî ‡¶∏‡¶¨ participant ‡¶è‡¶∞ entry fee ‡¶´‡ßá‡¶∞‡¶§ ‡¶Ø‡¶æ‡¶¨‡ßá</div>
                    <div class="form-group" style="margin-bottom:10px;">
                        <input type="text" id="refundTournamentId" placeholder="Tournament ID ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..."
                            style="width:100%; padding:12px; background:var(--bg-input); border:2px solid rgba(255,23,68,0.2); border-radius:10px; color:var(--text); font-size:14px; font-family:'Poppins',sans-serif; outline:none; box-sizing:border-box;"
                            onfocus="this.style.borderColor='#ff1744'"
                            onblur="this.style.borderColor='rgba(255,23,68,0.2)'">
                    </div>
                    <button onclick="processAutoRefund()"
                        style="width:100%; padding:12px; background:linear-gradient(135deg,#ff1744,#c62828); border:none; border-radius:10px; color:#fff; font-size:14px; font-weight:700; cursor:pointer; font-family:'Poppins',sans-serif;">
                        üí∏ Refund ‡¶¶‡¶ø‡¶® ‡¶ì Match Cancel ‡¶ï‡¶∞‡ßÅ‡¶®
                    </button>
                    <div id="refundStatus" style="margin-top:10px; font-size:12px; color:var(--text-muted); text-align:center;"></div>
                </div>
            </div>
        </div>

        <!-- Tournament Guide -->
        <div id="sec-tournament-guide" class="section">
            <div class="sec-header">
                <span class="sec-title">üìö Tournament Guide</span>
                <button class="btn-add" onclick="openAddGuideModal()">+ Add Guide</button>
            </div>
            <div id="guideList">
                <div style="text-align:center; padding:40px; color:#999;">
                    <i class="fas fa-book" style="font-size:48px; margin-bottom:10px; opacity:0.3;"></i>
                    <p>No guides added yet. Click "Add Guide" to create one.</p>
                </div>
            </div>
        </div>

        <!-- Settings -->
        <div id="sec-settings" class="section">
            <div class="settings-card">
                <h3>Panel Names</h3>
                <div class="form-group"><label>User Panel Name</label><input type="text" id="userPanelName" placeholder="Elite Survivors League"></div>
                <div class="form-group"><label>Admin Panel Name</label><input type="text" id="adminPanelName" placeholder="ESL Admin"></div>
            </div>
            <div class="settings-card">
                <h3>Payment Numbers</h3>
                <div class="form-group"><label>Bkash Number</label><input type="tel" id="bkashNumber" placeholder="01XXXXXXXXX"></div>
                <div class="form-group"><label>Nagad Number</label><input type="tel" id="nagadNumber" placeholder="01XXXXXXXXX"></div>
            </div>
            <div class="settings-card">
                <h3>Limits</h3>
                <div class="form-grid">
                    <div class="form-group"><label>Min Deposit (‡ß≥)</label><input type="number" id="minDeposit" placeholder="50"></div>
                    <div class="form-group"><label>Min Withdraw (‡ß≥)</label><input type="number" id="minWithdraw" placeholder="100"></div>
                </div>
                <div class="form-group">
                    <label>üìÖ Daily Deposit Limit (‡ß≥)</label>
                    <input type="number" id="dailyDepositLimit" placeholder="‡¶Ø‡ßá‡¶Æ‡¶®: 5000 (0 = ‡¶ï‡ßã‡¶®‡ßã limit ‡¶®‡ßá‡¶á)">
                </div>
            </div>
            <div class="settings-card">
                <h3>Support & Social Links</h3>
                <div class="form-group">
                    <label>üìò Facebook</label>
                    <input type="url" id="supportFacebook" placeholder="https://facebook.com/yourpage">
                </div>
                <div class="form-group">
                    <label>üì± WhatsApp</label>
                    <input type="url" id="supportWhatsapp" placeholder="https://wa.me/8801XXXXXXXXX">
                </div>
                <div class="form-group">
                    <label>‚úàÔ∏è Telegram</label>
                    <input type="url" id="supportTelegram" placeholder="https://t.me/yourchannel">
                </div>
                <div class="form-group">
                    <label>‚ñ∂Ô∏è YouTube</label>
                    <input type="url" id="supportYoutube" placeholder="https://youtube.com/@yourchannel">
                </div>
                <div class="form-group">
                    <label>üìß Business Email</label>
                    <input type="email" id="supportGmail" placeholder="support@yourdomain.com">
                </div>
                
                <!-- Custom Website Links -->
                <div style="margin-top:20px; padding-top:15px; border-top:1px solid var(--border);">
                    <h4 style="font-size:14px; margin-bottom:12px; color:var(--text);">üîó Custom Website Links</h4>
                    <p style="font-size:12px; color:var(--text-muted); margin-bottom:15px;">Add any custom website links (e.g., diamond top-up, merchandise store, etc.)</p>
                    
                    <div class="form-group">
                        <label>üåê Custom Link 1</label>
                        <input type="url" id="customLink1" placeholder="https://your-website.com">
                    </div>
                    <div class="form-group">
                        <label>üåê Custom Link 2</label>
                        <input type="url" id="customLink2" placeholder="https://your-website.com">
                    </div>
                    <div class="form-group">
                        <label>üåê Custom Link 3</label>
                        <input type="url" id="customLink3" placeholder="https://your-website.com">
                    </div>
                </div>
            </div>
            <div class="settings-card">
                <h3>Welcome Banner</h3>
                <div class="form-group"><label>Welcome Message (Scrolling Text)</label><input type="text" id="welcomeMessage" placeholder="Welcome to Elite Survivors League! Play daily matches and earn rewards."></div>
            </div>
            <div class="settings-card">
                <h3>Security</h3>
                <div class="form-group"><label>New Admin Password</label><input type="password" id="newAdminPassword" placeholder="Leave blank to keep"></div>
            </div>
            <button class="btn-full btn-primary-full" onclick="saveSettings()">üíæ Save Settings</button>
        </div>

        <!-- History Section -->
        <div id="sec-history" class="section">
            <div style="margin-bottom:20px;">
                <div style="font-size:18px; font-weight:700; color:var(--text); margin-bottom:4px;">üìä History</div>
                <div style="font-size:12px; color:var(--text-muted);">Withdraw, Deposit ‡¶è‡¶¨‡¶Ç Winner ‡¶è‡¶∞ ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶°</div>
            </div>

            <!-- Dropdown Select Box -->
            <div style="margin-bottom:20px;">
                <select id="historyTypeSelect" onchange="loadHistoryByType()" style="width:100%; padding:12px 16px; background:var(--bg-card); border:2px solid var(--border); border-radius:12px; color:var(--text); font-size:14px; font-weight:600; font-family:'Poppins',sans-serif; cursor:pointer; outline:none;">
                    <option value="withdraw">üì§ Withdraw History</option>
                    <option value="deposit">üì• Deposit History</option>
                    <option value="winner">üèÜ Winner History</option>
                </select>
            </div>

            <!-- History Content Container -->
            <div id="historyContentContainer" style="max-height:calc(100vh - 280px); overflow-y:auto; -webkit-overflow-scrolling:touch;">
                <div class="empty"><div class="empty-icon">‚è≥</div><p>Loading...</p></div>
            </div>
        </div>

    </div>

    <!-- Bottom Nav -->
    <div class="bottom-nav">
        <button class="nav-item active" onclick="showSection('dashboard',this)"><span class="nav-icon">üè†</span><span class="nav-label">Home</span></button>
        <button class="nav-item" onclick="showSection('deposit-requests',this)"><span class="nav-icon">üí∞</span><span class="nav-label">Deposits</span></button>
        <button class="nav-item" onclick="showSection('withdraw-requests',this)"><span class="nav-icon">üí∏</span><span class="nav-label">Withdraw</span></button>
        <button class="nav-item" onclick="showSection('tournaments',this)"><span class="nav-icon">üèÜ</span><span class="nav-label">Matches</span></button>
        <button class="nav-item" onclick="toggleDrawer()"><span class="nav-icon">‚ò∞</span><span class="nav-label">More</span></button>
    </div>
</div>

<!-- ========== DRAWER ========== -->
<div class="drawer-overlay" id="drawerOverlay" onclick="closeDrawer()"></div>
<div class="drawer" id="drawer">
    <div class="drawer-header"><h2>üéÆ ESL ADMIN</h2><p id="drawerEmail">Admin Panel</p></div>
    <div class="drawer-section">
        <div class="drawer-section-label">Main</div>
        <div class="drawer-item" onclick="navigateFromDrawer('dashboard')"><span class="d-icon">üè†</span> Dashboard</div>
        <div class="drawer-item" onclick="navigateFromDrawer('users')"><span class="d-icon">üë•</span> Users</div>
    </div>
    <div class="drawer-section">
        <div class="drawer-section-label">Finance</div>
        <div class="drawer-item" onclick="navigateFromDrawer('wallet-summary')"><span class="d-icon">üíº</span> Wallet Summary</div>
        <div class="drawer-item" onclick="navigateFromDrawer('earning')"><span class="d-icon">üíé</span> Earning</div>
        <div class="drawer-item" onclick="navigateFromDrawer('manual-deposit')"><span class="d-icon">üíµ</span> Manual Deposit</div>
        <div class="drawer-item" onclick="navigateFromDrawer('deposit-requests')"><span class="d-icon">üí∞</span> Deposit Requests</div>
        <div class="drawer-item" onclick="navigateFromDrawer('withdraw-requests')"><span class="d-icon">üí∏</span> Withdraw Requests</div>
    </div>
    <div class="drawer-section">
        <div class="drawer-section-label">Content</div>
        <div class="drawer-item" onclick="navigateFromDrawer('noticeboard')"><span class="d-icon">üì¢</span> Noticeboard</div>
        <div class="drawer-item" onclick="navigateFromDrawer('categories')"><span class="d-icon">üìÅ</span> Categories</div>
        <div class="drawer-item" onclick="navigateFromDrawer('rules')"><span class="d-icon">üìã</span> Rules</div>
    </div>
    <div class="drawer-section">
        <div class="drawer-section-label">Tournaments</div>
        <div class="drawer-item" onclick="navigateFromDrawer('tournaments')"><span class="d-icon">üèÜ</span> Tournaments</div>
        <div class="drawer-item" onclick="navigateFromDrawer('results')"><span class="d-icon">üìù</span> Result Submission</div>
        <div class="drawer-item" onclick="navigateFromDrawer('winners')"><span class="d-icon">ü•á</span> Winners</div>
    </div>
    <div class="drawer-section">
        <div class="drawer-section-label">System</div>
        <div class="drawer-item" onclick="navigateFromDrawer('notifications')"><span class="d-icon">üîî</span> Notifications</div>
        <div class="drawer-item" onclick="navigateFromDrawer('tournament-guide')"><span class="d-icon">üìö</span> Tournament Guide</div>
        <div class="drawer-item" onclick="navigateFromDrawer('settings')"><span class="d-icon">‚öôÔ∏è</span> Settings</div>
        <div class="drawer-item" onclick="navigateFromDrawer('history')"><span class="d-icon">üìä</span> History</div>
    </div>
</div>

<!-- ========== BOTTOM SHEETS ========== -->

<!-- Tournament Sheet -->
<div class="sheet-overlay" id="overlayTournament" onclick="closeSheet('sheetTournament')"></div>
<div class="sheet" id="sheetTournament">
    <div class="sheet-handle"></div>
    <div class="sheet-header"><span class="sheet-title" id="tournamentSheetTitle">Create Tournament</span><button class="sheet-close" onclick="closeSheet('sheetTournament')">‚úï</button></div>
    <div class="sheet-body">
        <input type="hidden" id="editTournamentId">
        <div class="form-group"><label>Match Title</label><input type="text" id="matchTitle" placeholder="Sunday Squad Battle"></div>
        <div class="form-grid">
            <div class="form-group"><label>Category</label><select id="matchCategory"><option value="">Select</option></select></div>
            <div class="form-group">
                <label>Map</label>
                <select id="matchMap" style="width:100%; padding:12px; background:var(--bg-input); border:2px solid var(--border); border-radius:10px; color:var(--text); font-size:15px; font-family:'Poppins',sans-serif; outline:none;">
                    <option value="">Select Map</option>
                    <option value="Bermuda">Bermuda</option>
                    <option value="Kalahari">Kalahari</option>
                    <option value="Purgatory">Purgatory</option>
                    <option value="Erangel">Erangel</option>
                    <option value="Miramar">Miramar</option>
                    <option value="Sanhok">Sanhok</option>
                    <option value="Vikendi">Vikendi</option>
                </select>
            </div>
        </div>
        <div class="form-grid">
            <div class="form-group"><label>Game Type</label><select id="gameType"><option value="solo">Solo</option><option value="duo">Duo</option><option value="squad">Squad</option></select></div>
            <div class="form-group"><label>Date & Time</label><input type="datetime-local" id="matchDateTime"></div>
        </div>
        <div class="form-grid">
            <div class="form-group"><label>Entry Fee (‡ß≥)</label><input type="number" id="entryFee" placeholder="50"></div>
            <div class="form-group"><label>Prize Pool (‡ß≥)</label><input type="number" id="totalPrize" placeholder="1000"></div>
        </div>
        <div class="form-grid">
            <div class="form-group"><label>Per Kill (‡ß≥)</label><input type="number" id="perKill" placeholder="10"></div>
            <div class="form-group"><label>Slots</label><input type="number" id="slots" placeholder="100"></div>
        </div>
        <div class="form-grid">
            <div class="form-group"><label>Room ID</label><input type="text" id="roomId" placeholder="123456789"></div>
            <div class="form-group"><label>Room Pass</label><input type="text" id="roomPassword" placeholder="1234"></div>
        </div>
        <div style="font-size:12px; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px; margin-bottom:10px; font-weight:600;">Position Prizes (‡ß≥)</div>
        <div class="form-grid">
            <div class="form-group"><label>1st</label><input type="number" id="prize1st" placeholder="500"></div>
            <div class="form-group"><label>2nd</label><input type="number" id="prize2nd" placeholder="300"></div>
        </div>
        <div class="form-grid">
            <div class="form-group"><label>3rd</label><input type="number" id="prize3rd" placeholder="150"></div>
            <div class="form-group"><label>4th</label><input type="number" id="prize4th" placeholder="50"></div>
        </div>
        <div class="form-group"><label>5th Prize</label><input type="number" id="prize5th" placeholder="30"></div>
        <div class="form-group"><label>Match Rules</label><textarea id="matchRules" placeholder="Match specific rules..."></textarea></div>
    </div>
    <div class="sheet-footer">
        <button class="btn-full btn-secondary-full" onclick="closeSheet('sheetTournament')">Cancel</button>
        <button class="btn-full btn-primary-full" id="tournamentSaveBtn" onclick="saveTournament()">Create Match</button>
    </div>
</div>

<!-- Tournament Guide Modal -->
<div class="sheet-overlay" id="overlayGuide" onclick="closeSheet('sheetGuide')"></div>
<div class="sheet" id="sheetGuide">
    <div class="sheet-header">
        <h2 id="guideModalTitle">Add Tournament Guide</h2>
        <button class="sheet-close" onclick="closeSheet('sheetGuide')">‚úï</button>
    </div>
    <div class="sheet-body">
        <input type="hidden" id="editGuideId" value="">
        <div class="form-group">
            <label>Guide Title</label>
            <input type="text" id="guideTitle" placeholder="e.g., ‡¶ï‡¶ø‡¶≠‡¶æ‡¶¨‡ßá Add Money ‡¶ï‡¶∞‡¶¨‡ßá‡¶®">
        </div>
        <div class="form-group">
            <label>Guide Link (YouTube/Website)</label>
            <input type="url" id="guideLink" placeholder="https://youtube.com/watch?v=...">
        </div>
    </div>
    <div class="sheet-footer">
        <button class="btn-full btn-secondary-full" onclick="closeSheet('sheetGuide')">Cancel</button>
        <button class="btn-full btn-primary-full" onclick="saveGuide()">Save Guide</button>
    </div>
</div>

<!-- Manual Deposit Sheet -->
<div class="sheet-overlay" id="overlayManualDeposit" onclick="closeSheet('sheetManualDeposit')"></div>
<div class="sheet" id="sheetManualDeposit">
    <div class="sheet-handle"></div>
    <div class="sheet-header"><span class="sheet-title">Manual Transaction</span><button class="sheet-close" onclick="closeSheet('sheetManualDeposit')">‚úï</button></div>
    <div class="sheet-body">
        <div class="form-group">
            <label>Transaction Type</label>
            <select id="manualTransactionType" onchange="updateTransactionUI()">
                <option value="add">üí∞ Add Money (Deposit)</option>
                <option value="deduct">üí∏ Deduct Money (Withdraw)</option>
            </select>
        </div>
        
        <!-- Search Box -->
        <div class="form-group">
            <label>üîç Search User</label>
            <input type="text" id="manualDepositSearchBox" placeholder="Search by email or name..." 
                   oninput="searchUsersInSheet()" 
                   style="margin-bottom:10px;">
            <div id="searchResultsList" style="display:none; max-height:200px; overflow-y:auto; border:1px solid var(--border); border-radius:8px; background:var(--bg-card); margin-top:8px;">
                <!-- Search results will appear here -->
            </div>
        </div>
        
        <div class="form-group"><label>Select User</label><select id="manualDepositUser"><option value="">Select User</option></select></div>
        <div class="form-group">
            <label id="amountLabel">Amount to Add (‡ß≥)</label>
            <input type="number" id="manualDepositAmount" placeholder="Enter amount">
        </div>
    </div>
    <div class="sheet-footer">
        <button class="btn-full btn-secondary-full" onclick="closeSheet('sheetManualDeposit')">Cancel</button>
        <button class="btn-full btn-primary-full" id="manualDepositBtn" onclick="submitManualDeposit()">Add Money</button>
    </div>
</div>

<!-- Notice Sheet -->
<div class="sheet-overlay" id="overlayNotice" onclick="closeSheet('sheetNotice')"></div>
<div class="sheet" id="sheetNotice">
    <div class="sheet-handle"></div>
    <div class="sheet-header"><span class="sheet-title">Add Notice</span><button class="sheet-close" onclick="closeSheet('sheetNotice')">‚úï</button></div>
    <div class="sheet-body">
        <div class="form-group">
            <label>Notice Type</label>
            <select id="noticeType">
                <option value="important">‚ö†Ô∏è Important</option>
                <option value="info">‚ÑπÔ∏è Information</option>
                <option value="warning">üö® Warning</option>
                <option value="update">üîî Update</option>
                <option value="news">üì∞ News</option>
            </select>
        </div>
        <div class="form-group"><label>Notice Title</label><input type="text" id="noticeTitle" placeholder="‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶§‡ßç‡¶¨‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶ò‡ßã‡¶∑‡¶£‡¶æ"></div>
        <div class="form-group"><label>Notice Content</label><textarea id="noticeContent" placeholder="‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." rows="5"></textarea></div>
    </div>
    <div class="sheet-footer">
        <button class="btn-full btn-secondary-full" onclick="closeSheet('sheetNotice')">Cancel</button>
        <button class="btn-full btn-primary-full" onclick="saveNotice()">Add Notice</button>
    </div>
</div>

<!-- Category Sheet -->
<div class="sheet-overlay" id="overlayCategory" onclick="closeSheet('sheetCategory')"></div>
<div class="sheet" id="sheetCategory">
    <div class="sheet-handle"></div>
    <div class="sheet-header"><span class="sheet-title">Add Category</span><button class="sheet-close" onclick="closeSheet('sheetCategory')">‚úï</button></div>
    <div class="sheet-body">
        <div class="form-group"><label>Category Name</label><input type="text" id="categoryName" placeholder="PUBG Mobile"></div>
        <div class="form-group">
            <label>Emoji</label>
            <input type="text" id="categoryEmoji" placeholder="üéÆ" maxlength="4"
                style="font-size:32px; text-align:center; padding:12px; letter-spacing:4px;">
            <div style="font-size:11px; color:var(--text-muted); margin-top:6px;">‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶á‡¶Æ‡ßã‡¶ú‡¶ø ‡¶¨‡¶∏‡¶æ‡¶® ‚Äî ‡¶Ø‡ßá‡¶Æ‡¶® üéÆ üèÜ üî• üí• üëë</div>
        </div>
    </div>
    <div class="sheet-footer">
        <button class="btn-full btn-secondary-full" onclick="closeSheet('sheetCategory'); document.getElementById('categoryName').value=''; document.getElementById('categoryEmoji').value='';">Cancel</button>
        <button class="btn-full btn-primary-full" onclick="saveCategory()">Add Category</button>
    </div>
</div>

<!-- Rules Sheet -->
<div class="sheet-overlay" id="overlayRules" onclick="closeSheet('sheetRules')"></div>
<div class="sheet" id="sheetRules">
    <div class="sheet-handle"></div>
    <div class="sheet-header"><span class="sheet-title">Game Rules</span><button class="sheet-close" onclick="closeSheet('sheetRules')">‚úï</button></div>
    <div class="sheet-body">
        <div class="form-group"><label>Rules Content</label><textarea id="rulesContent" placeholder="Enter game rules..." style="min-height:200px;"></textarea></div>
    </div>
    <div class="sheet-footer">
        <button class="btn-full btn-secondary-full" onclick="closeSheet('sheetRules')">Cancel</button>
        <button class="btn-full btn-primary-full" onclick="saveRules()">Save Rules</button>
    </div>
</div>

<!-- Notification Sheet -->
<div class="sheet-overlay" id="overlayNotification" onclick="closeSheet('sheetNotification')"></div>
<div class="sheet" id="sheetNotification">
    <div class="sheet-handle"></div>
    <div class="sheet-header"><span class="sheet-title">Send Notification</span><button class="sheet-close" onclick="closeSheet('sheetNotification')">‚úï</button></div>
    <div class="sheet-body">
        <div class="form-group"><label>Title</label><input type="text" id="notificationTitle" placeholder="Important Update"></div>
        <div class="form-group"><label>Message</label><textarea id="notificationMessage" placeholder="Notification message..."></textarea></div>
        <div class="form-group"><label>Send To</label><select id="notificationTarget"><option value="all">All Users</option><option value="active">Active Users Only</option></select></div>
    </div>
    <div class="sheet-footer">
        <button class="btn-full btn-secondary-full" onclick="closeSheet('sheetNotification')">Cancel</button>
        <button class="btn-full btn-primary-full" onclick="sendNotification()">Send</button>
    </div>
</div>

<!-- ========== DISTRIBUTE PRIZES MODAL (‡¶õ‡¶¨‡¶ø‡¶∞ ‡¶Æ‡¶§‡¶®) ========== -->
<div class="modal-overlay" id="distributePrizesModal">
    <div class="modal-box">
        <div class="modal-header">
            <span class="modal-title">Distribute Prizes</span>
            <button class="modal-close-btn" onclick="closeDistributeModal()">‚úï</button>
        </div>
        <div class="modal-divider"></div>
        <div class="modal-body">
            <table class="prize-table" id="prizeTable">
                <thead>
                    <tr>
                        <th>USER</th>
                        <th>UID</th>
                        <th>KILLS</th>
                        <th>WIN PRIZE</th>
                    </tr>
                </thead>
                <tbody id="prizeTableBody"></tbody>
            </table>
        </div>
        <div class="modal-footer">
            <button class="btn-distribute" onclick="submitDistributePrizes()">
                <span>‚úì</span> Submit &amp; Distribute
            </button>
        </div>
    </div>
</div>

<!-- ========== EDIT WINNER SHEET ========== -->
<div class="sheet-overlay" id="overlayEditWinner" onclick="closeSheet('sheetEditWinner')"></div>
<div class="sheet" id="sheetEditWinner">
    <div class="sheet-handle"></div>
    <div class="sheet-header"><span class="sheet-title">Edit Winner Entry</span><button class="sheet-close" onclick="closeSheet('sheetEditWinner')">‚úï</button></div>
    <div class="sheet-body">
        <input type="hidden" id="editWinnerTournamentId">
        
        <div class="form-group">
            <label>Match Title</label>
            <input type="text" id="editMatchTitle" placeholder="Match name">
        </div>
        
        <div class="form-group">
            <label>Match Type</label>
            <input type="text" id="editMatchType" placeholder="PUBG Mobile">
        </div>
        
        <div class="form-grid">
            <div class="form-group">
                <label>Win Prize (‡ß≥)</label>
                <input type="number" id="editWinPrize" placeholder="800">
            </div>
            <div class="form-group">
                <label>Per Kill (‡ß≥)</label>
                <input type="number" id="editPerKill" placeholder="0">
            </div>
        </div>
        
        <div class="form-group">
            <label>Entry Fee (‡ß≥)</label>
            <input type="number" id="editEntryFee" placeholder="20">
        </div>
        
        <div class="form-group">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <label style="margin:0;">Winners List</label>
                <button class="btn-add" style="padding:6px 12px; font-size:11px;" onclick="addWinnerRowInEdit()">+ Add Winner</button>
            </div>
            <div id="editWinnersList"></div>
        </div>
    </div>
    <div class="sheet-footer">
        <button class="btn-full btn-secondary-full" onclick="closeSheet('sheetEditWinner')">Cancel</button>
        <button class="btn-full btn-primary-full" onclick="saveEditedWinnerEntry()">üíæ Save Changes</button>
    </div>
</div>

<!-- Withdraw Approval Modal -->
<div class="modal-overlay" id="withdrawApprovalModal" style="display:none; z-index:9999;">
    <div class="modal-box" style="max-width:500px; padding:0;">
        <div style="background:linear-gradient(135deg,#4CAF50,#45a049); padding:20px; color:#fff; border-radius:16px 16px 0 0;">
            <h3 style="margin:0; font-size:18px; font-weight:800;">‚úÖ Approve Withdraw Request</h3>
        </div>
        <div style="padding:24px;">
            <div id="withdrawApprovalDetails" style="background:#f5f5f5; padding:16px; border-radius:12px; margin-bottom:20px;">
                <!-- Details will be inserted here -->
            </div>
            
            <div style="display:flex; gap:12px; margin-top:24px;">
                <button class="btn-cancel" onclick="closeWithdrawApprovalModal()" style="flex:1;">Cancel</button>
                <button class="btn-login" onclick="confirmWithdrawApproval()" style="flex:1;">‚úÖ Approve & Send</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast -->
<div id="toast">‚úì Done!</div>

<script>
    const firebaseConfig = {
  apiKey: "AIzaSyD2BItwAJ42bXneXPJdy3ArPcWy5rS-2Jc",
  authDomain: "elite-survivors-league-d5c7f.firebaseapp.com",
  databaseURL: "https://elite-survivors-league-d5c7f-default-rtdb.firebaseio.com",
  projectId: "elite-survivors-league-d5c7f",
  storageBucket: "elite-survivors-league-d5c7f.firebasestorage.app",
  messagingSenderId: "344874027569",
  appId: "1:344874027569:web:9a9b8055fce7787e6e6310",
  measurementId: "G-CQFW5N0C6K"
};
    let db = null;
    try {
        const app = firebase.apps.length ? firebase.app() : firebase.initializeApp(firebaseConfig);
        db = firebase.database(app);
        console.log('‚úÖ Firebase ready');
    } catch(e) {
        console.error('Firebase init error:', e.message);
    }

    // ===== ADMIN COOLDOWN SYSTEM (30 seconds) =====
    let lastResultSubmitTime = 0;
    let lastManualDepositTime = 0;
    let lastApproveTime = 0;
    const ADMIN_COOLDOWN = 30000; // 30 seconds
    
    function canAdminMakeRequest(type) {
        const now = Date.now();
        if (type === 'result') {
            if (now - lastResultSubmitTime < ADMIN_COOLDOWN) return false;
            lastResultSubmitTime = now;
            return true;
        } else if (type === 'manual-deposit') {
            if (now - lastManualDepositTime < ADMIN_COOLDOWN) return false;
            lastManualDepositTime = now;
            return true;
        } else if (type === 'approve') {
            if (now - lastApproveTime < ADMIN_COOLDOWN) return false;
            lastApproveTime = now;
            return true;
        }
        return true;
    }

    let currentUser = null;
    const DEFAULT_PASS = '12345';

    // ========= ‡¶Ü‡¶™‡¶æ‡¶§‡¶§ Distribute Prize ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø current match =========
    let currentDistributeMatch = null;

    // ==================== PERFORMANCE OPTIMIZATION ====================
    // Cache System - Reduce Database Calls
    const cache = {
        data: {},
        timestamps: {},
        duration: 30000 // 30 seconds cache for admin (shorter than user panel)
    };

    function getCached(key) {
        const now = Date.now();
        if (cache.data[key] && (now - cache.timestamps[key]) < cache.duration) {
            return cache.data[key];
        }
        return null;
    }

    function setCache(key, value) {
        cache.data[key] = value;
        cache.timestamps[key] = Date.now();
    }

    function clearCache(key = null) {
        if (key) {
            delete cache.data[key];
            delete cache.timestamps[key];
        } else {
            cache.data = {};
            cache.timestamps = {};
        }
    }

    // Performance Metrics
    const performanceMetrics = {
        apiCalls: 0
    };

    function trackAPICall(endpoint) {
        performanceMetrics.apiCalls++;
    }
    // ==================== END OPTIMIZATION ====================

    // ======= LOGIN =======
    async function doLogin() {
        const pass = document.getElementById('loginPassword').value.trim();
        if (!pass) { showToast('‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶¶‡¶ø‡¶®', 'error'); return; }
        const btn = document.querySelector('.btn-login');
        btn.textContent = '‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶õ‡¶ø...'; btn.disabled = true;
        try {
            const snap = await db.ref('adminPassword').once('value');
            const savedPass = snap.val() || DEFAULT_PASS;
            if (pass === savedPass) {
                sessionStorage.setItem('eslAdmin', 'true');
                showAdminPanel();
            } else {
                showToast('‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶≠‡ßÅ‡¶≤!', 'error');
                document.getElementById('loginPassword').value = '';
                document.getElementById('loginPassword').focus();
            }
        } catch(e) {
            if (pass === DEFAULT_PASS) { sessionStorage.setItem('eslAdmin', 'true'); showAdminPanel(); }
            else showToast('‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶≠‡ßÅ‡¶≤!', 'error');
        } finally { btn.textContent = '‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®'; btn.disabled = false; }
    }

    function showAdminPanel() {
        currentUser = { email: 'Admin' };
        document.getElementById('loginPage').style.display = 'none';
        const panel = document.getElementById('adminPanel');
        panel.style.display = 'flex';
        panel.classList.add('show');
        document.getElementById('adminEmail').textContent = 'üõ° Admin';
        document.getElementById('drawerEmail').textContent = 'Admin Panel';
        loadDashboardData();
        initWalletSummary();
        loadAnalytics();
    }

    function doLogout() {
        sessionStorage.removeItem('eslAdmin');
        document.getElementById('loginPage').style.display = 'flex';
        const panel = document.getElementById('adminPanel');
        panel.style.display = 'none';
        panel.classList.remove('show');
        document.getElementById('loginPassword').value = '12345';
    }

    window.addEventListener('load', () => {
        if (sessionStorage.getItem('eslAdmin') === 'true') showAdminPanel();
    });

    // ======= NAVIGATION =======
    const sectionTitles = {
        'dashboard':'Dashboard','earning':'Earning','users':'Users','manual-deposit':'Manual Deposit',
        'deposit-requests':'Deposit Requests','withdraw-requests':'Withdraw Requests',
        'noticeboard':'Noticeboard','categories':'Categories','rules':'Rules',
        'tournaments':'Tournaments','results':'Result Submission','winners':'Winner Board',
        'notifications':'Notifications','refer':'Referrals','tournament-guide':'Tournament Guide',
        'settings':'Settings','history':'History','wallet-summary':'Wallet Summary'
    };

    function showSection(id, navBtn) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        const sec = document.getElementById('sec-' + id);
        if (sec) sec.classList.add('active');
        document.getElementById('headerPage').textContent = sectionTitles[id] || id;
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        if (navBtn) navBtn.classList.add('active');
        document.getElementById('appBody').scrollTop = 0;
        if (id === 'dashboard') loadDashboardData();
        if (id === 'earning') initEarningSection();
        if (id === 'users') loadUsers();
        if (id === 'manual-deposit') loadManualDeposits();
        if (id === 'deposit-requests') loadDepositRequests();
        if (id === 'withdraw-requests') loadWithdrawRequests();
        if (id === 'tournaments') loadTournaments();
        if (id === 'results') loadPendingMatches();
        if (id === 'winners') loadWinnerBoard();
        if (id === 'noticeboard') loadNotice();
        if (id === 'categories') loadCategories();
        if (id === 'rules') loadRules();
        if (id === 'notifications') loadNotifications();
        if (id === 'refer') loadReferralRequests();
        if (id === 'tournament-guide') loadGuides();
        if (id === 'settings') loadSettings();
        if (id === 'history') loadHistoryByType();
    }

    function toggleDrawer() { document.getElementById('drawer').classList.toggle('open'); document.getElementById('drawerOverlay').classList.toggle('open'); }
    function closeDrawer() { document.getElementById('drawer').classList.remove('open'); document.getElementById('drawerOverlay').classList.remove('open'); }

    // Helper function for smooth drawer navigation
    function navigateFromDrawer(sectionId) {
        closeDrawer();
        setTimeout(function() {
            showSection(sectionId);
        }, 150);
    }

    function openSheet(id) {
        const sheetId = id.replace('sheet','');
        document.getElementById('overlay' + sheetId).classList.add('open');
        document.getElementById(id).classList.add('open');
        document.body.style.overflow = 'hidden';
        
        // Auto-load ALL saved data when opening tournament sheet
        if (id === 'sheetTournament') {
            // Load all saved tournament data from last match
            const savedData = {
                matchRules: localStorage.getItem('lastMatchRules'),
                entryFee: localStorage.getItem('lastEntryFee'),
                totalPrize: localStorage.getItem('lastTotalPrize'),
                perKill: localStorage.getItem('lastPerKill'),
                slots: localStorage.getItem('lastSlots'),
                prize1st: localStorage.getItem('lastPrize1st'),
                prize2nd: localStorage.getItem('lastPrize2nd'),
                prize3rd: localStorage.getItem('lastPrize3rd'),
                prize4th: localStorage.getItem('lastPrize4th'),
                prize5th: localStorage.getItem('lastPrize5th'),
                matchMap: localStorage.getItem('lastMatchMap'),
                gameType: localStorage.getItem('lastGameType')
            };
            
            // Fill all fields if data exists
            if (savedData.matchRules) document.getElementById('matchRules').value = savedData.matchRules;
            if (savedData.entryFee) document.getElementById('entryFee').value = savedData.entryFee;
            if (savedData.totalPrize) document.getElementById('totalPrize').value = savedData.totalPrize;
            if (savedData.perKill) document.getElementById('perKill').value = savedData.perKill;
            if (savedData.slots) document.getElementById('slots').value = savedData.slots;
            if (savedData.prize1st) document.getElementById('prize1st').value = savedData.prize1st;
            if (savedData.prize2nd) document.getElementById('prize2nd').value = savedData.prize2nd;
            if (savedData.prize3rd) document.getElementById('prize3rd').value = savedData.prize3rd;
            if (savedData.prize4th) document.getElementById('prize4th').value = savedData.prize4th;
            if (savedData.prize5th) document.getElementById('prize5th').value = savedData.prize5th;
            if (savedData.matchMap) document.getElementById('matchMap').value = savedData.matchMap;
            if (savedData.gameType) document.getElementById('gameType').value = savedData.gameType;
        }
    }
    function closeSheet(id) {
        const sheetId = id.replace('sheet','');
        document.getElementById('overlay' + sheetId).classList.remove('open');
        document.getElementById(id).classList.remove('open');
        document.body.style.overflow = '';
    }

    function showToast(msg, type = 'success') {
        const t = document.getElementById('toast');
        t.textContent = (type === 'success' ? '‚úì ' : '‚úï ') + msg;
        t.className = 'show ' + type;
        clearTimeout(window._toastTimer);
        window._toastTimer = setTimeout(() => t.className = '', 3000);
    }

    function emptyState(icon, text) { return `<div class="empty"><div class="empty-icon">${icon}</div><p>${text}</p></div>`; }

    // ======= DASHBOARD =======
    async function loadDashboardData() {
        if (!db) return;
        try {
            const usersSnap = await db.ref('users').once('value');
            const allUsers = usersSnap.val() || {};
            
            // ‚úÖ Count only registered users (those with email)
            const registeredUsersCount = Object.keys(allUsers).filter(uid => {
                const u = allUsers[uid];
                return u.email && u.email.trim() !== '';
            }).length;
            
            document.getElementById('totalUsers').textContent = registeredUsersCount;
            const depSnap = await db.ref('depositRequests').orderByChild('status').equalTo('pending').once('value');
            document.getElementById('pendingDeposits').textContent = Object.keys(depSnap.val() || {}).length;
            const matchSnap = await db.ref('tournaments').orderByChild('status').equalTo('active').once('value');
            document.getElementById('activeMatches').textContent = Object.keys(matchSnap.val() || {}).length;
            const withSnap = await db.ref('withdrawRequests').orderByChild('status').equalTo('pending').once('value');
            document.getElementById('pendingWithdraw').textContent = Object.keys(withSnap.val() || {}).length;
            
            // Calculate Prize Pending (matches where result is not yet declared)
            const allMatchesSnap = await db.ref('tournaments').once('value');
            const allMatches = allMatchesSnap.val() || {};
            let prizePendingCount = 0;
            
            for (let tid in allMatches) {
                const match = allMatches[tid];
                // Check if result has not been declared yet
                if (!match.resultDeclared) {
                    prizePendingCount++;
                }
            }
            document.getElementById('prizePending').textContent = prizePendingCount;
            
            // Calculate Prize Mismatches
            const winnersSnap = await db.ref('winners').once('value');
            const winners = winnersSnap.val() || {};
            const winnerBoardSnap = await db.ref('winnerBoard').once('value');
            const winnerBoard = winnerBoardSnap.val() || {};
            let mismatchCount = 0;
            const mismatchDetails = [];
            
            // Check old winners collection
            for (let wid in winners) {
                const winner = winners[wid];
                const tournamentId = winner.tournamentId;
                
                if (tournamentId && allMatches[tournamentId]) {
                    const match = allMatches[tournamentId];
                    const expectedPrize = getExpectedPrize(match, winner.position);
                    const actualPrize = winner.prize || 0;
                    
                    if (expectedPrize !== actualPrize) {
                        mismatchCount++;
                        mismatchDetails.push({
                            winnerId: wid,
                            matchName: match.title || 'Unknown Match',
                            userName: winner.userName || 'Unknown',
                            userEmail: winner.userEmail || winner.userId || 'N/A',
                            position: winner.position || 'N/A',
                            expected: expectedPrize,
                            actual: actualPrize,
                            difference: actualPrize - expectedPrize
                        });
                    }
                }
            }
            
            // Check winnerBoard (from Result Submission)
            for (let tid in winnerBoard) {
                const board = winnerBoard[tid];
                const match = allMatches[tid];
                
                if (!match) continue;
                
                const winnersList = board.winners || [];
                
                winnersList.forEach((w, index) => {
                    // Determine position based on rank (sorted by prize)
                    const position = index + 1; // 1st, 2nd, 3rd, etc.
                    const actualPrize = w.winPrize || 0; // Just the position prize, not including kills
                    const expectedPrize = getExpectedPrize(match, position);
                    
                    if (expectedPrize > 0 && actualPrize !== expectedPrize) {
                        mismatchCount++;
                        mismatchDetails.push({
                            winnerId: `wb_${tid}_${index}`,
                            matchName: match.title || 'Unknown Match',
                            userName: w.leaderEmail || w.teamMembers?.[0]?.name || 'Unknown',
                            userEmail: w.leaderEmail || 'N/A',
                            position: `${position}${getPositionSuffix(position)} Place`,
                            expected: expectedPrize,
                            actual: actualPrize,
                            difference: actualPrize - expectedPrize
                        });
                    }
                });
            }
            
            document.getElementById('prizeMismatch').textContent = mismatchCount;
            
            // Store mismatch details globally for later use
            window.prizeMismatchData = mismatchDetails;
            
            // Load analytics data
            loadAnalytics();
        } catch(e) { console.error(e); }
    }
    
    // Helper function to get expected prize based on position
    function getExpectedPrize(match, position) {
        const pos = position ? position.toString().toLowerCase() : '';
        if (pos.includes('1st') || pos === '1') return parseInt(match.prize1st) || 0;
        if (pos.includes('2nd') || pos === '2') return parseInt(match.prize2nd) || 0;
        if (pos.includes('3rd') || pos === '3') return parseInt(match.prize3rd) || 0;
        if (pos.includes('4th') || pos === '4') return parseInt(match.prize4th) || 0;
        if (pos.includes('5th') || pos === '5') return parseInt(match.prize5th) || 0;
        return 0;
    }
    
    // Helper function to get position suffix (1st, 2nd, 3rd, etc.)
    function getPositionSuffix(pos) {
        if (pos === 1) return 'st';
        if (pos === 2) return 'nd';
        if (pos === 3) return 'rd';
        return 'th';
    }
    
    // Show matches with prize pending
    function showPrizePendingMatches() {
        showSection('results');
        showToast('üìã Showing matches with pending prizes');
    }
    
    // Show prize mismatch details
    async function showPrizeMismatches() {
        const mismatches = window.prizeMismatchData || [];
        
        if (mismatches.length === 0) {
            showToast('‚úÖ No prize mismatches found!');
            return;
        }
        
        let html = `<div style="padding:20px; background:var(--bg-card); border-radius:15px; margin:20px;">
            <h3 style="color:var(--danger); margin-bottom:20px; font-size:18px;">‚ö†Ô∏è Prize Mismatch Alert</h3>
            <div style="font-size:13px; color:var(--text-muted); margin-bottom:20px;">
                Found ${mismatches.length} winner(s) with incorrect prize amounts. Please review and fix:
            </div>`;
        
        mismatches.forEach(m => {
            const isOverpaid = m.difference > 0;
            const colorClass = isOverpaid ? 'var(--danger)' : 'var(--warning)';
            html += `<div class="card" style="border-color:${colorClass}; margin-bottom:15px;">
                <div class="card-row"><span class="card-title" style="font-size:15px">üéÆ ${m.matchName}</span></div>
                <div class="card-row"><span class="card-label">Winner</span><span class="card-value">${m.userName}</span></div>
                <div class="card-row"><span class="card-label">Email</span><span class="card-value" style="font-size:12px">${m.userEmail}</span></div>
                <div class="card-row"><span class="card-label">Position</span><span class="card-value">${m.position}</span></div>
                <div class="card-row"><span class="card-label">Expected Prize</span><span class="card-value">‡ß≥${m.expected}</span></div>
                <div class="card-row"><span class="card-label">Actual Prize</span><span class="card-value" style="color:${colorClass}">‡ß≥${m.actual}</span></div>
                <div class="card-row"><span class="card-label">Difference</span><span class="card-value" style="color:${colorClass}; font-weight:700;">${isOverpaid ? '+' : ''}‡ß≥${m.difference}</span></div>
                <div style="margin-top:10px; padding:10px; background:rgba(255,152,0,0.1); border-radius:8px; font-size:12px; color:var(--text-muted);">
                    ${isOverpaid ? '‚ö†Ô∏è Overpaid - User received more than expected' : '‚ö†Ô∏è Underpaid - User received less than expected'}
                </div>
            </div>`;
        });
        
        html += `</div>`;
        
        // Create a modal to show this
        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:10000; overflow-y:auto; padding:20px;';
        modal.innerHTML = html + `<button onclick="this.parentElement.remove()" style="position:fixed; top:20px; right:20px; padding:10px 20px; background:var(--danger); color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:700;">‚úï Close</button>`;
        document.body.appendChild(modal);
    }

    // ======= USERS =======
    async function loadUsers() {
        const el = document.getElementById('usersList');
        el.innerHTML = emptyState('‚è≥','Loading...');
        try {
            const snap = await db.ref('users').once('value');
            const users = snap.val() || {};
            
            // ‚úÖ Filter: Only show users who have email (properly registered users)
            const registeredUsers = Object.keys(users).filter(uid => {
                const u = users[uid];
                // Must have email to be a registered user
                return u.email && u.email.trim() !== '';
            });
            
            if (!registeredUsers.length) { el.innerHTML = emptyState('üë•','No registered users found'); return; }
            el.innerHTML = registeredUsers.map(uid => {
                const u = users[uid];
                const userName = u.username || u.displayName || u.name || u.email || 'Unknown';
                const isBanned = u.banned === true;
                return `<div class="card" style="${isBanned ? 'border-color:rgba(255,23,68,0.4); background:rgba(255,23,68,0.05);' : ''}">
                    <div class="card-row" style="margin-bottom:8px;">
                        <span class="card-title" style="font-size:15px;">üë§ ${userName}</span>
                        ${isBanned ? '<span class="badge badge-rejected">üö´ Banned</span>' : '<span class="badge badge-approved">‚úÖ Active</span>'}
                    </div>
                    <div class="card-row"><span class="card-label">Email</span><span class="card-value" style="font-size:12px">${u.email||'N/A'}</span></div>
                    <div class="card-row"><span class="card-label">Phone</span><span class="card-value">${u.phone||'N/A'}</span></div>
                    <div class="card-row"><span class="card-label">Deposit Bal.</span><span class="card-value">‡ß≥${u.deposit||0}</span></div>
                    <div class="card-row"><span class="card-label">Win Bal.</span><span class="card-value" style="color:var(--success)">‡ß≥${u.winning||0}</span></div>
                    <div class="card-row"><span class="card-label">Refer Bal.</span><span class="card-value">‡ß≥${u.referBalance||0}</span></div>
                    <div class="card-actions" style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
                        ${isBanned
                            ? `<button class="btn-sm btn-approve" onclick="unbanUser('${uid}', '${userName.replace(/'/g, "\\'")}')" style="flex:1; min-width:80px;">‚úÖ Unban</button>`
                            : `<button class="btn-sm btn-reject" onclick="showBanUserModal('${uid}', '${userName.replace(/'/g, "\\'")}')" style="flex:1; min-width:80px;">üö´ Ban</button>
                               <button class="btn-sm" style="background:#ff9800; color:#fff; flex:1; min-width:80px;" onclick="showSuspendUserModal('${uid}', '${userName.replace(/'/g, "\\'")}')">‚è∏Ô∏è Suspend</button>`
                        }
                        <button class="btn-sm" style="background:var(--success); color:#fff; flex:1; min-width:100px;" onclick="showBalanceAdjustmentModal('${uid}', '${u.name||'User'}')">üí∞ Adjust Balance</button>
                        <button class="btn-sm" style="background:#1a73e8; color:#fff; flex:1; min-width:80px;" onclick="sendWinnerNotification('${uid}', '${u.name||'User'}', 0, 'custom')">üì® Message</button>
                    </div>
                </div>`;
            }).join('');
        } catch(e) { el.innerHTML = emptyState('‚ùå','Error loading'); }
    }

    async function toggleBanUser(uid, ban, name) {
        const action = ban ? 'Ban' : 'Unban';
        if (!confirm(`${name} ‡¶ï‡ßá ${action} ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?`)) return;
        try {
            await db.ref(`users/${uid}`).update({ banned: ban, bannedAt: ban ? Date.now() : null });
            showToast(`‚úÖ ${name} ${action} ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!`);
            loadUsers();
        } catch(e) { showToast('Error: ' + e.message, 'error'); }
    }

    // ======= DEPOSIT =======
    let showAllDeposits = false;
    
    function toggleDepositFilter() {
        showAllDeposits = !showAllDeposits;
        const btn = document.getElementById('depositFilterBtn');
        if (showAllDeposits) {
            btn.textContent = '‚è≥ Show Pending Only';
            btn.style.background = '#ff9800';
        } else {
            btn.textContent = 'üìã Show All';
            btn.style.background = '#666';
        }
        loadDepositRequests();
    }
    
    async function loadDepositRequests() {
        const el = document.getElementById('depositList');
        el.innerHTML = emptyState('‚è≥','Loading...');
        try {
            const snap = await db.ref('depositRequests').once('value');
            const reqs = snap.val() || {};
            
            let filteredReqs = {};
            
            if (showAllDeposits) {
                // Show all requests
                filteredReqs = reqs;
            } else {
                // Filter: ‡¶∂‡ßÅ‡¶ß‡ßÅ pending requests ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá
                Object.keys(reqs).forEach(rid => {
                    if (reqs[rid].status === 'pending') {
                        filteredReqs[rid] = reqs[rid];
                    }
                });
            }
            
            if (!Object.keys(filteredReqs).length) { 
                el.innerHTML = emptyState('‚¨áÔ∏è', showAllDeposits ? 'No deposit requests' : 'No pending deposit requests'); 
                return; 
            }
            
            // Sort by newest first
            const sortedKeys = Object.keys(filteredReqs).sort((a, b) => {
                const timeA = filteredReqs[a].timestamp || filteredReqs[a].date || 0;
                const timeB = filteredReqs[b].timestamp || filteredReqs[b].date || 0;
                return timeB - timeA;
            });
            
            el.innerHTML = sortedKeys.map(rid => {
                const r = filteredReqs[rid];
                const bc = r.status==='pending'?'badge-pending':r.status==='approved'?'badge-approved':'badge-rejected';
                return `<div class="card">
                    <div class="card-row"><span class="card-title" style="font-size:15px">üí∞ ${r.userName||'N/A'}</span><span class="badge ${bc}">${r.status||'pending'}</span></div>
                    <div class="card-row"><span class="card-label">Amount</span><span class="card-value" style="color:var(--success);font-size:18px">‡ß≥${r.amount||0}</span></div>
                    <div class="card-row"><span class="card-label">Method</span><span class="card-value">${r.method||'N/A'}</span></div>
                    <div class="card-row"><span class="card-label">Trx ID</span><span class="card-value" style="font-size:12px">${r.transactionId||'N/A'}</span></div>
                    <div class="card-row"><span class="card-label">Sender</span><span class="card-value" style="font-size:12px">${r.senderNumber||'N/A'}</span></div>
                    ${r.status==='pending'?`<div class="card-actions">
                        <button class="btn-sm btn-approve" onclick="approveDeposit('${rid}','${r.userId}',${r.amount})">‚úì Approve</button>
                        <button class="btn-sm btn-reject" onclick="rejectDeposit('${rid}')">‚úï Reject</button>
                    </div>`:''}
                </div>`;
            }).join('');
        } catch(e) { el.innerHTML = emptyState('‚ùå','Error'); }
    }

        async function approveDeposit(rid, uid, amount) {
        if (!canAdminMakeRequest('approve')) {
            console.log('Approve ignored - cooldown');
            return;
        }
        
        if (!confirm('Approve this deposit?')) return;
        try {
            // Parallel fetch - faster!
            const [reqSnap, uSnap] = await Promise.all([
                db.ref(`depositRequests/${rid}`).once('value'),
                db.ref(`users/${uid}`).once('value')
            ]);
            
            const reqData = reqSnap.val();
            const u = uSnap.val() || {};
            
            // Batch update - faster!
            const updates = {};
            updates[`depositRequests/${rid}/status`] = 'approved';
            updates[`depositRequests/${rid}/approvedDate`] = Date.now();
            updates[`depositRequests/${rid}/processedAt`] = Date.now();
            updates[`users/${uid}/deposit`] = (u.deposit||0)+amount;
            await db.ref().update(updates);
            
            // Update transaction history
            const transactionsSnap = await db.ref(`transactions/${uid}`).once('value');
            const transactions = transactionsSnap.val() || {};
            
            for (const [txnId, txn] of Object.entries(transactions)) {
                if (txn.type === 'Deposit' && 
                    txn.amount == amount && 
                    txn.status === 'Pending' &&
                    txn.date === reqData.date) {
                    await db.ref(`transactions/${uid}/${txnId}`).update({ status: 'Completed' });
                    break;
                }
            }
            
            // Track analytics
            await trackDepositAccept(amount);
            
            showToast('Deposit approved!'); loadDepositRequests(); loadDashboardData();
        } catch(e) { showToast(e.message,'error'); }
    }
    async function rejectDeposit(rid) {
        if (!confirm('Reject?')) return;
        try { 
            const reqSnap = await db.ref(`depositRequests/${rid}`).once('value');
            const reqData = reqSnap.val();
            
            await db.ref(`depositRequests/${rid}`).update({ status:'rejected', rejectedDate:Date.now() }); 
            
            // Update transaction history status
            const transactionsSnap = await db.ref(`transactions/${reqData.userId}`).once('value');
            const transactions = transactionsSnap.val() || {};
            
            for (const [txnId, txn] of Object.entries(transactions)) {
                if (txn.type === 'Deposit' && 
                    txn.amount == reqData.amount && 
                    txn.status === 'Pending' &&
                    txn.date === reqData.date) {
                    await db.ref(`transactions/${reqData.userId}/${txnId}`).update({ status: 'Rejected' });
                    break;
                }
            }
            
            showToast('Rejected'); loadDepositRequests(); loadDashboardData(); 
        }
        catch(e) { showToast(e.message,'error'); }
    }

    // ======= WITHDRAW =======
    let showAllWithdraws = false;
    
    function toggleWithdrawFilter() {
        showAllWithdraws = !showAllWithdraws;
        const btn = document.getElementById('withdrawFilterBtn');
        if (showAllWithdraws) {
            btn.textContent = '‚è≥ Show Pending Only';
            btn.style.background = '#ff9800';
        } else {
            btn.textContent = 'üìã Show All';
            btn.style.background = '#666';
        }
        loadWithdrawRequests();
    }
    
    async function loadWithdrawRequests() {
        const el = document.getElementById('withdrawList');
        el.innerHTML = emptyState('‚è≥','Loading...');
        try {
            const snap = await db.ref('withdrawRequests').once('value');
            const reqs = snap.val() || {};
            
            let filteredReqs = {};
            
            if (showAllWithdraws) {
                // Show all requests
                filteredReqs = reqs;
            } else {
                // Filter: ‡¶∂‡ßÅ‡¶ß‡ßÅ pending requests ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá
                Object.keys(reqs).forEach(rid => {
                    if (reqs[rid].status === 'pending') {
                        filteredReqs[rid] = reqs[rid];
                    }
                });
            }
            
            if (!Object.keys(filteredReqs).length) { 
                el.innerHTML = emptyState('‚¨ÜÔ∏è', showAllWithdraws ? 'No withdraw requests' : 'No pending withdraw requests'); 
                return; 
            }
            
            // Sort by newest first
            const sortedKeys = Object.keys(filteredReqs).sort((a, b) => {
                const timeA = filteredReqs[a].timestamp || filteredReqs[a].date || 0;
                const timeB = filteredReqs[b].timestamp || filteredReqs[b].date || 0;
                return timeB - timeA;
            });
            
            el.innerHTML = sortedKeys.map(rid => {
                const r = filteredReqs[rid];
                const bc = r.status==='pending'?'badge-pending':r.status==='approved'?'badge-approved':'badge-rejected';
                
                // Show payment proof if exists
                let proofHTML = '';
                if (r.paymentProof && r.paymentProof.length > 0) {
                    proofHTML = `<div class="card-row" style="flex-direction:column; align-items:flex-start; gap:8px;">
                        <span class="card-label">Payment Proof:</span>
                        <div style="display:flex; gap:8px; flex-wrap:wrap;">
                            ${r.paymentProof.map((img, idx) => `
                                <img src="${img}" onclick="openImageViewer('${img}', 'Payment Proof ${idx+1}')" 
                                     style="width:80px; height:80px; object-fit:cover; border-radius:8px; cursor:pointer; border:2px solid #ddd;">
                            `).join('')}
                        </div>
                    </div>`;
                }
                
                return `<div class="card">
                    <div class="card-row"><span class="card-title" style="font-size:15px">üí∏ ${r.userName||'N/A'}</span><span class="badge ${bc}">${r.status||'pending'}</span></div>
                    <div class="card-row"><span class="card-label">Amount</span><span class="card-value" style="color:var(--warning);font-size:18px">‡ß≥${r.amount||0}</span></div>
                    <div class="card-row"><span class="card-label">Method</span><span class="card-value">${r.method||'N/A'}</span></div>
                    <div class="card-row"><span class="card-label">Phone</span><span class="card-value">${r.phoneNumber||'N/A'}</span></div>
                    ${proofHTML}
                    ${r.status==='pending'?`<div class="card-actions">
                        <button class="btn-sm btn-approve" onclick="showWithdrawApprovalModal('${rid}','${r.userId}',${r.amount}, '${r.userName||'User'}', '${r.method||'N/A'}', '${r.phoneNumber||'N/A'}')">‚úì Approve</button>
                        <button class="btn-sm btn-reject" onclick="rejectWithdraw('${rid}')">‚úï Reject</button>
                    </div>`:''}
                </div>`;
            }).join('');
        } catch(e) { el.innerHTML = emptyState('‚ùå','Error'); }
    }

    // Helper function for transaction update (runs in background)
    async function updateTransactionStatus(uid, amount, date, type, status) {
        try {
            const transactionsSnap = await db.ref(`transactions/${uid}`).once('value');
            const transactions = transactionsSnap.val() || {};
            
            for (const [txnId, txn] of Object.entries(transactions)) {
                if (txn.type === type && 
                    txn.amount == amount && 
                    txn.status === 'Pending' &&
                    txn.date === date) {
                    await db.ref(`transactions/${uid}/${txnId}`).update({ status });
                    break;
                }
            }
        } catch(e) {
            console.error('Transaction update error:', e);
        }
    }

        async function approveWithdraw(rid, uid, amount) {
        if (!canAdminMakeRequest('approve')) {
            console.log('Approve ignored - cooldown');
            alert('‚è≥ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶è‡¶ï‡¶ü‡ßÅ ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®...\n\n‡¶è‡¶ï‡¶ü‡¶ø approve ‡¶è‡¶∞ ‡¶™‡¶∞ ‡ß©‡ß¶ ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶° ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§');
            return;
        }
        
        if (!confirm('Approve withdraw?')) return;
        
        try {
            // Show processing
            showToast('Processing...', 'info');
            
            // Get data in parallel
            const [reqSnap, uSnap] = await Promise.all([
                db.ref(`withdrawRequests/${rid}`).once('value'),
                db.ref(`users/${uid}`).once('value')
            ]);
            
            const reqData = reqSnap.val();
            const u = uSnap.val() || {};
            
            // Batch update - faster!
            const updates = {};
            updates[`withdrawRequests/${rid}/status`] = 'approved';
            updates[`withdrawRequests/${rid}/approvedDate`] = Date.now();
            updates[`withdrawRequests/${rid}/processedAt`] = Date.now();
            updates[`users/${uid}/winning`] = Math.max(0, (u.winning || 0) - amount);
            
            await db.ref().update(updates);
            
            // Update transaction in background
            updateTransactionStatus(uid, amount, reqData.date, 'Withdraw', 'Completed');
            
            // Track analytics in background
            trackWithdrawAccept(amount);
            
            showToast('‚úÖ Withdraw approved!', 'success');
            loadWithdrawRequests();
            loadDashboardData();
        } catch(e) { 
            console.error('Withdraw approve error:', e);
            showToast('‚ùå ' + e.message, 'error'); 
        }
    }
    async function rejectWithdraw(rid) {
        if (!confirm('Reject?')) return;
        try {
            showToast('Processing...', 'info');
            
            const reqSnap = await db.ref(`withdrawRequests/${rid}`).once('value');
            const reqData = reqSnap.val();
            
            if (!reqData) {
                showToast('Request not found', 'error');
                return;
            }
            
            // ‚úÖ Refund the amount back to user's balance (since it was deducted when request was made)
            const userSnap = await db.ref(`users/${reqData.userId}`).once('value');
            const userData = userSnap.val();
            if (userData) {
                const currentBalance = parseFloat(userData.balance || 0);
                const refundAmount = parseFloat(reqData.amount || 0);
                const newBalance = currentBalance + refundAmount;
                
                await db.ref(`users/${reqData.userId}/balance`).set(newBalance);
            }
            
            // Batch update
            const updates = {};
            updates[`withdrawRequests/${rid}/status`] = 'rejected';
            updates[`withdrawRequests/${rid}/rejectedDate`] = Date.now();
            
            await db.ref().update(updates);
            
            // Update transaction status to Rejected
            if (reqData) {
                updateTransactionStatus(reqData.userId, reqData.amount, reqData.date, 'Withdraw', 'Rejected');
            }
            
            showToast('‚úÖ Rejected & Money Refunded', 'success');
            loadWithdrawRequests();
            loadDashboardData();
        }
        catch(e) { 
            showToast('‚ùå ' + e.message, 'error'); 
        }
    }

    // ======= WITHDRAW APPROVAL SYSTEM =======
    let currentWithdrawApproval = null;
    
    function showWithdrawApprovalModal(rid, uid, amount, userName, method, phone) {
        currentWithdrawApproval = { rid, uid, amount, userName, method, phone };
        
        // Show details
        document.getElementById('withdrawApprovalDetails').innerHTML = `
            <div style="margin-bottom:8px;"><strong>üë§ User:</strong> ${userName}</div>
            <div style="margin-bottom:8px;"><strong>üí∞ Amount:</strong> <span style="color:#ff9800; font-weight:800;">‡ß≥${amount}</span></div>
            <div style="margin-bottom:8px;"><strong>üì± Method:</strong> ${method}</div>
            <div><strong>üìû Phone:</strong> ${phone}</div>
        `;
        
        document.getElementById('withdrawApprovalModal').style.display = 'flex';
    }
    
    function closeWithdrawApprovalModal() {
        document.getElementById('withdrawApprovalModal').style.display = 'none';
        currentWithdrawApproval = null;
    }
    
    async function confirmWithdrawApproval() {
        if (!currentWithdrawApproval) return;
        
        const { rid, uid, amount } = currentWithdrawApproval;
        
        try {
            showToast('Processing...', 'info');
            
            const reqSnap = await db.ref(`withdrawRequests/${rid}`).once('value');
            const reqData = reqSnap.val();
            
            // Get user data
            const uSnap = await db.ref(`users/${uid}`).once('value');
            const u = uSnap.val() || {};
            
            // Batch update - faster!
            const updates = {};
            updates[`withdrawRequests/${rid}/status`] = 'approved';
            updates[`withdrawRequests/${rid}/approvedDate`] = Date.now();
            updates[`withdrawRequests/${rid}/processedAt`] = Date.now();
            updates[`users/${uid}/winning`] = Math.max(0, (u.winning || 0) - amount);
            
            await db.ref().update(updates);
            
            // Update transaction history in background
            updateTransactionStatus(uid, amount, reqData.date, 'Withdraw', 'Completed');
            
            // Track analytics in background
            trackWithdrawAccept(amount);
            
            closeWithdrawApprovalModal();
            showToast('‚úÖ Withdraw approved!', 'success'); 
            loadWithdrawRequests(); 
            loadDashboardData();
        } catch(e) { 
            showToast('‚ùå ' + e.message, 'error'); 
            console.error(e);
        }
    }
    
    // Image viewer function
    function openImageViewer(src, title) {
        const viewer = document.createElement('div');
        viewer.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:99999; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:20px;';
        viewer.innerHTML = `
            <div style="color:#fff; font-size:18px; font-weight:700; margin-bottom:20px;">${title || 'Payment Proof'}</div>
            <img src="${src}" style="max-width:90%; max-height:80vh; object-fit:contain; border-radius:12px; box-shadow:0 8px 32px rgba(0,0,0,0.5);">
            <button onclick="this.closest('div').remove()" style="margin-top:20px; padding:12px 32px; background:#fff; color:#000; border:none; border-radius:8px; font-size:16px; font-weight:700; cursor:pointer;">‚úï Close</button>
        `;
        viewer.onclick = function(e) {
            if (e.target === viewer) viewer.remove();
        };
        document.body.appendChild(viewer);
    }

    // ======= TOURNAMENTS =======
    async function loadCategoriesForSelect() {
        try {
            const snap = await db.ref('categories').once('value');
            const cats = snap.val() || {};
            const sel = document.getElementById('matchCategory');
            sel.innerHTML = '<option value="">Select Category</option>';
            Object.entries(cats).forEach(([key, c]) => { 
                sel.innerHTML += `<option value="${key}">${c.name}</option>`; 
            });
        } catch(e) {}
    }

    // Create or Update tournament
    async function saveTournament() {
        const editId = document.getElementById('editTournamentId').value;
        const data = {
            title: document.getElementById('matchTitle').value,
            category: document.getElementById('matchCategory').value,
            map: document.getElementById('matchMap').value,
            gameType: document.getElementById('gameType').value,
            dateTime: document.getElementById('matchDateTime').value,
            entryFee: parseInt(document.getElementById('entryFee').value)||0,
            totalPrize: parseInt(document.getElementById('totalPrize').value)||0,
            perKill: parseInt(document.getElementById('perKill').value)||0,
            slots: parseInt(document.getElementById('slots').value)||0,
            roomId: document.getElementById('roomId').value,
            roomPassword: document.getElementById('roomPassword').value,
            prizes: {
                first: parseInt(document.getElementById('prize1st').value)||0,
                second: parseInt(document.getElementById('prize2nd').value)||0,
                third: parseInt(document.getElementById('prize3rd').value)||0,
                fourth: parseInt(document.getElementById('prize4th').value)||0,
                fifth: parseInt(document.getElementById('prize5th').value)||0
            },
            matchRules: document.getElementById('matchRules').value
        };
        
        // ‚úÖ Save complete tournament data to localStorage for auto-fill next time
        const lastTournamentData = {
            title: data.title,
            category: data.category,
            map: data.map,
            gameType: data.gameType,
            entryFee: data.entryFee,
            totalPrize: data.totalPrize,
            perKill: data.perKill,
            slots: data.slots,
            roomId: data.roomId,
            roomPassword: data.roomPassword,
            prize1st: data.prizes.first,
            prize2nd: data.prizes.second,
            prize3rd: data.prizes.third,
            prize4th: data.prizes.fourth,
            prize5th: data.prizes.fifth,
            rules: data.matchRules
        };
        localStorage.setItem('lastTournamentData', JSON.stringify(lastTournamentData));
        
        if (!data.title || !data.category) { showToast('Title ‡¶ì Category ‡¶¶‡¶ø‡¶®','error'); return; }

        try {
            if (editId) {
                // Update existing
                const oldData = (await db.ref(`tournaments/${editId}`).once('value')).val();
                await db.ref(`tournaments/${editId}`).update(data);
                showToast('Tournament updated!');
                
                // Check if Room ID or Password was updated
                if (data.roomId && data.roomPassword && 
                    (oldData.roomId !== data.roomId || oldData.roomPassword !== data.roomPassword)) {
                    // Send notification to all joined players
                    await sendRoomDetailsNotification(editId, data);
                }
            } else {
                // Create new
                data.status = 'active';
                data.createdDate = Date.now();
                data.createdBy = currentUser.email;
                data.participants = 0;
                data.resultDeclared = false;
                await db.ref('tournaments').push(data);
                showToast('Tournament created!');
            }
            closeSheet('sheetTournament');
            loadTournaments();
            loadDashboardData();
        } catch(e) { showToast(e.message,'error'); }
    }

    // Open edit sheet for tournament
    async function editTournament(tid) {
        await loadCategoriesForSelect();
        try {
            const snap = await db.ref(`tournaments/${tid}`).once('value');
            const t = snap.val();
            if (!t) { showToast('Tournament not found','error'); return; }

            document.getElementById('editTournamentId').value = tid;
            document.getElementById('matchTitle').value = t.title||'';
            document.getElementById('matchMap').value = t.map||'';
            document.getElementById('gameType').value = t.gameType||'solo';
            document.getElementById('matchDateTime').value = t.dateTime||'';
            document.getElementById('entryFee').value = t.entryFee||'';
            document.getElementById('totalPrize').value = t.totalPrize||'';
            document.getElementById('perKill').value = t.perKill||'';
            document.getElementById('slots').value = t.slots||'';
            document.getElementById('roomId').value = t.roomId||'';
            document.getElementById('roomPassword').value = t.roomPassword||'';
            document.getElementById('prize1st').value = (t.prizes && t.prizes.first)||'';
            document.getElementById('prize2nd').value = (t.prizes && t.prizes.second)||'';
            document.getElementById('prize3rd').value = (t.prizes && t.prizes.third)||'';
            document.getElementById('prize4th').value = (t.prizes && t.prizes.fourth)||'';
            document.getElementById('prize5th').value = (t.prizes && t.prizes.fifth)||'';
            document.getElementById('matchRules').value = t.matchRules||t.rules||'';

            // Set category
            const sel = document.getElementById('matchCategory');
            for (let i = 0; i < sel.options.length; i++) {
                if (sel.options[i].value === t.category) { sel.selectedIndex = i; break; }
            }

            document.getElementById('tournamentSheetTitle').textContent = 'Edit Tournament';
            document.getElementById('tournamentSaveBtn').textContent = 'Update Match';
            openSheet('sheetTournament');
        } catch(e) { showToast(e.message,'error'); }
    }

    // Reset tournament sheet for creation
    function openCreateTournament() {
        document.getElementById('editTournamentId').value = '';
        document.getElementById('tournamentSheetTitle').textContent = 'Create Tournament';
        document.getElementById('tournamentSaveBtn').textContent = 'Create Match';
        
        // ‚úÖ Auto-fill: Load last tournament data from localStorage
        const lastTournamentData = localStorage.getItem('lastTournamentData');
        if (lastTournamentData) {
            try {
                const data = JSON.parse(lastTournamentData);
                // Fill all fields with last tournament data
                if (data.title) document.getElementById('matchTitle').value = data.title;
                if (data.category) document.getElementById('matchCategory').value = data.category;
                if (data.map) document.getElementById('matchMap').value = data.map;
                if (data.gameType) document.getElementById('gameType').value = data.gameType;
                if (data.entryFee) document.getElementById('entryFee').value = data.entryFee;
                if (data.totalPrize) document.getElementById('totalPrize').value = data.totalPrize;
                if (data.perKill) document.getElementById('perKill').value = data.perKill;
                if (data.slots) document.getElementById('slots').value = data.slots;
                if (data.roomId) document.getElementById('roomId').value = data.roomId;
                if (data.roomPassword) document.getElementById('roomPassword').value = data.roomPassword;
                if (data.prize1st) document.getElementById('prize1st').value = data.prize1st;
                if (data.prize2nd) document.getElementById('prize2nd').value = data.prize2nd;
                if (data.prize3rd) document.getElementById('prize3rd').value = data.prize3rd;
                if (data.prize4th) document.getElementById('prize4th').value = data.prize4th;
                if (data.prize5th) document.getElementById('prize5th').value = data.prize5th;
                if (data.rules) document.getElementById('matchRules').value = data.rules;
            } catch(e) {
                console.error('Failed to load last tournament data:', e);
            }
        } else {
            // If no last data, clear fields
            ['matchTitle','matchMap','matchDateTime','entryFee','totalPrize','perKill','slots','roomId','roomPassword','prize1st','prize2nd','prize3rd','prize4th','prize5th','matchRules'].forEach(id => {
                document.getElementById(id).value = '';
            });
        }
        
        loadCategoriesForSelect();
        openSheet('sheetTournament');
    }

    async function loadTournaments() {
        const el = document.getElementById('tournamentList');
        el.innerHTML = emptyState('‚è≥','Loading...');
        try {
            const [tSnap, cSnap] = await Promise.all([
                db.ref('tournaments').once('value'),
                db.ref('categories').once('value')
            ]);
            const ts = tSnap.val() || {};
            const cats = cSnap.val() || {};
            
            // ‚úÖ Filter: Show only uncompleted tournaments (resultDeclared !== true)
            const uncompletedTournaments = Object.keys(ts).filter(tid => !ts[tid].resultDeclared);
            
            if (!uncompletedTournaments.length) { el.innerHTML = emptyState('üèÜ','No active tournaments'); return; }
            el.innerHTML = uncompletedTournaments.map(tid => {
                const t = ts[tid];
                const categoryName = cats[t.category]?.name || t.category || 'N/A';
                const participantCount = t.participants && typeof t.participants === 'object' ? Object.keys(t.participants).length : 0;
                const bc = t.status==='active'?'badge-active':'badge-completed';
                return `<div class="card">
                    <div class="card-row"><span class="card-title" style="font-size:15px">üèÜ ${t.title||'N/A'}</span><span class="badge ${bc}">${t.status||'active'}</span></div>
                    <div class="card-row"><span class="card-label">Category</span><span class="card-value">${categoryName}</span></div>
                    <div class="card-row"><span class="card-label">Entry Fee</span><span class="card-value">‡ß≥${t.entryFee||0}</span></div>
                    <div class="card-row"><span class="card-label">Prize Pool</span><span class="card-value" style="color:var(--success)">‡ß≥${t.totalPrize||0}</span></div>
                    <div class="card-row"><span class="card-label">Room ID</span><span class="card-value">${t.roomId||'N/A'}</span></div>
                    <div class="card-row"><span class="card-label">Room Pass</span><span class="card-value">${t.roomPassword||'N/A'}</span></div>
                    <div class="card-row"><span class="card-label">Slots</span><span class="card-value">${participantCount}/${t.slots||0}</span></div>
                    <div class="card-row"><span class="card-label">Result</span><span class="card-value">${t.resultDeclared?'<span style="color:var(--success)">‚úì Declared</span>':'<span style="color:var(--warning)">Pending</span>'}</span></div>
                    <div class="card-actions" style="display:flex; gap:8px; flex-wrap:wrap;">
                        <button class="btn-sm btn-edit-sm" onclick="editTournament('${tid}')" style="flex:1; min-width:60px;">‚úèÔ∏è Edit</button>
                        <button class="btn-sm btn-delete" onclick="deleteTournament('${tid}')" style="flex:1; min-width:70px;">üóë Delete</button>
                        <button class="btn-sm" style="background:#1a73e8; color:#fff; flex:1; min-width:100px;" onclick='sendMatchReminder("${tid}", ${JSON.stringify(t).replace(/'/g, "\\'")})'  title="Send match reminder to joined players">‚è∞ Remind</button>
                        <button class="btn-sm" style="background:#ff9800; color:#fff; flex:1; min-width:110px;" onclick='sendEmptySlotAlert("${tid}", ${JSON.stringify(t).replace(/'/g, "\\'")})'  title="Send empty slot alert to all users">üì¢ Empty Alert</button>
                    </div>
                </div>`;
            }).join('');
        } catch(e) { el.innerHTML = emptyState('‚ùå','Error'); }
    }

    async function deleteTournament(tid) {
        try {
            const snap = await db.ref(`tournaments/${tid}`).once('value');
            const matchData = snap.val();
            if (!matchData) { showToast('Tournament ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø!', 'error'); return; }

            const matchTitle = matchData.title || 'Match';
            const isCompleted = matchData.status === 'completed' 
                || matchData.resultDeclared === true 
                || matchData.winnersDistributed === true;
            const entryFee = matchData.entryFee || 0;
            const participants = matchData.participants || {};
            const participantKeys = typeof participants === 'object' ? Object.keys(participants) : [];
            const count = participantKeys.length;

            if (isCompleted) {
                // Match complete + prize ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá ‚Üí ‡¶∂‡ßÅ‡¶ß‡ßÅ delete, ‡¶ï‡ßã‡¶®‡ßã refund ‡¶®‡ßá‡¶á
                if (!confirm(`"${matchTitle}" delete ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?\n\n‚ö†Ô∏è ‡¶è‡¶á match ‡¶ü‡¶ø complete ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá ‡¶è‡¶¨‡¶Ç prize ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§\n‡¶ï‡ßã‡¶®‡ßã entry fee refund ‡¶π‡¶¨‡ßá ‡¶®‡¶æ‡•§`)) return;
                await db.ref(`tournaments/${tid}`).remove();
                showToast('‚úÖ Tournament deleted!');
            } else {
                // Match complete ‡¶π‡¶Ø‡¶º‡¶®‡¶ø ‚Üí ‡¶∏‡¶¨‡¶æ‡¶á‡¶ï‡ßá entry fee refund
                if (count === 0) {
                    if (!confirm(`"${matchTitle}" delete ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?`)) return;
                    await db.ref(`tournaments/${tid}`).remove();
                    showToast('‚úÖ Tournament deleted!');
                    loadTournaments(); loadDashboardData();
                    return;
                }
                if (!confirm(`"${matchTitle}" delete ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?\n\n${count} ‡¶ú‡¶® participant ‡¶ï‡ßá ‡ß≥${entryFee} ‡¶ï‡¶∞‡ßá refund ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ ‡¶π‡¶¨‡ßá‡•§\n‡¶Æ‡ßã‡¶ü refund: ‡ß≥${count * entryFee}`)) return;

                showToast('‚è≥ Refund processing...');
                const updates = {};
                for (const uid of participantKeys) {
                    const uSnap = await db.ref(`users/${uid}`).once('value');
                    const u = uSnap.val() || {};
                    updates[`users/${uid}/deposit`] = (u.deposit || 0) + entryFee;
                    const txnId = `refund_${Date.now()}_${Math.random().toString(36).substr(2,6)}`;
                    updates[`transactions/${uid}/${txnId}`] = {
                        type: 'Refund', amount: entryFee, status: 'Completed',
                        date: new Date().toLocaleDateString('bn-BD'),
                        timestamp: Date.now(), matchTitle: matchTitle,
                        note: 'Match deleted - entry fee refunded'
                    };
                }
                await db.ref().update(updates);
                await db.ref(`tournaments/${tid}`).remove();
                showToast(`‚úÖ ${count} ‡¶ú‡¶®‡¶ï‡ßá ‡ß≥${entryFee} ‡¶ï‡¶∞‡ßá refund ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!`);
            }
            loadTournaments(); loadDashboardData();
        } catch(e) { showToast(e.message, 'error'); console.error(e); }
    }


    // ======= MANUAL DEPOSIT =======
    // Global variable to store users for search
    let allUsersForManualDeposit = {};

    async function loadUsersForManualDeposit() {
        try {
            const snap = await db.ref('users').once('value');
            const users = snap.val() || {};
            allUsersForManualDeposit = users; // Store globally for search
            
            const sel = document.getElementById('manualDepositUser');
            sel.innerHTML = '<option value="">Select User</option>';
            Object.keys(users).forEach(uid => {
                const u = users[uid];
                sel.innerHTML += `<option value="${uid}">${u.name||u.email} (‡ß≥${u.deposit||0})</option>`;
            });
            
            // Clear search box and results
            document.getElementById('manualDepositSearchBox').value = '';
            document.getElementById('searchResultsList').style.display = 'none';
            document.getElementById('searchResultsList').innerHTML = '';
        } catch(e) {}
    }
    
    function searchUsersInSheet() {
        const searchTerm = document.getElementById('manualDepositSearchBox').value.toLowerCase().trim();
        const resultsContainer = document.getElementById('searchResultsList');
        
        if (!searchTerm) {
            resultsContainer.style.display = 'none';
            resultsContainer.innerHTML = '';
            return;
        }
        
        // Search in users
        const matchedUsers = [];
        Object.keys(allUsersForManualDeposit).forEach(uid => {
            const user = allUsersForManualDeposit[uid];
            const email = (user.email || '').toLowerCase();
            const name = (user.name || '').toLowerCase();
            
            if (email.includes(searchTerm) || name.includes(searchTerm) || uid.toLowerCase().includes(searchTerm)) {
                matchedUsers.push({ uid, user });
            }
        });
        
        if (matchedUsers.length === 0) {
            resultsContainer.innerHTML = '<div style="padding:12px; text-align:center; color:var(--text-muted); font-size:13px;">No users found</div>';
            resultsContainer.style.display = 'block';
            return;
        }
        
        // Display results
        resultsContainer.innerHTML = matchedUsers.map(({ uid, user }) => {
            return `
                <div onclick="selectUserFromSearch('${uid}')" 
                     style="padding:12px; cursor:pointer; border-bottom:1px solid var(--border); transition:background 0.2s;"
                     onmouseover="this.style.background='var(--bg-input)'" 
                     onmouseout="this.style.background='transparent'">
                    <div style="font-size:14px; font-weight:600; color:var(--text); margin-bottom:4px;">
                        ${user.name || 'No Name'}
                    </div>
                    <div style="font-size:12px; color:var(--text-muted); margin-bottom:2px;">
                        üìß ${user.email || 'N/A'}
                    </div>
                    <div style="font-size:11px; color:var(--text-muted);">
                        üí∞ Balance: ‡ß≥${user.deposit || 0}
                    </div>
                </div>
            `;
        }).join('');
        
        resultsContainer.style.display = 'block';
    }
    
    function selectUserFromSearch(userId) {
        // Select the user in dropdown
        document.getElementById('manualDepositUser').value = userId;
        
        // Clear search box and hide results
        document.getElementById('manualDepositSearchBox').value = '';
        document.getElementById('searchResultsList').style.display = 'none';
        document.getElementById('searchResultsList').innerHTML = '';
        
        // Show toast
        const user = allUsersForManualDeposit[userId];
        showToast(`‚úÖ Selected: ${user.name || user.email}`);
    }

    function updateTransactionUI() {
        const type = document.getElementById('manualTransactionType').value;
        const label = document.getElementById('amountLabel');
        const btn = document.getElementById('manualDepositBtn');
        
        if (type === 'add') {
            label.textContent = 'Amount to Add (‡ß≥)';
            btn.textContent = 'üí∞ Add Money';
            btn.style.background = 'linear-gradient(135deg, #00b894, #00a880)';
        } else {
            label.textContent = 'Amount to Deduct (‡ß≥)';
            btn.textContent = 'üí∏ Deduct Money';
            btn.style.background = 'linear-gradient(135deg, #ff1744, #c62828)';
        }
    }

    async function submitManualDeposit() {
        if (!canAdminMakeRequest('manual-deposit')) {
            console.log('Manual deposit ignored - cooldown');
            return;
        }
        
        const uid = document.getElementById('manualDepositUser').value;
        const amount = parseInt(document.getElementById('manualDepositAmount').value)||0;
        const type = document.getElementById('manualTransactionType').value;
        
        if (!uid||amount<=0) { showToast('User ‡¶ì Amount ‡¶¶‡¶ø‡¶®','error'); return; }
        
        try {
            const uSnap = await db.ref(`users/${uid}`).once('value');
            const u = uSnap.val() || {};
            
            if (type === 'add') {
                // Add money to user
                await db.ref(`users/${uid}`).update({ deposit:(u.deposit||0)+amount });
                await db.ref('manualDeposits').push({ 
                    userId:uid, 
                    userName:u.name||u.email, 
                    amount, 
                    type: 'add',
                    date:Date.now(), 
                    admin:currentUser.email 
                });
                
                // Track analytics
                await trackDepositAccept(amount);
                
                showToast('‚úÖ Money added to user!');
            } else {
                // Deduct money from user
                const currentBalance = u.deposit || 0;
                if (currentBalance < amount) {
                    showToast('‚ùå User ‡¶è‡¶∞ balance ‡¶ï‡¶Æ! Current: ‡ß≥' + currentBalance, 'error');
                    return;
                }
                
                await db.ref(`users/${uid}`).update({ deposit: currentBalance - amount });
                await db.ref('manualDeposits').push({ 
                    userId:uid, 
                    userName:u.name||u.email, 
                    amount: -amount, 
                    type: 'deduct',
                    date:Date.now(), 
                    admin:currentUser.email 
                });
                
                // Update earning analytics - reduce winning prize
                const today = new Date().toISOString().split('T')[0];
                const earnSnap = await db.ref(`earnings/${today}`).once('value');
                const earnData = earnSnap.val() || { totalEntryFee: 0, winningPrize: 0 };
                
                await db.ref(`earnings/${today}`).update({
                    winningPrize: Math.max(0, (earnData.winningPrize || 0) - amount)
                });
                
                showToast('‚úÖ Money deducted from user!');
            }
            
            closeSheet('sheetManualDeposit'); 
            loadManualDeposits();
        } catch(e) { showToast(e.message,'error'); }
    }

    // Global variable to store manual deposits data for filtering
    let allManualDeposits = [];

    async function loadManualDeposits() {
        const el = document.getElementById('manualDepositList');
        try {
            const snap = await db.ref('manualDeposits').once('value');
            const deps = snap.val() || {};
            
            if (!Object.keys(deps).length) { 
                el.innerHTML = emptyState('üíµ','No manual transactions'); 
                allManualDeposits = [];
                return; 
            }
            
            // Load user data for each deposit
            allManualDeposits = [];
            for (let key in deps) {
                const d = deps[key];
                d.id = key;
                
                // Fetch user details
                if (d.userId) {
                    try {
                        const userSnap = await db.ref(`users/${d.userId}`).once('value');
                        const user = userSnap.val();
                        if (user) {
                            d.userEmail = user.email || 'N/A';
                            d.userFullId = d.userId;
                        }
                    } catch(e) {
                        d.userEmail = 'N/A';
                        d.userFullId = d.userId || 'N/A';
                    }
                } else {
                    d.userEmail = 'N/A';
                    d.userFullId = 'N/A';
                }
                
                allManualDeposits.push(d);
            }
            
            // Reverse to show newest first
            allManualDeposits.reverse();
            
            // Display all
            displayManualDeposits(allManualDeposits);
            
        } catch(e) { 
            el.innerHTML = emptyState('‚ùå','Error'); 
            allManualDeposits = [];
        }
    }
    
    function displayManualDeposits(deposits) {
        const el = document.getElementById('manualDepositList');
        
        if (!deposits || deposits.length === 0) {
            el.innerHTML = emptyState('üíµ','No transactions found');
            return;
        }
        
        el.innerHTML = deposits.map(d => {
            const isAdd = d.type === 'add' || d.amount > 0;
            const icon = isAdd ? 'üí∞' : 'üí∏';
            const color = isAdd ? 'var(--success)' : 'var(--danger)';
            const amountText = isAdd ? `‡ß≥${Math.abs(d.amount)||0}` : `-‡ß≥${Math.abs(d.amount)||0}`;
            const typeText = isAdd ? 'Added' : 'Deducted';
            
            return `<div class="card">
                <div class="card-row"><span class="card-title" style="font-size:15px">${icon} ${d.userName||'N/A'}</span><span class="badge" style="background:${color}">${typeText}</span></div>
                <div class="card-row"><span class="card-label">Email</span><span class="card-value" style="font-size:12px">${d.userEmail || 'N/A'}</span></div>
                <div class="card-row"><span class="card-label">User ID</span><span class="card-value" style="font-size:11px">${d.userFullId ? d.userFullId.substring(0, 20) + '...' : 'N/A'}</span></div>
                <div class="card-row"><span class="card-label">Amount</span><span class="card-value" style="color:${color}">${amountText}</span></div>
                <div class="card-row"><span class="card-label">Admin</span><span class="card-value" style="font-size:12px">${d.admin||'N/A'}</span></div>
            </div>`;
        }).join('');
    }
    


    // ======= NOTICE =======
    async function saveNotice() {
        const type = document.getElementById('noticeType').value;
        const title = document.getElementById('noticeTitle').value.trim();
        const content = document.getElementById('noticeContent').value.trim();
        
        if (!title || !content) { 
            showToast('Title ‡¶è‡¶¨‡¶Ç Content ‡¶¶‡¶ø‡¶®','error'); 
            return; 
        }
        
        try {
            // Get existing notices
            const snap = await db.ref('noticeboard/notices').once('value');
            const notices = snap.val() || [];
            
            // Add new notice
            notices.push({
                type: type,
                title: title,
                content: content,
                date: Date.now()
            });
            
            // Save back to Firebase
            await db.ref('noticeboard').set({ notices: notices });
            
            showToast('Notice added!'); 
            closeSheet('sheetNotice'); 
            loadNotice();
            
            // Clear form
            document.getElementById('noticeTitle').value = '';
            document.getElementById('noticeContent').value = '';
        }
        catch(e) { 
            showToast(e.message,'error'); 
        }
    }
    
    async function loadNotice() {
        const el = document.getElementById('currentNotice');
        try {
            const snap = await db.ref('noticeboard').once('value');
            const data = snap.val();
            
            if (!data || !data.notices || data.notices.length === 0) { 
                el.innerHTML = emptyState('üì¢','No notices added'); 
                return; 
            }
            
            const iconMap = {
                'important': '‚ö†Ô∏è',
                'info': '‚ÑπÔ∏è',
                'warning': 'üö®',
                'update': 'üîî',
                'news': 'üì∞'
            };
            
            let html = '';
            data.notices.forEach((notice, index) => {
                const icon = iconMap[notice.type] || 'üìå';
                const dateStr = new Date(notice.date).toLocaleString('bn-BD');
                
                html += `
                    <div class="card" style="margin-bottom:12px;">
                        <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px;">
                            <div style="display:flex; align-items:center; gap:10px;">
                                <span style="font-size:24px;">${icon}</span>
                                <span class="card-title" style="font-size:16px;">${notice.title}</span>
                            </div>
                            <button class="btn-sm btn-delete" onclick="deleteNotice(${index})">üóë</button>
                        </div>
                        <div class="card-row">
                            <p style="font-size:13px; color:#666; line-height:1.6; white-space:pre-wrap;">${notice.content}</p>
                        </div>
                        <div class="card-row">
                            <span class="card-label">Date</span>
                            <span class="card-value" style="font-size:11px;">${dateStr}</span>
                        </div>
                    </div>
                `;
            });
            
            el.innerHTML = html;
        } catch(e) {
            el.innerHTML = emptyState('‚ùå','Error loading notices');
        }
    }
    
    async function deleteNotice(index) {
        if (!confirm('Delete this notice?')) return;
        
        try {
            const snap = await db.ref('noticeboard/notices').once('value');
            const notices = snap.val() || [];
            
            // Remove notice at index
            notices.splice(index, 1);
            
            // Save back
            await db.ref('noticeboard').set({ notices: notices });
            
            showToast('Notice deleted!');
            loadNotice();
        } catch(e) {
            showToast(e.message, 'error');
        }
    }

    // ======= CATEGORIES =======
    async function saveCategory() {
        const name = document.getElementById('categoryName').value.trim();
        const emoji = document.getElementById('categoryEmoji').value.trim() || 'üéÆ';
        if (!name) { showToast('Category name ‡¶¶‡¶ø‡¶®','error'); return; }
        const data = { name, emoji, dateAdded:Date.now() };
        try { await db.ref('categories').push(data); showToast('Category added!'); closeSheet('sheetCategory'); loadCategories(); }
        catch(e) { showToast(e.message,'error'); }
    }
    async function loadCategories() {
        const el = document.getElementById('categoriesList');
        try {
            const snap = await db.ref('categories').once('value');
            const cats = snap.val() || {};
            if (!Object.keys(cats).length) { el.innerHTML = emptyState('üìÅ','No categories'); return; }
            el.innerHTML = Object.keys(cats).map(cid => {
                const c = cats[cid];
                const emoji = c.emoji || 'üéÆ';
                return `<div class="card">
                    <div style="display:flex; align-items:center; gap:14px; margin-bottom:4px;">
                        <span style="font-size:36px; line-height:1;">${emoji}</span>
                        <span style="font-size:18px; font-weight:700;">${c.name||'N/A'}</span>
                    </div>
                    <div class="card-actions"><button class="btn-sm btn-delete" onclick="deleteCategory('${cid}')">üóë Delete</button></div>
                </div>`;
            }).join('');
        } catch(e) {}
    }
    async function deleteCategory(cid) {
        if (!confirm('Delete?')) return;
        try { await db.ref(`categories/${cid}`).remove(); showToast('Deleted!'); loadCategories(); }
        catch(e) { showToast(e.message,'error'); }
    }

    // ======= RULES =======
    async function saveRules() {
        const data = { content:document.getElementById('rulesContent').value, lastUpdated:Date.now() };
        if (!data.content) { showToast('Rules ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®','error'); return; }
        try { await db.ref('gameRules').set(data); showToast('Rules saved!'); closeSheet('sheetRules'); loadRules(); }
        catch(e) { showToast(e.message,'error'); }
    }
    async function loadRules() {
        const el = document.getElementById('currentRules');
        try {
            const snap = await db.ref('gameRules').once('value');
            const r = snap.val();
            if (!r) { el.innerHTML = emptyState('üìã','No rules set'); return; }
            el.innerHTML = `<div class="content-box"><h3>üìã Game Rules</h3><p style="white-space:pre-wrap">${r.content}</p><small>Updated: ${new Date(r.lastUpdated).toLocaleString('bn-BD')}</small></div>`;
        } catch(e) {}
    }

    // ======= NOTIFICATIONS =======
    async function sendNotification() {
        const data = { title:document.getElementById('notificationTitle').value, message:document.getElementById('notificationMessage').value, target:document.getElementById('notificationTarget').value, sentDate:Date.now(), sentBy:currentUser.email };
        if (!data.title||!data.message) { showToast('Title ‡¶ì Message ‡¶¶‡¶ø‡¶®','error'); return; }
        try { await db.ref('notifications').push(data); showToast('Notification sent!'); closeSheet('sheetNotification'); loadNotifications(); }
        catch(e) { showToast(e.message,'error'); }
    }
    async function loadNotifications() {
        const el = document.getElementById('notificationList');
        try {
            const snap = await db.ref('notifications').once('value');
            const ns = snap.val() || {};
            if (!Object.keys(ns).length) { el.innerHTML = emptyState('üîî','No notifications'); return; }
            el.innerHTML = Object.keys(ns).reverse().map(nid => {
                const n = ns[nid];
                return `<div class="card">
                <div class="card-row"><span class="card-title">üîî ${n.title||'N/A'}</span></div>
                <div class="card-row"><span class="card-label">Message</span><span class="card-value" style="font-size:13px">${n.message||'N/A'}</span></div>
                <div class="card-row"><span class="card-label">Target</span><span class="card-value">${n.target==='all'?'All Users':'Active Users'}</span></div>
                <div class="card-actions" style="margin-top:10px;">
                    <button class="btn-sm btn-reject" onclick="deleteNotification('${nid}')">üóëÔ∏è Delete</button>
                </div>
            </div>`;
            }).join('');
        } catch(e) {}
    }

    async function deleteNotification(nid) {
        if (!confirm('Delete this notification? It will be removed from all users.')) return;
        try {
            await db.ref('notifications/' + nid).remove();
            showToast('üóëÔ∏è Notification deleted!');
            loadNotifications();
        } catch(e) {
            showToast(e.message, 'error');
        }
    }

    // ======= REFERRALS =======
    async function loadReferralRequests() {
        const el = document.getElementById('referList');
        el.innerHTML = emptyState('‚è≥','Loading...');
        try {
            const snap = await db.ref('referralRequests').once('value');
            const reqs = snap.val() || {};
            if (!Object.keys(reqs).length) { el.innerHTML = emptyState('üîó','No referral requests'); return; }
            el.innerHTML = Object.keys(reqs).map(rid => {
                const r = reqs[rid];
                const bc = r.status==='pending'?'badge-pending':r.status==='approved'?'badge-approved':'badge-rejected';
                return `<div class="card">
                    <div class="card-row"><span class="card-title">üîó ${r.referrerName||'N/A'}</span><span class="badge ${bc}">${r.status||'pending'}</span></div>
                    <div class="card-row"><span class="card-label">Referred</span><span class="card-value">${r.referredName||'N/A'}</span></div>
                    <div class="card-row"><span class="card-label">Code</span><span class="card-value">${r.referralCode||'N/A'}</span></div>
                    ${r.status==='pending'?`<div class="card-actions">
                        <button class="btn-sm btn-approve" onclick="approveReferral('${rid}','${r.referrerId}','${r.referredId}')">‚úì Approve</button>
                        <button class="btn-sm btn-reject" onclick="rejectReferral('${rid}','${r.referrerId}')">‚úï Reject</button>
                    </div>`:''}
                </div>`;
            }).join('');
        } catch(e) { el.innerHTML = emptyState('‚ùå','Error'); }
    }

    async function approveReferral(rid, referrerId, referredId) {
        if (!confirm('Approve referral?')) return;
        try {
            await db.ref(`referralRequests/${rid}`).update({ status:'approved', approvedDate:Date.now() });
            const rSnap = await db.ref(`users/${referrerId}`).once('value');
            const ref = rSnap.val()||{};
            await db.ref(`users/${referrerId}`).update({ referBalance:(ref.referBalance||0)+10 });
            showToast('Referral approved!'); loadReferralRequests();
        } catch(e) { showToast(e.message,'error'); }
    }
    async function rejectReferral(rid) {
        if (!confirm('Reject?')) return;
        try { await db.ref(`referralRequests/${rid}`).update({ status:'rejected', rejectedDate:Date.now() }); showToast('Rejected'); loadReferralRequests(); }
        catch(e) { showToast(e.message,'error'); }
    }

    // ======= SETTINGS =======
    async function loadSettings() {
        try {
            const snap = await db.ref('settings').once('value');
            const s = snap.val() || {};
            document.getElementById('userPanelName').value = s.userPanelName||'';
            document.getElementById('adminPanelName').value = s.adminPanelName||'';
            document.getElementById('bkashNumber').value = s.bkashNumber||'';
            document.getElementById('nagadNumber').value = s.nagadNumber||'';
            document.getElementById('minDeposit').value = s.minDeposit||'';
            document.getElementById('dailyDepositLimit').value = s.dailyDepositLimit||'';
            document.getElementById('minWithdraw').value = s.minWithdraw||'';
            document.getElementById('supportFacebook').value = s.supportFacebook||'';
            document.getElementById('supportWhatsapp').value = s.supportWhatsapp||'';
            document.getElementById('supportTelegram').value = s.supportTelegram||'';
            document.getElementById('supportYoutube').value = s.supportYoutube||'';
            document.getElementById('supportGmail').value = s.supportGmail||'';
            document.getElementById('customLink1').value = s.customLink1||'';
            document.getElementById('customLink2').value = s.customLink2||'';
            document.getElementById('customLink3').value = s.customLink3||'';
            document.getElementById('welcomeMessage').value = s.welcomeMessage||'';
        } catch(e) {}
    }
    async function saveSettings() {
        const data = {
            userPanelName: document.getElementById('userPanelName').value,
            adminPanelName: document.getElementById('adminPanelName').value,
            bkashNumber: document.getElementById('bkashNumber').value,
            nagadNumber: document.getElementById('nagadNumber').value,
            minDeposit: parseInt(document.getElementById('minDeposit').value)||0,
            dailyDepositLimit: parseInt(document.getElementById('dailyDepositLimit').value)||0,
            minWithdraw: parseInt(document.getElementById('minWithdraw').value)||0,
            supportFacebook: document.getElementById('supportFacebook').value,
            supportWhatsapp: document.getElementById('supportWhatsapp').value,
            supportTelegram: document.getElementById('supportTelegram').value,
            supportYoutube: document.getElementById('supportYoutube').value,
            supportGmail: document.getElementById('supportGmail').value,
            customLink1: document.getElementById('customLink1').value,
            customLink2: document.getElementById('customLink2').value,
            customLink3: document.getElementById('customLink3').value,
            welcomeMessage: document.getElementById('welcomeMessage').value,
            lastUpdated: Date.now()
        };
        
        // User Panel ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø app_settings ‡¶è ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßã (user panel ‡¶è payment numbers show ‡¶π‡¶¨‡ßá)
        const appSettingsData = {
            bkash_number: document.getElementById('bkashNumber').value,
            nagad_number: document.getElementById('nagadNumber').value,
            min_deposit: parseInt(document.getElementById('minDeposit').value)||0,
            daily_deposit_limit: parseInt(document.getElementById('dailyDepositLimit').value)||0,
            min_withdraw: parseInt(document.getElementById('minWithdraw').value)||0,
            app_name: document.getElementById('userPanelName').value,
            support_facebook: document.getElementById('supportFacebook').value,
            support_whatsapp: document.getElementById('supportWhatsapp').value,
            support_telegram: document.getElementById('supportTelegram').value,
            support_youtube: document.getElementById('supportYoutube').value,
            support_gmail: document.getElementById('supportGmail').value,
            custom_link_1: document.getElementById('customLink1').value,
            custom_link_2: document.getElementById('customLink2').value,
            custom_link_3: document.getElementById('customLink3').value,
            welcome_message: document.getElementById('welcomeMessage').value
        };
        
        const newPass = document.getElementById('newAdminPassword').value.trim();
        if (newPass) {
            try { await db.ref('adminPassword').set(newPass); document.getElementById('newAdminPassword').value = ''; }
            catch(e) { showToast('Password save failed','error'); return; }
        }
        try { 
            await db.ref('settings').set(data); 
            await db.ref('app_settings').update(appSettingsData); // User panel ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø
            showToast('Settings saved!'); 
        }
        catch(e) { showToast(e.message,'error'); }
    }

    // ============================================================
    // ======= RESULT SUBMISSION ‚Äî ‡¶õ‡¶¨‡¶ø‡¶∞ ‡¶Æ‡¶§‡¶® ‚úÖ =======
    // ============================================================

    async function loadPendingMatches() {
        const el = document.getElementById('resultsList');
        el.innerHTML = emptyState('‚è≥','Loading pending matches...');
        try {
            const snap = await db.ref('tournaments').once('value');
            const tournaments = snap.val() || {};
            const keys = Object.keys(tournaments);

            if (!keys.length) { el.innerHTML = emptyState('üìù','No matches found'); return; }

            // Filter: resultDeclared !== true (pending)
            const pending = keys.filter(tid => !tournaments[tid].resultDeclared);

            if (!pending.length) { el.innerHTML = emptyState('‚úÖ','All matches have been declared!'); return; }

            // Sort newest first
            pending.sort((a,b) => {
                const da = new Date(tournaments[a].dateTime||tournaments[a].createdDate||0).getTime();
                const db2 = new Date(tournaments[b].dateTime||tournaments[b].createdDate||0).getTime();
                return db2 - da;
            });

            let html = `<div class="result-table-wrap">
                <table class="result-table">
                    <thead>
                        <tr>
                            <th>Match Title</th>
                            <th>Date</th>
                            <th style="text-align:center">Joined</th>
                            <th style="text-align:center">Action</th>
                        </tr>
                    </thead>
                    <tbody>`;

            pending.forEach(tid => {
                const t = tournaments[tid];
                const dateStr = t.dateTime ? new Date(t.dateTime).toLocaleDateString('bn-BD') : '‚Äî';
                const joinedCount = t.participants
                    ? (typeof t.participants === 'object' ? Object.keys(t.participants).length : t.participants)
                    : 0;

                html += `<tr>
                    <td>
                        <div style="font-size:14px;font-weight:700;color:var(--text)">${t.title||'N/A'}</div>
                        <div style="font-size:11px;color:var(--text-muted);margin-top:2px">${t.category||t.gameType||'N/A'}</div>
                    </td>
                    <td style="color:var(--text-muted);font-size:13px">${dateStr}</td>
                    <td style="text-align:center"><span class="joined-badge">${joinedCount}</span></td>
                    <td style="text-align:center">
                        <button class="declare-btn" onclick="openDistributeModal('${tid}')">Declare</button>
                    </td>
                </tr>`;
            });

            html += `</tbody></table></div>`;
            el.innerHTML = html;

        } catch(e) {
            el.innerHTML = emptyState('‚ùå','Error loading matches');
            console.error(e);
        }
    }

    // ============================================================
    // ======= DISTRIBUTE PRIZES MODAL (‡¶õ‡¶¨‡¶ø‡¶∞ EXACT ‡¶Æ‡¶§‡¶®) =======
    // ============================================================

    async function openDistributeModal(tid) {
        try {
            const snap = await db.ref(`tournaments/${tid}`).once('value');
            const match = snap.val();
            if (!match) { showToast('Match not found','error'); return; }

            currentDistributeMatch = { tid, match };

            const tbody = document.getElementById('prizeTableBody');
            const hasParticipants = match.participants && typeof match.participants === 'object';
            const participantKeys = hasParticipants ? Object.keys(match.participants) : [];

            // Update table headers
            document.querySelector('#prizeTable thead tr').innerHTML = `
                <th>USER / TEAM</th>
                <th>UID</th>
                <th>KILLS</th>
                <th>WIN PRIZE</th>`;

            if (participantKeys.length === 0) {
                tbody.innerHTML = `<tr>
                    <td colspan="4" style="text-align:center;color:#aaa;padding:24px;font-size:14px;">
                        No participants joined yet.
                    </td>
                </tr>`;
            } else {
                let rows = '';
                for (const uid of participantKeys) {
                    const p = match.participants[uid];
                    const leaderEmail = p.userName || p.userId || uid;
                    const leaderUID = uid;
                    const players = p.players || [];

                    // Leader row ‚Äî kills & prize input ‡¶è‡¶ñ‡¶æ‡¶®‡ßá‡¶á
                    rows += `<tr style="background:rgba(0,0,0,0.03); border-top:2px solid #ddd;">
                        <td style="font-size:13px;font-weight:700;color:#111;">
                            üìß ${leaderEmail}
                        </td>
                        <td class="td-uid" style="font-size:11px;">${leaderUID}</td>
                        <td>
                            <input type="number" class="prize-input" id="kills_${uid}" min="0" value="0" placeholder="0">
                        </td>
                        <td>
                            <input type="number" class="prize-input" id="winprize_${uid}" min="0" value="0" placeholder="0" oninput="updateTeamPrizePreview('${uid}', ${players.length || 1})">
                        </td>
                    </tr>`;

                    // Team members ‚Äî ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶®‡¶æ‡¶Æ ‡¶ì game UID ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá
                    if (players.length > 0) {
                        players.forEach((pl, idx) => {
                            const pName = pl.playerName || pl.name || `Player ${idx+1}`;
                            const pGameId = pl.gameId || pl.uid || '-';
                            rows += `<tr id="teamrow_${uid}_${idx}" style="background:#f9f9f9;">
                                <td style="font-size:13px;color:#333;padding-left:28px;">
                                    üë§ ${pName}
                                </td>
                                <td class="td-uid" style="font-size:11px;color:#666;">${pGameId}</td>
                                <td style="text-align:center;color:#aaa;font-size:12px;">‚Äî</td>
                                <td id="memberprize_${uid}_${idx}" style="text-align:center;color:#888;font-size:13px;font-weight:600;">‚Äî</td>
                            </tr>`;
                        });
                    }

                    // Separator
                    rows += `<tr><td colspan="4" style="padding:4px;background:#fff;"></td></tr>`;
                }
                tbody.innerHTML = rows;
            }

            document.getElementById('distributePrizesModal').classList.add('open');

        } catch(e) {
            showToast('Error loading match','error');
            console.error(e);
        }
    }

    function updateTeamPrizePreview(uid, memberCount) {
        const prizeEl = document.getElementById(`winprize_${uid}`);
        const prize = parseInt(prizeEl?.value) || 0;
        const perMember = memberCount > 0 ? Math.floor(prize / memberCount) : prize;
        for (let i = 0; i < memberCount; i++) {
            const el = document.getElementById(`memberprize_${uid}_${i}`);
            if (el) el.textContent = prize > 0 ? perMember + '‡ß≥' : '‚Äî';
        }
    }

    function closeDistributeModal() {
        document.getElementById('distributePrizesModal').classList.remove('open');
        currentDistributeMatch = null;
    }

    async function submitDistributePrizes() {
        if (!canAdminMakeRequest('result')) {
            console.log('Result submission ignored - cooldown');
            return;
        }
        
        if (!currentDistributeMatch) { showToast('No match selected','error'); return; }
        if (!confirm('Are you sure? Prize will be sent to team leaders only.')) return;

        const { tid, match } = currentDistributeMatch;

        try {
            const hasParticipants = match.participants && typeof match.participants === 'object';
            const participantKeys = hasParticipants ? Object.keys(match.participants) : [];

            const updates = {};
            const winnerEntries = []; // Winner board ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø
            let totalDistributed = 0;

            for (const uid of participantKeys) {
                const killsEl = document.getElementById(`kills_${uid}`);
                const prizeEl = document.getElementById(`winprize_${uid}`);
                const kills = killsEl ? (parseInt(killsEl.value)||0) : 0;
                const prize = prizeEl ? (parseInt(prizeEl.value)||0) : 0;

                if (prize > 0 || kills > 0) {
                    const p = match.participants[uid];
                    const perKill = match.perKill || 0;
                    const killEarnings = kills * perKill;
                    const totalPrize = prize + killEarnings;
                    const players = p.players || [];
                    const memberCount = players.length || 1;
                    const prizePerMember = Math.floor(totalPrize / memberCount);

                    // ‚úÖ ‡¶™‡ßç‡¶∞‡¶§‡ßç‡¶Ø‡ßá‡¶ï team member ‡¶è‡¶∞ winning balance ‡¶Ü‡¶≤‡¶æ‡¶¶‡¶æ‡¶≠‡¶æ‡¶¨‡ßá update ‡¶ï‡¶∞‡¶æ ‡¶π‡¶¨‡ßá
                    // Leader ‡¶è‡¶∞ winning update
                    const leaderSnap = await db.ref(`users/${uid}`).once('value');
                    const leaderData = leaderSnap.val() || {};
                    updates[`users/${uid}/winning`] = (leaderData.winning || 0) + prizePerMember;
                    
                    // ‚úÖ Leader ‡¶è‡¶∞ transaction history ‡¶§‡ßá entry ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ
                    const leaderTxnId = `prize_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                    updates[`transactions/${uid}/${leaderTxnId}`] = {
                        type: 'Prize',
                        amount: prizePerMember,
                        status: 'Completed',
                        date: new Date().toLocaleDateString('bn-BD'),
                        timestamp: Date.now(),
                        matchTitle: match.title || 'Tournament',
                        kills: kills,
                        position: `Winner`
                    };
                    
                    // ‚úÖ ‡¶™‡ßç‡¶∞‡¶§‡ßç‡¶Ø‡ßá‡¶ï team member ‡¶è‡¶∞ winning update ‡¶è‡¶¨‡¶Ç transaction history
                    for (const player of players) {
                        const playerId = player.uid || player.userId;
                        if (playerId && playerId !== uid) {  // Leader already updated
                            const memberSnap = await db.ref(`users/${playerId}`).once('value');
                            const memberData = memberSnap.val() || {};
                            updates[`users/${playerId}/winning`] = (memberData.winning || 0) + prizePerMember;
                            
                            // ‚úÖ Member ‡¶è‡¶∞ transaction history ‡¶§‡ßá entry ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ
                            const memberTxnId = `prize_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                            updates[`transactions/${playerId}/${memberTxnId}`] = {
                                type: 'Prize',
                                amount: prizePerMember,
                                status: 'Completed',
                                date: new Date().toLocaleDateString('bn-BD'),
                                timestamp: Date.now(),
                                matchTitle: match.title || 'Tournament',
                                teamLeader: p.userName || uid,
                                position: `Winner (Team)`
                            };
                        }
                    }

                    // Winner board ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∏‡¶¨ ‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶ì prize per member
                    const teamMembers = players.map((pl, idx) => ({
                        name: pl.playerName || pl.name || `Player ${idx+1}`,
                        gameId: pl.gameId || pl.uid || '-',
                        userId: pl.uid || pl.userId || null,
                        prize: prizePerMember
                    }));

                    winnerEntries.push({
                        leaderUid: uid,
                        leaderId: uid,
                        leaderEmail: leaderData.email || p.userName || p.userId || uid,  // ‚úÖ Use real email from user database
                        leaderName: leaderData.username || leaderData.displayName || leaderData.name || p.userName || 'Unknown',  // ‚úÖ Also save name
                        kills,
                        winPrize: prize,
                        killEarnings,
                        totalPrize: prizePerMember,  // Per member prize (not total team prize)
                        teamMembers,
                        memberCount
                    });

                    totalDistributed += totalPrize;  // Total team prize for tracking
                }
            }

            // Sort by totalPrize descending
            winnerEntries.sort((a, b) => b.totalPrize - a.totalPrize);

            // Match result declared
            updates[`tournaments/${tid}/resultDeclared`] = true;
            updates[`tournaments/${tid}/resultDeclaredAt`] = Date.now();
            updates[`tournaments/${tid}/status`] = 'completed';

            // Winner board save
            updates[`winnerBoard/${tid}`] = {
                tournamentId: tid,
                matchTitle: match.title || 'N/A',
                matchType: match.category || match.gameType || 'N/A',
                declaredAt: Date.now(),
                totalDistributed,
                winners: winnerEntries,
                match: {
                    gameType: match.gameType || 'solo',
                    totalPrize: match.totalPrize || 0,
                    perKill: match.perKill || 0,
                    entryFee: match.entryFee || 0,
                    dateTime: match.dateTime || match.createdDate || Date.now()
                }
            };

            await db.ref().update(updates);

            const totalPrize = match.totalPrize || 0;
            await trackWinnerDeclaration(tid, match.title || 'Match', totalPrize);

            // Send winner notifications
            for (const w of winnerEntries) {
                const prize = w.totalPrize;
                const name = w.teamMembers?.[0]?.name || w.leaderEmail || 'Winner';
                await sendWinnerNotification(w.leaderUid, name, prize, 'winner');
            }
            alert('Results Distributed! Prize sent to team leaders.');
            closeDistributeModal();
            loadPendingMatches();
            loadDashboardData();
            loadWinnerBoard();

        } catch(e) {
            showToast('Error: ' + e.message, 'error');
            console.error(e);
        }
    }

    // ======= WINNER BOARD (‡¶õ‡¶¨‡¶ø‡¶∞ ‡¶Æ‡¶§ Design) =======
    async function loadWinnerBoard() {
        const el = document.getElementById('winnersList');
        el.innerHTML = emptyState('‚è≥','Loading...');
        try {
            const snap = await db.ref('winnerBoard').once('value');
            const data = snap.val() || {};
            if (!Object.keys(data).length) { el.innerHTML = emptyState('ü•á','No winners yet'); return; }

            const sorted = Object.entries(data).sort((a,b)=>(b[1].declaredAt||0)-(a[1].declaredAt||0));
            let html = '';
            
            sorted.forEach(([tournamentId, md]) => {
                const matchTitle = md.matchTitle || 'N/A';
                const matchType = md.matchType || 'N/A';
                const gameType = md.match?.gameType || 'solo';
                const totalDistributed = md.totalDistributed || 0;
                const declaredDate = new Date(md.declaredAt || Date.now());
                const dateStr = `Organised on ${declaredDate.getFullYear()}-${String(declaredDate.getMonth()+1).padStart(2,'0')}-${String(declaredDate.getDate()).padStart(2,'0')} at ${String(declaredDate.getHours()).padStart(2,'0')}:${String(declaredDate.getMinutes()).padStart(2,'0')}`;
                
                const winPrize = md.match?.totalPrize || 800;
                const perKill = md.match?.perKill || 0;
                const entryFee = md.match?.entryFee || 0;
                
                html += `<div class="winner-card">
                    <!-- Edit & Delete Buttons -->
                    <div class="winner-card-actions">
                        <button class="winner-action-btn winner-edit-btn" onclick="editWinnerEntry('${tournamentId}')" title="Edit">‚úèÔ∏è</button>
                        <button class="winner-action-btn winner-delete-btn" onclick="deleteWinnerEntry('${tournamentId}')" title="Delete">üóëÔ∏è</button>
                    </div>
                    
                    <!-- Card Header -->
                    <div class="winner-card-header">
                        <div class="winner-card-title">${matchTitle} üí•‚úÖ‚úÖ</div>
                        <div class="winner-card-date">${dateStr}</div>
                    </div>
                    
                    
                    <!-- Winners Section -->
                    <div class="winner-section-header">WINNER WINNER WINNER</div>
                    <div class="winner-list-header">
                        <div>#</div>
                        <div>Player Name</div>
                        <div style="text-align:center">Kills</div>
                        <div style="text-align:right">Winning</div>
                    </div>`;
                
                // WINNER SECTION ‚Äî ‡¶ñ‡¶æ‡¶Æ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡¶Ø‡¶º‡ßÄ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã
                if (md.winners && md.winners.length) {
                    // Game type ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßá ‡¶¨‡¶ø‡¶≠‡¶ø‡¶®‡ßç‡¶® ‡¶ñ‡¶æ‡¶Æ ‡¶§‡ßà‡¶∞‡¶ø
                    if (gameType.toLowerCase() === 'solo') {
                        // SOLO: ‡¶∂‡ßÅ‡¶ß‡ßÅ 1‡¶ü‡¶ø ‡¶ñ‡¶æ‡¶Æ, ‡¶∏‡¶∞‡ßç‡¶¨‡ßã‡¶ö‡ßç‡¶ö 5 ‡¶ú‡¶® ‡¶Ø‡¶æ‡¶∞‡¶æ prize ‡¶™‡¶æ‡¶¨‡ßá
                        const maxWinners = Math.min(5, md.winners.length);
                        const soloWinners = md.winners.slice(0, maxWinners);
                        
                        html += `<div class="winner-table-wrapper" style="border-color:#00e676;">
                            <div style="background:#00e676; color:#000; padding:12px; text-align:center; font-weight:800; font-size:16px;">Winner 1</div>
                            <div style="overflow-x:auto; -webkit-overflow-scrolling:touch;">
                                <div class="winner-list-header">
                                    <div>#</div>
                                    <div>PLAYER NAME</div>
                                    <div style="text-align:center">KILLS</div>
                                    <div style="text-align:right">WINNING</div>
                                </div>`;
                        
                        soloWinners.forEach((w, idx) => {
                            html += `<div class="winner-item">
                                <div class="winner-rank">${idx + 1}</div>
                                <div class="winner-name">${w.leaderEmail || 'N/A'}</div>
                                <div class="winner-kills">${w.kills || 0}</div>
                                <div class="winner-prize">${w.totalPrize || 0}‡ß≥</div>
                            </div>`;
                        });
                        
                        html += `</div></div>`;
                        
                    } else if (gameType.toLowerCase() === 'duo') {
                        // DUO: ‡¶Ø‡¶§ ‡¶ü‡¶ø‡¶Æ prize ‡¶™‡¶æ‡¶¨‡ßá, ‡¶§‡¶§ ‡¶ñ‡¶æ‡¶Æ (‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶ñ‡¶æ‡¶Æ‡ßá 2 ‡¶ú‡¶®)
                        md.winners.forEach((w, teamIdx) => {
                            html += `<div class="winner-table-wrapper" style="border-color:#1E90FF;">
                                <div style="background:#1E90FF; color:#fff; padding:12px; text-align:center; font-weight:800; font-size:16px;">Winner ${teamIdx + 1}</div>
                                <div style="overflow-x:auto; -webkit-overflow-scrolling:touch;">
                                    <div class="winner-list-header">
                                        <div>#</div>
                                        <div>PLAYER NAME</div>
                                        <div style="text-align:center">KILLS</div>
                                        <div style="text-align:right">WINNING</div>
                                    </div>`;
                            
                            if (w.teamMembers && w.teamMembers.length > 0) {
                                w.teamMembers.forEach((member, idx) => {
                                    html += `<div class="winner-item">
                                        <div class="winner-rank">${idx + 1}</div>
                                        <div class="winner-name">${member.name || 'N/A'}</div>
                                        <div class="winner-kills">${w.kills || 0}</div>
                                        <div class="winner-prize">${member.prize || 0}‡ß≥</div>
                                    </div>`;
                                });
                            }
                            
                            html += `</div></div>`;
                        });
                        
                    } else {
                        // SQUAD: ‡¶Ø‡¶§ ‡¶ü‡¶ø‡¶Æ prize ‡¶™‡¶æ‡¶¨‡ßá, ‡¶§‡¶§ ‡¶ñ‡¶æ‡¶Æ (‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶ñ‡¶æ‡¶Æ‡ßá 4 ‡¶ú‡¶®)
                        md.winners.forEach((w, teamIdx) => {
                            html += `<div class="winner-table-wrapper" style="border-color:#FFA500;">
                                <div style="background:#FFA500; color:#000; padding:12px; text-align:center; font-weight:800; font-size:16px;">Winner ${teamIdx + 1}</div>
                                <div style="overflow-x:auto; -webkit-overflow-scrolling:touch;">
                                    <div class="winner-list-header">
                                        <div>#</div>
                                        <div>PLAYER NAME</div>
                                        <div style="text-align:center">KILLS</div>
                                        <div style="text-align:right">WINNING</div>
                                    </div>`;
                            
                            if (w.teamMembers && w.teamMembers.length > 0) {
                                w.teamMembers.forEach((member, idx) => {
                                    html += `<div class="winner-item">
                                        <div class="winner-rank">${idx + 1}</div>
                                        <div class="winner-name">${member.name || 'N/A'}</div>
                                        <div class="winner-kills">${w.kills || 0}</div>
                                        <div class="winner-prize">${member.prize || 0}‡ß≥</div>
                                    </div>`;
                                });
                            }
                            
                            html += `</div></div>`;
                        });
                    }
                }
                
                html += `</div>`;
            });
            
            el.innerHTML = html;
        } catch(e) { 
            el.innerHTML = emptyState('‚ùå','Error'); 
            console.error(e);
        }
    }

    // ======= DELETE WINNER ENTRY =======
    async function deleteWinnerEntry(tournamentId) {
        if (!confirm('‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶Ø‡ßá ‡¶è‡¶á Winner Entry ‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?\n\n‡¶Æ‡¶®‡ßá ‡¶∞‡¶æ‡¶ñ‡¶¨‡ßá‡¶®: ‡¶è‡¶ü‡¶ø ‡¶∂‡ßÅ‡¶ß‡ßÅ Winner Board ‡¶•‡ßá‡¶ï‡ßá ‡¶Æ‡ßÅ‡¶õ‡¶¨‡ßá, User ‡¶¶‡ßá‡¶∞ wallet ‡¶•‡ßá‡¶ï‡ßá ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶ï‡¶æ‡¶ü‡¶¨‡ßá ‡¶®‡¶æ‡•§')) {
            return;
        }

        try {
            await db.ref(`winnerBoard/${tournamentId}`).remove();
            showToast('Winner entry deleted!', 'success');
            loadWinnerBoard();
        } catch(e) {
            showToast('Error: ' + e.message, 'error');
            console.error(e);
        }
    }

    // ======= EDIT WINNER ENTRY =======
    async function editWinnerEntry(tournamentId) {
        try {
            const snap = await db.ref(`winnerBoard/${tournamentId}`).once('value');
            const entry = snap.val();
            if (!entry) {
                showToast('Entry not found', 'error');
                return;
            }

            // Edit sheet ‡¶è data load ‡¶ï‡¶∞‡ßã
            document.getElementById('editWinnerTournamentId').value = tournamentId;
            document.getElementById('editMatchTitle').value = entry.matchTitle || '';
            document.getElementById('editMatchType').value = entry.matchType || '';
            document.getElementById('editWinPrize').value = entry.match?.totalPrize || 0;
            document.getElementById('editPerKill').value = entry.match?.perKill || 0;
            document.getElementById('editEntryFee').value = entry.match?.entryFee || 0;
            
            // Winners list ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßã
            const winnersContainer = document.getElementById('editWinnersList');
            winnersContainer.innerHTML = '';
            
            if (entry.winners && entry.winners.length) {
                entry.winners.forEach((w, i) => {
                    const winnerRow = document.createElement('div');
                    winnerRow.className = 'edit-winner-row';
                    winnerRow.innerHTML = `
                        <div style="display:grid; grid-template-columns:40px 1fr 80px 80px 40px; gap:8px; align-items:center; margin-bottom:10px; padding:10px; background:var(--bg-input); border-radius:8px;">
                            <div style="text-align:center; font-weight:700;">${i+1}</div>
                            <input type="text" class="input-field" value="${w.name || ''}" placeholder="Player Name" style="padding:8px; margin:0;">
                            <input type="number" class="input-field" value="${w.kills || 0}" placeholder="Kills" style="padding:8px; margin:0;">
                            <input type="number" class="input-field" value="${w.totalPrize || 0}" placeholder="Prize" style="padding:8px; margin:0;">
                            <button onclick="this.parentElement.parentElement.remove()" style="background:var(--danger); color:#fff; border:none; border-radius:6px; padding:8px; cursor:pointer; font-size:14px;">üóëÔ∏è</button>
                        </div>
                    `;
                    winnersContainer.appendChild(winnerRow);
                });
            }

            // Sheet ‡¶ñ‡ßã‡¶≤‡ßã
            openSheet('sheetEditWinner');

        } catch(e) {
            showToast('Error loading entry', 'error');
            console.error(e);
        }
    }

    // ======= ADD NEW WINNER ROW IN EDIT =======
    function addWinnerRowInEdit() {
        const winnersContainer = document.getElementById('editWinnersList');
        const currentRows = winnersContainer.querySelectorAll('.edit-winner-row').length;
        
        const winnerRow = document.createElement('div');
        winnerRow.className = 'edit-winner-row';
        winnerRow.innerHTML = `
            <div style="display:grid; grid-template-columns:40px 1fr 80px 80px 40px; gap:8px; align-items:center; margin-bottom:10px; padding:10px; background:var(--bg-input); border-radius:8px;">
                <div style="text-align:center; font-weight:700;">${currentRows + 1}</div>
                <input type="text" class="input-field" placeholder="Player Name" style="padding:8px; margin:0;">
                <input type="number" class="input-field" value="0" placeholder="Kills" style="padding:8px; margin:0;">
                <input type="number" class="input-field" value="0" placeholder="Prize" style="padding:8px; margin:0;">
                <button onclick="this.parentElement.parentElement.remove(); renumberWinners();" style="background:var(--danger); color:#fff; border:none; border-radius:6px; padding:8px; cursor:pointer; font-size:14px;">üóëÔ∏è</button>
            </div>
        `;
        winnersContainer.appendChild(winnerRow);
    }

    // ======= RENUMBER WINNERS AFTER DELETE =======
    function renumberWinners() {
        const rows = document.querySelectorAll('.edit-winner-row');
        rows.forEach((row, i) => {
            row.querySelector('div > div:first-child').textContent = i + 1;
        });
    }

    // ======= SAVE EDITED WINNER ENTRY =======
    async function saveEditedWinnerEntry() {
        const tournamentId = document.getElementById('editWinnerTournamentId').value;
        const matchTitle = document.getElementById('editMatchTitle').value.trim();
        const matchType = document.getElementById('editMatchType').value.trim();
        const winPrize = parseInt(document.getElementById('editWinPrize').value) || 0;
        const perKill = parseInt(document.getElementById('editPerKill').value) || 0;
        const entryFee = parseInt(document.getElementById('editEntryFee').value) || 0;

        if (!matchTitle) {
            showToast('Match Title ‡¶¶‡¶ø‡¶®', 'error');
            return;
        }

        // ===== ‡¶™‡ßÅ‡¶∞‡¶®‡ßã data ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßã comparison ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø =====
        let oldWinners = [];
        try {
            const oldSnap = await db.ref(`winnerBoard/${tournamentId}`).once('value');
            const oldEntry = oldSnap.val();
            if (oldEntry && oldEntry.winners) {
                oldWinners = oldEntry.winners;
            }
        } catch(e) {
            console.error('Error loading old winners:', e);
        }

        // ===== ‡¶®‡¶§‡ßÅ‡¶® winners collect ‡¶ï‡¶∞‡ßã =====
        const winners = [];
        const winnerRows = document.querySelectorAll('.edit-winner-row');
        let totalDistributed = 0;

        winnerRows.forEach(row => {
            const inputs = row.querySelectorAll('input');
            const name = inputs[0].value.trim();
            const kills = parseInt(inputs[1].value) || 0;
            const prize = parseInt(inputs[2].value) || 0;

            if (name && prize > 0) {
                winners.push({
                    name: name,
                    kills: kills,
                    totalPrize: prize,
                    winPrize: prize,
                    killEarnings: 0,
                    uid: 'manual'
                });
                totalDistributed += prize;
            }
        });

        if (winners.length === 0) {
            showToast('‡¶Ö‡¶®‡ßç‡¶§‡¶§ ‡¶è‡¶ï‡¶ú‡¶® winner ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®', 'error');
            return;
        }

        // Sort winners by prize
        winners.sort((a, b) => b.totalPrize - a.totalPrize);

        // ===== BALANCE ADJUSTMENT LOGIC =====
        // ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø winner ‡¶è‡¶∞ ‡¶™‡ßÅ‡¶∞‡¶®‡ßã ‡¶ì ‡¶®‡¶§‡ßÅ‡¶® prize compare ‡¶ï‡¶∞‡ßã
        try {
            for (let i = 0; i < winners.length; i++) {
                const newWinner = winners[i];
                const winnerName = newWinner.name;
                const newPrize = newWinner.totalPrize;

                // ‡¶™‡ßÅ‡¶∞‡¶®‡ßã winner list ‡¶è ‡¶è‡¶á ‡¶®‡¶æ‡¶Æ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßã
                const oldWinner = oldWinners.find(w => w.name === winnerName);
                const oldPrize = oldWinner ? (oldWinner.totalPrize || 0) : 0;

                // Prize difference calculate ‡¶ï‡¶∞‡ßã
                const prizeDiff = newPrize - oldPrize;

                if (prizeDiff !== 0) {
                    // ‡¶è‡¶á player ‡¶è‡¶∞ UID ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßã (‡¶Ø‡¶¶‡¶ø ‡¶•‡¶æ‡¶ï‡ßá)
                    let playerUid = oldWinner && oldWinner.uid && oldWinner.uid !== 'manual' ? oldWinner.uid : null;

                    // ‡¶Ø‡¶¶‡¶ø UID ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡ßá, ‡¶§‡¶æ‡¶π‡¶≤‡ßá users list ‡¶è name ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá search ‡¶ï‡¶∞‡ßã
                    if (!playerUid) {
                        const usersSnap = await db.ref('users').once('value');
                        const allUsers = usersSnap.val() || {};
                        
                        for (let uid in allUsers) {
                            const userData = allUsers[uid];
                            if (userData.username && userData.username.toLowerCase() === winnerName.toLowerCase()) {
                                playerUid = uid;
                                break;
                            }
                        }
                    }

                    // ‡¶Ø‡¶¶‡¶ø player ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º, balance adjust ‡¶ï‡¶∞‡ßã
                    if (playerUid) {
                        const userRef = db.ref(`users/${playerUid}`);
                        const userSnap = await userRef.once('value');
                        const userData = userSnap.val();
                        
                        if (userData) {
                            let currentWinning = parseInt(userData.winning) || 0;
                            
                            if (prizeDiff > 0) {
                                // Prize ‡¶¨‡ßá‡¶°‡¶º‡ßá‡¶õ‡ßá - ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶¶‡¶æ‡¶ì
                                currentWinning += prizeDiff;
                                await userRef.update({ winning: currentWinning });
                                console.log(`‚úÖ Added ${prizeDiff}‡ß≥ to ${winnerName} (${playerUid})`);
                            } else if (prizeDiff < 0) {
                                // Prize ‡¶ï‡¶Æ‡ßá‡¶õ‡ßá - ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶ï‡¶æ‡¶ü‡ßã
                                const amountToDeduct = Math.abs(prizeDiff);
                                
                                if (currentWinning >= amountToDeduct) {
                                    // Winning ‡¶•‡ßá‡¶ï‡ßá ‡¶ï‡¶æ‡¶ü‡ßã
                                    currentWinning -= amountToDeduct;
                                    await userRef.update({ winning: currentWinning });
                                    console.log(`üí∞ Deducted ${amountToDeduct}‡ß≥ from ${winnerName}'s winning`);
                                } else {
                                    // Winning ‡¶è ‡¶Ø‡¶•‡ßá‡¶∑‡ßç‡¶ü ‡¶®‡ßá‡¶á, deposit ‡¶•‡ßá‡¶ï‡ßá ‡¶ï‡¶æ‡¶ü‡ßã
                                    let currentDeposit = parseInt(userData.deposit) || 0;
                                    const remaining = amountToDeduct - currentWinning;
                                    
                                    currentWinning = 0;
                                    
                                    if (currentDeposit >= remaining) {
                                        currentDeposit -= remaining;
                                        await userRef.update({ 
                                            winning: currentWinning, 
                                            deposit: currentDeposit 
                                        });
                                        console.log(`üí∞ Deducted ${amountToDeduct}‡ß≥ from ${winnerName} (winning+deposit)`);
                                    } else {
                                        // Total balance ‡¶è ‡¶Ø‡¶•‡ßá‡¶∑‡ßç‡¶ü ‡¶®‡ßá‡¶á
                                        showToast(`‚ö†Ô∏è ${winnerName} ‡¶è‡¶∞ ‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü‡ßá ${amountToDeduct}‡ß≥ ‡¶ï‡¶æ‡¶ü‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ø‡¶•‡ßá‡¶∑‡ßç‡¶ü ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶®‡ßá‡¶á!`, 'warning');
                                        console.warn(`Insufficient balance for ${winnerName}`);
                                    }
                                }
                            }
                        }
                    } else {
                        console.log(`Player ${winnerName} not found in users database`);
                    }
                }
            }

            // ===== Winner Board Update ‡¶ï‡¶∞‡ßã =====
            const updatedEntry = {
                tournamentId: tournamentId,
                matchTitle: matchTitle,
                matchType: matchType,
                declaredAt: Date.now(),
                totalDistributed: totalDistributed,
                winners: winners,
                match: {
                    gameType: 'manual',
                    totalPrize: winPrize,
                    perKill: perKill,
                    entryFee: entryFee,
                    dateTime: Date.now()
                },
                manualEntry: true,
                lastEdited: Date.now() // Track ‡¶ï‡¶∞‡ßã ‡¶ï‡¶¨‡ßá edit ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá
            };

            await db.ref(`winnerBoard/${tournamentId}`).set(updatedEntry);
            showToast('‚úÖ Winner entry updated & balances adjusted!', 'success');
            closeSheet('sheetEditWinner');
            loadWinnerBoard();

        } catch(e) {
            showToast('Error: ' + e.message, 'error');
            console.error(e);
        }
    }

    // ======= OPEN MANUAL WINNER ENTRY =======
    function openManualWinnerEntry() {
        // Generate unique ID for manual entry
        const manualId = 'manual_' + Date.now();
        
        // Reset form
        document.getElementById('editWinnerTournamentId').value = manualId;
        document.getElementById('editMatchTitle').value = '';
        document.getElementById('editMatchType').value = '';
        document.getElementById('editWinPrize').value = '';
        document.getElementById('editPerKill').value = '0';
        document.getElementById('editEntryFee').value = '';
        
        // Clear winners list and add one default row
        const winnersContainer = document.getElementById('editWinnersList');
        winnersContainer.innerHTML = `
            <div class="edit-winner-row">
                <div style="display:grid; grid-template-columns:40px 1fr 80px 80px 40px; gap:8px; align-items:center; margin-bottom:10px; padding:10px; background:var(--bg-input); border-radius:8px;">
                    <div style="text-align:center; font-weight:700;">1</div>
                    <input type="text" class="input-field" placeholder="Player Name" style="padding:8px; margin:0;">
                    <input type="number" class="input-field" value="0" placeholder="Kills" style="padding:8px; margin:0;">
                    <input type="number" class="input-field" value="0" placeholder="Prize" style="padding:8px; margin:0;">
                    <button onclick="this.parentElement.parentElement.remove(); renumberWinners();" style="background:var(--danger); color:#fff; border:none; border-radius:6px; padding:8px; cursor:pointer; font-size:14px;">üóëÔ∏è</button>
                </div>
            </div>
        `;
        
        // Change sheet title
        document.querySelector('#sheetEditWinner .sheet-title').textContent = 'Add Manual Winner Entry';
        
        // Open sheet
        openSheet('sheetEditWinner');
    }

    // Enter key login
    document.getElementById('loginPassword').addEventListener('keypress', e => { if(e.key==='Enter') doLogin(); });

    // Tournament create button override
    const _tbtn = document.querySelector('[onclick="openSheet(\'sheetTournament\'); loadCategoriesForSelect()"]');
    if (_tbtn) _tbtn.onclick = null;
    document.querySelector('.sec-header .btn-add') && null; // handled below

    // ============================================================
    // ======= ANALYTICS FUNCTIONS =======
    // ============================================================

    // Initialize date selectors with today's date
    function initDateSelectors() {
        const today = new Date().toISOString().split('T')[0];
        const analyticsDate = document.getElementById('analyticsDateSelector');
        const earningDate = document.getElementById('earningDateSelector');
        if (analyticsDate) {
            analyticsDate.value = today;
            analyticsDate.max = today; // Can't select future dates
        }
        if (earningDate) {
            earningDate.value = today;
            earningDate.max = today;
        }
    }

    // Load Analytics for Dashboard
    async function loadAnalytics() {
        if (!db) return;
        const selectedDate = document.getElementById('analyticsDateSelector').value;
        if (!selectedDate) return;

        try {
            // Get analytics data for selected date
            const analyticsRef = db.ref(`analytics/daily/${selectedDate}`);
            const snap = await analyticsRef.once('value');
            const data = snap.val() || { depositAccepted: 0, withdrawAccepted: 0 };

            // Update UI
            document.getElementById('totalDepositAccepted').textContent = (data.depositAccepted || 0) + '‡ß≥';
            document.getElementById('totalWithdrawAccepted').textContent = (data.withdrawAccepted || 0) + '‡ß≥';

        } catch(e) {
            console.error('Error loading analytics:', e);
        }
    }

    // Track Deposit Accept
    async function trackDepositAccept(amount) {
        const today = new Date().toISOString().split('T')[0];
        try {
            const analyticsRef = db.ref(`analytics/daily/${today}`);
            const snap = await analyticsRef.once('value');
            const current = snap.val() || { depositAccepted: 0, withdrawAccepted: 0 };
            
            await analyticsRef.update({
                depositAccepted: (current.depositAccepted || 0) + amount
            });
            
            // Reload if on dashboard
            if (document.getElementById('sec-dashboard').classList.contains('active')) {
                loadAnalytics();
            }
            
            // ‚úÖ Reload Total Earning (automatic calculation)
            loadTotalEarning();
        } catch(e) {
            console.error('Error tracking deposit:', e);
        }
    }

    // Track Withdraw Accept
    async function trackWithdrawAccept(amount) {
        const today = new Date().toISOString().split('T')[0];
        try {
            const analyticsRef = db.ref(`analytics/daily/${today}`);
            const snap = await analyticsRef.once('value');
            const current = snap.val() || { depositAccepted: 0, withdrawAccepted: 0 };
            
            await analyticsRef.update({
                withdrawAccepted: (current.withdrawAccepted || 0) + amount
            });
            
            // Reload if on dashboard
            if (document.getElementById('sec-dashboard').classList.contains('active')) {
                loadAnalytics();
            }
            
            // ‚úÖ Reload Total Earning (automatic calculation)
            loadTotalEarning();
        } catch(e) {
            console.error('Error tracking withdraw:', e);
        }
    }

    // Initialize Earning Section
    function initEarningSection() {
        initDateSelectors();
        loadEarningData();
    }

    // Load Earning Data
    async function loadEarningData() {
        const selectedDate = document.getElementById('earningDateSelector').value;
        if (!selectedDate) return;

        try {
            // Get earning data for selected date
            const earningRef = db.ref(`analytics/earning/${selectedDate}`);
            const snap = await earningRef.once('value');
            const data = snap.val() || { entryFee: 0, winningPrize: 0, matches: [] };

            const entryFee = data.entryFee || 0;
            const winningPrize = data.winningPrize || 0;
            const netEarning = entryFee - winningPrize;
            const profitMargin = entryFee > 0 ? ((netEarning / entryFee) * 100).toFixed(1) : 0;

            // Update UI
            document.getElementById('totalEntryFee').textContent = entryFee + '‡ß≥';
            document.getElementById('totalWinningPrize').textContent = winningPrize + '‡ß≥';
            document.getElementById('netEarning').textContent = netEarning + '‡ß≥';
            
            // Update color based on profit/loss
            const earningDiv = document.getElementById('netEarning');
            if (netEarning >= 0) {
                earningDiv.style.color = 'var(--success)';
                document.getElementById('earningPercentage').textContent = `Profit Margin: ${profitMargin}%`;
            } else {
                earningDiv.style.color = 'var(--danger)';
                document.getElementById('earningPercentage').textContent = `Loss: ${Math.abs(profitMargin)}%`;
            }

            // Show breakdown
            showEarningBreakdown(data.matches || []);

        } catch(e) {
            console.error('Error loading earning data:', e);
        }
    }

    // Show Earning Breakdown
    function showEarningBreakdown(matches) {
        const container = document.getElementById('earningBreakdown');
        
        if (!matches || matches.length === 0) {
            container.innerHTML = '<div style="text-align:center; color:var(--text-muted); padding:20px;">No matches on this date</div>';
            return;
        }

        let html = '';
        matches.forEach((match, index) => {
            const profit = match.entryFee - match.winningPrize;
            const profitColor = profit >= 0 ? 'var(--success)' : 'var(--danger)';
            
            html += `
            <div style="padding:12px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <div style="font-size:13px; font-weight:600; color:var(--text);">${match.title || 'Match ' + (index + 1)}</div>
                    <div style="font-size:11px; color:var(--text-muted); margin-top:2px;">
                        Entry: ${match.entryFee}‡ß≥ | Prize: ${match.winningPrize}‡ß≥
                    </div>
                </div>
                <div style="font-size:14px; font-weight:700; color:${profitColor};">
                    ${profit >= 0 ? '+' : ''}${profit}‡ß≥
                </div>
            </div>`;
        });
        
        container.innerHTML = html;
    }

    // Track Match Join (Entry Fee)
    async function trackMatchJoin(matchId, matchTitle, entryFee, teamSize) {
        const today = new Date().toISOString().split('T')[0];
        const totalEntryFee = entryFee * teamSize;
        
        try {
            const earningRef = db.ref(`analytics/earning/${today}`);
            const snap = await earningRef.once('value');
            const current = snap.val() || { entryFee: 0, winningPrize: 0, matches: [] };
            
            // Update total entry fee
            const newEntryFee = (current.entryFee || 0) + totalEntryFee;
            
            // Find or create match entry
            let matches = current.matches || [];
            let matchEntry = matches.find(m => m.matchId === matchId);
            
            if (matchEntry) {
                matchEntry.entryFee += totalEntryFee;
                matchEntry.participants += teamSize;
            } else {
                matches.push({
                    matchId: matchId,
                    title: matchTitle,
                    entryFee: totalEntryFee,
                    winningPrize: 0,
                    participants: teamSize,
                    timestamp: Date.now()
                });
            }
            
            await earningRef.update({
                entryFee: newEntryFee,
                matches: matches
            });
            
        } catch(e) {
            console.error('Error tracking match join:', e);
        }
    }

    // Track Winner Declaration (Winning Prize)
    async function trackWinnerDeclaration(matchId, matchTitle, totalPrize) {
        const today = new Date().toISOString().split('T')[0];
        
        try {
            const earningRef = db.ref(`analytics/earning/${today}`);
            const snap = await earningRef.once('value');
            const current = snap.val() || { entryFee: 0, winningPrize: 0, matches: [] };
            
            // Update total winning prize
            const newWinningPrize = (current.winningPrize || 0) + totalPrize;
            
            // Find match entry
            let matches = current.matches || [];
            let matchEntry = matches.find(m => m.matchId === matchId);
            
            if (matchEntry) {
                matchEntry.winningPrize = totalPrize;
            } else {
                // Match not found, create new entry
                matches.push({
                    matchId: matchId,
                    title: matchTitle,
                    entryFee: 0,
                    winningPrize: totalPrize,
                    participants: 0,
                    timestamp: Date.now()
                });
            }
            
            await earningRef.update({
                winningPrize: newWinningPrize,
                matches: matches
            });
            
            // Reload if on earning section
            if (document.getElementById('sec-earning').classList.contains('active')) {
                loadEarningData();
            }
            
        } catch(e) {
            console.error('Error tracking winner declaration:', e);
        }
    }

    // Initialize on dashboard load
    document.addEventListener('DOMContentLoaded', () => {
        initDateSelectors();
        // loadAnalytics and initWalletSummary need Firebase - called after login
    });

</script>
<script>
    // ===== WINNER NOTIFICATION =====
    async function sendWinnerNotification(uid, name, prize, type) {
        let message = '';
        if (type === 'custom') {
            message = prompt(`${name} ‡¶ï‡ßá ‡¶ï‡ßÄ message ‡¶™‡¶æ‡¶†‡¶æ‡¶¨‡ßá‡¶®?`);
            if (!message) return;
        } else {
            message = `üèÜ ‡¶Ö‡¶≠‡¶ø‡¶®‡¶®‡ßç‡¶¶‡¶® ${name}! ‡¶Ü‡¶™‡¶®‡¶ø ‡ß≥${prize} prize ‡¶™‡ßá‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡¶®!`;
        }
        try {
            await db.ref(`notifications/${uid}`).push({
                message,
                timestamp: Date.now(),
                read: false,
                type: type === 'custom' ? 'admin' : 'winner'
            });
            showToast('‚úÖ Notification ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!');
        } catch(e) { showToast('Error: ' + e.message, 'error'); }
    }

    // ===== BROADCAST =====
    async function sendBroadcast() {
        const msg = document.getElementById('broadcastMsg')?.value?.trim();
        if (!msg) { showToast('Message ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®!'); return; }
        if (!confirm('‡¶∏‡¶¨ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶ï‡ßá ‡¶è‡¶á message ‡¶™‡¶æ‡¶†‡¶æ‡¶¨‡ßá‡¶®?\n\n"' + msg + '"')) return;

        try {
            await db.ref('broadcast').set({
                message: msg,
                timestamp: Date.now(),
                sentAt: new Date().toLocaleString('bn-BD')
            });
            document.getElementById('broadcastMsg').value = '';
            const preview = document.getElementById('lastBroadcastPreview');
            if (preview) preview.textContent = '‚úÖ ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá: ' + msg.substring(0, 50) + (msg.length > 50 ? '...' : '');
            showToast('‚úÖ Broadcast ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!');
        } catch(e) {
            showToast('Error: ' + e.message, 'error');
        }
    }

    // Load last broadcast on notifications section open
    window.addEventListener('load', () => {
        if (!db) return;
        db.ref('broadcast').once('value').then(snap => {
            const data = snap.val();
            const preview = document.getElementById('lastBroadcastPreview');
            if (data && data.message && preview) {
                preview.textContent = '‡¶∂‡ßá‡¶∑ message: ' + data.message.substring(0, 60) + (data.message.length > 60 ? '...' : '');
            }
        }).catch(() => {});
    });

    // ===== AUTO REFUND =====
    async function processAutoRefund() {
        const tidInput = document.getElementById('refundTournamentId');
        const tid = tidInput?.value?.trim();
        if (!tid) { showToast('Tournament ID ‡¶¶‡¶ø‡¶®!'); return; }

        const statusEl = document.getElementById('refundStatus');
        if (statusEl) statusEl.textContent = '‚è≥ Processing...';

        try {
            const snap = await db.ref(`tournaments/${tid}`).once('value');
            const match = snap.val();
            if (!match) { showToast('Tournament ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø!', 'error'); if(statusEl) statusEl.textContent = '‚ùå Tournament ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø'; return; }

            const participants = match.participants || {};
            const participantKeys = Object.keys(participants);
            if (participantKeys.length === 0) { showToast('‡¶ï‡ßã‡¶®‡ßã participant ‡¶®‡ßá‡¶á'); if(statusEl) statusEl.textContent = '‚ö†Ô∏è ‡¶ï‡ßã‡¶®‡ßã participant ‡¶®‡ßá‡¶á'; return; }

            const entryFee = match.entryFee || 0;
            if (!confirm(`"${match.title}" cancel ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?\n${participantKeys.length} ‡¶ú‡¶®‡¶ï‡ßá ${entryFee}‡ß≥ ‡¶ï‡¶∞‡ßá ‡¶´‡ßá‡¶∞‡¶§ ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ ‡¶π‡¶¨‡ßá‡•§`)) return;

            const updates = {};
            let refundCount = 0;

            for (const uid of participantKeys) {
                const uSnap = await db.ref(`users/${uid}`).once('value');
                const u = uSnap.val() || {};
                const currentDeposit = u.deposit || 0;
                updates[`users/${uid}/deposit`] = currentDeposit + entryFee;
                refundCount++;
            }

            // Mark tournament as cancelled
            updates[`tournaments/${tid}/status`] = 'cancelled';
            updates[`tournaments/${tid}/cancelledAt`] = Date.now();

            await db.ref().update(updates);

            if (statusEl) statusEl.textContent = `‚úÖ ${refundCount} ‡¶ú‡¶®‡¶ï‡ßá ${entryFee}‡ß≥ ‡¶ï‡¶∞‡ßá ‡¶´‡ßá‡¶∞‡¶§ ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!`;
            if (tidInput) tidInput.value = '';
            showToast(`‚úÖ ${refundCount} ‡¶ú‡¶®‡¶ï‡ßá refund ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!`);
            loadDashboardData();

        } catch(e) {
            if (statusEl) statusEl.textContent = '‚ùå Error: ' + e.message;
            showToast('Error: ' + e.message, 'error');
        }
    }

    // ===== WALLET SUMMARY LOGIC =====

    function initWalletSummary() {
        // Set today's date as default
        const today = new Date().toISOString().split('T')[0];
        const dateInput = document.getElementById('ws-date');
        if (dateInput) {
            dateInput.value = today;
            loadWalletSummaryForDate();
        }
        // Load total earning from Firebase
        loadTotalEarning();
    }

    function getWalletKey(dateStr) {
        return 'walletSummary/' + dateStr.replace(/-/g, '_');
    }

    function loadWalletSummaryForDate() {
        if (!db) return;
        const dateInput = document.getElementById('ws-date');
        if (!dateInput || !dateInput.value) return;
        const key = getWalletKey(dateInput.value);

        // Load data from Firebase - auto-populate deposit/withdraw from requests
        loadDepositWithdrawForDate(dateInput.value);

        db.ref(key).once('value').then(snap => {
            const data = snap.val();
            if (data) {
                // Deposit and Withdraw will be auto-loaded, but allow manual override if saved
                if(data.deposit !== undefined) document.getElementById('ws-deposit').value = data.deposit;
                if(data.withdraw !== undefined) document.getElementById('ws-withdraw').value = data.withdraw;
                document.getElementById('ws-past-bkash').value = data.pastBkash || '';
                document.getElementById('ws-past-nagad').value = data.pastNagad || '';
            } else {
                document.getElementById('ws-past-bkash').value = '';
                document.getElementById('ws-past-nagad').value = '';
            }
            calcWalletResult();
        }).catch(() => {
            // Firebase not available - try localStorage fallback
            const saved = localStorage.getItem('ws_' + dateInput.value);
            if (saved) {
                const data = JSON.parse(saved);
                document.getElementById('ws-deposit').value  = data.deposit  || '';
                document.getElementById('ws-withdraw').value = data.withdraw || '';
                document.getElementById('ws-past-bkash').value = data.pastBkash || '';
                document.getElementById('ws-past-nagad').value = data.pastNagad || '';
            } else {
                clearWalletFields();
            }
            calcWalletResult();
        });
    }
    
    // Auto-load deposit and withdraw amounts from requests for the selected date
    async function loadDepositWithdrawForDate(dateStr) {
        try {
            const depositsSnap = await db.ref('depositRequests').once('value');
            const withdrawsSnap = await db.ref('withdrawRequests').once('value');
            
            let totalDeposit = 0;
            let totalWithdraw = 0;
            
            // Sum approved deposits for this date
            if(depositsSnap.exists()) {
                depositsSnap.forEach(childSnap => {
                    const req = childSnap.val();
                    if(req.status === 'approved') {
                        const timestamp = req.processedAt || req.approvedDate;
                        if(timestamp) {
                            const reqDate = new Date(timestamp).toISOString().split('T')[0];
                            if(reqDate === dateStr) {
                                totalDeposit += parseFloat(req.amount) || 0;
                            }
                        }
                    }
                });
            }
            
            // Sum approved withdraws for this date
            if(withdrawsSnap.exists()) {
                withdrawsSnap.forEach(childSnap => {
                    const req = childSnap.val();
                    if(req.status === 'approved') {
                        const timestamp = req.processedAt || req.approvedDate;
                        if(timestamp) {
                            const reqDate = new Date(timestamp).toISOString().split('T')[0];
                            if(reqDate === dateStr) {
                                totalWithdraw += parseFloat(req.amount) || 0;
                            }
                        }
                    }
                });
            }
            
            document.getElementById('ws-deposit').value = totalDeposit || '';
            document.getElementById('ws-withdraw').value = totalWithdraw || '';
            
        } catch(e) {
            console.error('Error loading deposit/withdraw data:', e);
        }
    }

    function saveWalletSummary() {
        const dateInput = document.getElementById('ws-date');
        if (!dateInput || !dateInput.value) { showToast('‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®!'); return; }

        const deposit = parseFloat(document.getElementById('ws-deposit').value) || 0;
        const withdraw = parseFloat(document.getElementById('ws-withdraw').value) || 0;
        const pastBkash = parseFloat(document.getElementById('ws-past-bkash').value) || 0;
        const pastNagad = parseFloat(document.getElementById('ws-past-nagad').value) || 0;
        
        const result = pastBkash + pastNagad + deposit - withdraw;
        const todayProfit = deposit - withdraw;

        const data = {
            deposit,
            withdraw,
            pastBkash,
            pastNagad,
            result,
            todayProfit,
            savedAt: new Date().toISOString()
        };

        const key = getWalletKey(dateInput.value);

        db.ref(key).set(data).then(() => {
            showToast('‚úÖ ' + dateInput.value + ' ‡¶è‡¶∞ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!');
            
            // Update Total Earning (cumulative)
            updateTotalEarning(todayProfit);
        }).catch(() => {
            // localStorage fallback
            localStorage.setItem('ws_' + dateInput.value, JSON.stringify(data));
            showToast('‚úÖ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!');
        });
    }

    function calcWalletResult() {
        const deposit = parseFloat(document.getElementById('ws-deposit')?.value) || 0;
        const withdraw = parseFloat(document.getElementById('ws-withdraw')?.value) || 0;
        const pastBkash = parseFloat(document.getElementById('ws-past-bkash')?.value) || 0;
        const pastNagad = parseFloat(document.getElementById('ws-past-nagad')?.value) || 0;

        const result = pastBkash + pastNagad + deposit - withdraw;

        const resultEl = document.getElementById('ws-result-value');
        const diffEl   = document.getElementById('ws-result-diff');

        if (resultEl) {
            resultEl.textContent = result.toLocaleString('bn-BD') + '‡ß≥';
            resultEl.style.color = result >= 0 ? 'var(--primary)' : '#ff1744';
        }

        // Compare with actual balance
        if (diffEl && balance > 0) {
            const diff = balance - result;
            if (diff === 0) {
                diffEl.innerHTML = '‚úÖ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ ‡¶Æ‡¶ø‡¶≤‡ßá‡¶õ‡ßá ‚Äî Total Balance = ‡¶´‡¶≤‡¶æ‡¶´‡¶≤';
                diffEl.style.color = '#00e676';
            } else if (diff > 0) {
                diffEl.innerHTML = '‚¨ÜÔ∏è ' + Math.abs(diff).toLocaleString('bn-BD') + '‡ß≥ ‡¶¨‡ßá‡¶∂‡¶ø ‡¶Ü‡¶õ‡ßá ‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂/‡¶®‡¶ó‡¶¶‡ßá';
                diffEl.style.color = '#ffab00';
            } else {
                diffEl.innerHTML = '‚¨áÔ∏è ' + Math.abs(diff).toLocaleString('bn-BD') + '‡ß≥ ‡¶ï‡¶Æ ‡¶Ü‡¶õ‡ßá ‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂/‡¶®‡¶ó‡¶¶‡ßá';
                diffEl.style.color = '#ff1744';
            }
        } else if (diffEl) {
            diffEl.textContent = 'Past Balance + Deposit - Withdraw';
            diffEl.style.color = 'var(--text-muted)';
        }

        updateEarningPreview();
        return result;
    }

    function clearWalletFields() {
        ['ws-deposit','ws-withdraw','ws-past-bkash','ws-past-nagad'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.value = '';
        });
        calcWalletResult();
    }

    async function loadTotalEarning() {
        try {
            // ‚úÖ Calculate Total Earning from all-time analytics data
            const analyticsSnap = await db.ref('analytics/daily').once('value');
            const dailyData = analyticsSnap.val() || {};
            
            let totalDepositAccepted = 0;
            let totalWithdrawAccepted = 0;
            
            // Sum up all daily deposit and withdraw accepted amounts
            for (let date in dailyData) {
                const dayData = dailyData[date];
                totalDepositAccepted += (dayData.depositAccepted || 0);
                totalWithdrawAccepted += (dayData.withdrawAccepted || 0);
            }
            
            // Calculate earning: Deposit - Withdraw
            const totalEarning = totalDepositAccepted - totalWithdrawAccepted;
            
            // Update UI
            const earningEl = document.getElementById('ws-total-earning');
            const depositEl = document.getElementById('ws-total-deposit-lifetime');
            const withdrawEl = document.getElementById('ws-total-withdraw-lifetime');
            const resultEl = document.getElementById('ws-earning-result');
            
            if (earningEl) earningEl.textContent = totalEarning.toLocaleString('bn-BD') + '‡ß≥';
            if (depositEl) depositEl.textContent = totalDepositAccepted.toLocaleString('bn-BD') + '‡ß≥';
            if (withdrawEl) withdrawEl.textContent = totalWithdrawAccepted.toLocaleString('bn-BD') + '‡ß≥';
            if (resultEl) resultEl.textContent = totalEarning.toLocaleString('bn-BD') + '‡ß≥';
            
        } catch(e) {
            console.error('Error loading total earning:', e);
            const el = document.getElementById('ws-total-earning');
            if (el) el.textContent = '0‡ß≥';
        }
    }

    // ---- Edit / Delete wallet day summary ----
    function editWalletSummary() {
        const dateInput = document.getElementById('ws-date');
        if (!dateInput || !dateInput.value) { showToast('‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®!'); return; }
        // Fields are already loaded ‚Äî just let admin change values and save again
        showToast('‚úèÔ∏è ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶§‡¶æ‡¶∞‡¶™‡¶∞ ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ö‡¶æ‡¶™‡ßÅ‡¶®');
        document.getElementById('ws-deposit').focus();
    }

    function deleteWalletSummary() {
        const dateInput = document.getElementById('ws-date');
        if (!dateInput || !dateInput.value) { showToast('‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®!'); return; }
        if (!confirm(dateInput.value + ' ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ‡ßá‡¶∞ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶¨‡ßá‡¶®?')) return;
        const key = getWalletKey(dateInput.value);
        db.ref(key).remove().then(() => {
            clearWalletFields();
            showToast('üóëÔ∏è ' + dateInput.value + ' ‡¶è‡¶∞ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!');
        }).catch(() => {
            localStorage.removeItem('ws_' + dateInput.value);
            clearWalletFields();
            showToast('üóëÔ∏è ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!');
        });
    }

    // ---- Total Earning functions ----
    function showEarningEdit() {
        const panel = document.getElementById('ws-earning-edit-panel');
        if (panel) panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    }

    function applyEarningEdit() {
        const input = document.getElementById('ws-earning-edit-input');
        const val = parseFloat(input?.value);
        if (isNaN(val) || val < 0) { showToast('‡¶∏‡¶†‡¶ø‡¶ï ‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®!'); return; }
        setTotalEarning(val, () => {
            document.getElementById('ws-earning-edit-panel').style.display = 'none';
            if (input) input.value = '';
            showToast('‚úÖ Total Earning ‡¶è‡¶°‡¶ø‡¶ü ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!');
        });
    }

    function resetTotalEarning() {
        if (!confirm('Total Earning ‡¶∂‡ßÇ‡¶®‡ßç‡¶Ø ‡¶ï‡¶∞‡ßá ‡¶¶‡ßá‡¶¨‡ßá‡¶®?')) return;
        setTotalEarning(0, () => showToast('üóëÔ∏è Total Earning ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!'));
    }

    function addResultToEarning() {
        const result = calcWalletResult();
        if (result === 0) { showToast('‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶∂‡ßÇ‡¶®‡ßç‡¶Ø ‚Äî ‡¶Ü‡¶ó‡ßá ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®!'); return; }
        db.ref('walletTotalEarning').once('value').then(snap => {
            const current = parseFloat(snap.val()) || 0;
            const newTotal = current + result;
            if (!confirm('‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ' + result.toLocaleString() + '‡ß≥ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?\n‡¶®‡¶§‡ßÅ‡¶® ‡¶Æ‡ßã‡¶ü: ' + newTotal.toLocaleString() + '‡ß≥')) return;
            setTotalEarning(newTotal, () => showToast('‚úÖ ' + result.toLocaleString() + '‡ß≥ ‡¶Ø‡ßã‡¶ó ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!'));
        }).catch(() => {
            const current = parseFloat(localStorage.getItem('ws_total_earning')) || 0;
            const newTotal = current + result;
            if (!confirm('‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ' + result.toLocaleString() + '‡ß≥ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?\n‡¶®‡¶§‡ßÅ‡¶® ‡¶Æ‡ßã‡¶ü: ' + newTotal.toLocaleString() + '‡ß≥')) return;
            setTotalEarning(newTotal, () => showToast('‚úÖ ' + result.toLocaleString() + '‡ß≥ ‡¶Ø‡ßã‡¶ó ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!'));
        });
    }

    function setTotalEarning(val, callback) {
        db.ref('totalEarning').set(val).then(() => {
            refreshEarningDisplay(val);
            if (callback) callback();
        }).catch(() => {
            localStorage.setItem('ws_total_earning', val);
            refreshEarningDisplay(val);
            if (callback) callback();
        });
    }

    function refreshEarningDisplay(val) {
        const el = document.getElementById('ws-total-earning');
        if (el) el.textContent = parseFloat(val).toLocaleString('bn-BD') + '‡ß≥';
        updateEarningPreview();
    }

    function updateEarningPreview() {
        const result = calcWalletResult();
        const previewEl = document.getElementById('ws-earning-preview');
        const newTotalEl = document.getElementById('ws-earning-new-total');
        if (previewEl) previewEl.textContent = result.toLocaleString('bn-BD') + '‡ß≥';
        if (newTotalEl) {
            db.ref('walletTotalEarning').once('value').then(snap => {
                const current = parseFloat(snap.val()) || 0;
                newTotalEl.textContent = (current + result).toLocaleString('bn-BD') + '‡ß≥';
            }).catch(() => {
                const current = parseFloat(localStorage.getItem('ws_total_earning')) || 0;
                newTotalEl.textContent = (current + result).toLocaleString('bn-BD') + '‡ß≥';
            });
        }
    }

    function updateTotalEarning(todayProfit) {
        // Add today's profit to cumulative Total Earning
        db.ref('totalEarning').once('value').then(snap => {
            const currentTotal = snap.val() || 0;
            const newTotal = currentTotal + todayProfit;
            
            db.ref('totalEarning').set(newTotal).then(() => {
                document.getElementById('ws-total-earning').textContent = newTotal.toLocaleString('bn-BD') + '‡ß≥';
                showToast(`üí∞ Total Earning ‡¶Ü‡¶™‡¶°‡ßá‡¶ü: +${todayProfit}‡ß≥`);
            });
        }).catch(e => {
            console.error('Error updating total earning:', e);
        });
    }

    // Load wallet summary when section is opened
    const _origShowSection = window.showSection;
    document.addEventListener('DOMContentLoaded', () => {
        // Patch showSection to init wallet when navigated to
        const origShow = window.showSection;
        if (origShow) {
            window.showSection = function(id, navBtn) {
                origShow(id, navBtn);
                if (id === 'wallet-summary') {
                    initWalletSummary();
                }
            };
        }
    });

    // ======= IMAGE VIEWER FUNCTIONS =======
    function viewScreenshot(base64Data, title = 'Payment Screenshot') {
        const overlay = document.getElementById('imageViewerOverlay');
        const img = document.getElementById('imageViewerImg');
        const titleEl = document.getElementById('imageViewerTitle');
        
        img.src = base64Data;
        titleEl.textContent = title;
        overlay.classList.add('active');
        
        // Prevent body scroll
        document.body.style.overflow = 'hidden';
    }
    
    function closeImageViewer(event) {
        // Only close if clicking overlay (not the image itself)
        if (event && event.target.className !== 'image-viewer-overlay') {
            return;
        }
        
        const overlay = document.getElementById('imageViewerOverlay');
        overlay.classList.remove('active');
        
        // Restore body scroll
        document.body.style.overflow = '';
    }
    

</script>
<script>
    // Tournament "Create" button ‡¶ï‡ßá openCreateTournament ‡¶è point ‡¶ï‡¶∞‡ßã
    document.addEventListener('DOMContentLoaded', () => {
        const sec = document.getElementById('sec-tournaments');
        if (sec) {
            const btn = sec.querySelector('.btn-add');
            if (btn) btn.onclick = openCreateTournament;
        }
    });

    // ==================== ENHANCED USER MANAGEMENT FEATURES ====================
    
    // Enhanced Ban with Reason
    function showBanUserModal(userId, userName) {
        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:9999;padding:20px;';
        modal.innerHTML = `
            <div style="background:var(--bg-card);border-radius:16px;padding:24px;max-width:450px;width:100%;">
                <h3 style="color:var(--danger);margin-bottom:16px;font-size:18px;">
                    <i class="fas fa-ban"></i> Ban User: ${userName}
                </h3>
                
                <p style="color:var(--text-muted);font-size:13px;margin-bottom:20px;">
                    Banning will permanently block their account. They won't be able to login.
                </p>
                
                <div style="margin-bottom:16px;">
                    <label style="display:block;font-size:12px;color:var(--text-muted);margin-bottom:8px;text-transform:uppercase;">Ban Reason</label>
                    <textarea id="ban-reason-input" style="width:100%;padding:12px;background:var(--bg-input);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:inherit;resize:vertical;" rows="3" placeholder="Enter reason (e.g., Cheating, Fraud, etc.)"></textarea>
                </div>
                
                <div style="background:rgba(255,23,68,0.1);padding:12px;border-radius:8px;margin-bottom:16px;">
                    <p style="font-size:12px;color:var(--danger);font-weight:600;">
                        ‚ö†Ô∏è Warning: This is a permanent action
                    </p>
                </div>
                
                <div style="display:flex;gap:10px;">
                    <button class="btn-sm btn-reject" onclick="confirmBanUser('${userId}', '${userName}')" style="flex:1;">
                        <i class="fas fa-ban"></i> Confirm Ban
                    </button>
                    <button class="btn-sm" style="background:var(--text-muted);" onclick="this.closest('div[style*=fixed]').remove()">
                        Cancel
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }

    async function confirmBanUser(userId, userName) {
        const reason = document.getElementById('ban-reason-input').value.trim();
        
        if (!reason) {
            showToast('Please enter a ban reason', 'error');
            return;
        }
        
        if (!confirm(`Are you sure you want to ban ${userName}?`)) {
            return;
        }
        
        try {
            await db.ref(`users/${userId}`).update({
                banned: true,
                banReason: reason,
                bannedAt: Date.now()
            });
            
            showToast(`‚úÖ ${userName} has been banned`, 'success');
            document.querySelector('div[style*=fixed]').remove();
            loadUsers();
            
        } catch (error) {
            console.error('Ban error:', error);
            showToast('Failed to ban user', 'error');
        }
    }

    // Unban User
    async function unbanUser(userId, userName) {
        if (!confirm(`Unban ${userName}?`)) return;
        
        try {
            await db.ref(`users/${userId}`).update({
                banned: false,
                banReason: null,
                bannedAt: null,
                unbannedAt: Date.now()
            });
            
            showToast(`‚úÖ ${userName} has been unbanned`, 'success');
            loadUsers();
            
        } catch (error) {
            console.error('Unban error:', error);
            showToast('Failed to unban user', 'error');
        }
    }

    // Suspend User
    function showSuspendUserModal(userId, userName) {
        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:9999;padding:20px;';
        modal.innerHTML = `
            <div style="background:var(--bg-card);border-radius:16px;padding:24px;max-width:450px;width:100%;">
                <h3 style="color:var(--warning);margin-bottom:16px;font-size:18px;">
                    <i class="fas fa-user-clock"></i> Suspend User: ${userName}
                </h3>
                
                <p style="color:var(--text-muted);font-size:13px;margin-bottom:20px;">
                    Temporary block for selected duration
                </p>
                
                <div style="margin-bottom:16px;">
                    <label style="display:block;font-size:12px;color:var(--text-muted);margin-bottom:8px;text-transform:uppercase;">Duration</label>
                    <select id="suspend-duration-select" style="width:100%;padding:12px;background:var(--bg-input);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:inherit;">
                        <option value="7">7 Days</option>
                        <option value="15">15 Days</option>
                        <option value="30">30 Days</option>
                        <option value="90">90 Days</option>
                    </select>
                </div>
                
                <div style="margin-bottom:16px;">
                    <label style="display:block;font-size:12px;color:var(--text-muted);margin-bottom:8px;text-transform:uppercase;">Reason</label>
                    <textarea id="suspend-reason-input" style="width:100%;padding:12px;background:var(--bg-input);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:inherit;resize:vertical;" rows="2" placeholder="Enter reason"></textarea>
                </div>
                
                <div style="display:flex;gap:10px;">
                    <button class="btn-sm" style="background:var(--warning);flex:1;" onclick="confirmSuspendUser('${userId}', '${userName}')">
                        <i class="fas fa-pause"></i> Suspend
                    </button>
                    <button class="btn-sm" style="background:var(--text-muted);" onclick="this.closest('div[style*=fixed]').remove()">
                        Cancel
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }

    async function confirmSuspendUser(userId, userName) {
        const duration = parseInt(document.getElementById('suspend-duration-select').value);
        const reason = document.getElementById('suspend-reason-input').value.trim();
        
        if (!reason) {
            showToast('Please enter a suspension reason', 'error');
            return;
        }
        
        try {
            const suspendUntil = Date.now() + (duration * 24 * 60 * 60 * 1000);
            
            await db.ref(`users/${userId}`).update({
                suspended: true,
                suspendReason: reason,
                suspendedAt: Date.now(),
                suspendUntil: suspendUntil,
                suspendDuration: duration
            });
            
            showToast(`‚úÖ ${userName} suspended for ${duration} days`, 'success');
            document.querySelector('div[style*=fixed]').remove();
            
        } catch (error) {
            console.error('Suspend error:', error);
            showToast('Failed to suspend user', 'error');
        }
    }

    // Manual Balance Adjustment
    function showBalanceAdjustmentModal(userId, userName) {
        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:9999;padding:20px;';
        modal.innerHTML = `
            <div style="background:var(--bg-card);border-radius:16px;padding:24px;max-width:450px;width:100%;">
                <h3 style="color:var(--primary);margin-bottom:16px;font-size:18px;">
                    <i class="fas fa-coins"></i> Adjust Balance: ${userName}
                </h3>
                
                <div style="margin-bottom:16px;">
                    <label style="display:block;font-size:12px;color:var(--text-muted);margin-bottom:8px;text-transform:uppercase;">Balance Type</label>
                    <select id="balance-type-select" style="width:100%;padding:12px;background:var(--bg-input);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:inherit;">
                        <option value="deposit">Deposit Balance</option>
                        <option value="winning">Winning Balance</option>
                    </select>
                </div>
                
                <div style="margin-bottom:16px;">
                    <label style="display:block;font-size:12px;color:var(--text-muted);margin-bottom:8px;text-transform:uppercase;">Action</label>
                    <select id="balance-action-select" style="width:100%;padding:12px;background:var(--bg-input);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:inherit;">
                        <option value="add">Add Amount</option>
                        <option value="deduct">Deduct Amount</option>
                    </select>
                </div>
                
                <div style="margin-bottom:16px;">
                    <label style="display:block;font-size:12px;color:var(--text-muted);margin-bottom:8px;text-transform:uppercase;">Amount (‡ß≥)</label>
                    <input type="number" id="balance-amount-input" style="width:100%;padding:12px;background:var(--bg-input);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:inherit;" placeholder="Enter amount" min="1">
                </div>
                
                <div style="margin-bottom:16px;">
                    <label style="display:block;font-size:12px;color:var(--text-muted);margin-bottom:8px;text-transform:uppercase;">Reason/Note</label>
                    <textarea id="balance-reason-input" style="width:100%;padding:12px;background:var(--bg-input);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:inherit;resize:vertical;" rows="2" placeholder="Enter reason for this adjustment"></textarea>
                </div>
                
                <div style="background:rgba(255,152,0,0.1);padding:12px;border-radius:8px;margin-bottom:16px;">
                    <p style="font-size:12px;color:var(--warning);font-weight:600;">
                        ‚ö†Ô∏è This action will be logged for audit
                    </p>
                </div>
                
                <div style="display:flex;gap:10px;">
                    <button class="btn-sm btn-approve" onclick="confirmBalanceAdjustment('${userId}', '${userName}')" style="flex:1;">
                        <i class="fas fa-check"></i> Confirm
                    </button>
                    <button class="btn-sm" style="background:var(--text-muted);" onclick="this.closest('div[style*=fixed]').remove()">
                        Cancel
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }

    async function confirmBalanceAdjustment(userId, userName) {
        const balanceType = document.getElementById('balance-type-select').value;
        const action = document.getElementById('balance-action-select').value;
        const amount = parseFloat(document.getElementById('balance-amount-input').value);
        const reason = document.getElementById('balance-reason-input').value.trim();
        
        if (!amount || amount <= 0) {
            showToast('Please enter a valid amount', 'error');
            return;
        }
        
        if (!reason) {
            showToast('Please enter a reason', 'error');
            return;
        }
        
        if (!confirm(`${action} ‡ß≥${amount} to ${userName}'s ${balanceType} balance?`)) {
            return;
        }
        
        try {
            const userSnapshot = await db.ref(`users/${userId}`).once('value');
            const userData = userSnapshot.val();
            
            const fieldName = balanceType === 'deposit' ? 'deposit' : 'winning';
            const currentBalance = parseFloat(userData[fieldName]) || 0;
            
            let newBalance;
            if (action === 'add') {
                newBalance = currentBalance + amount;
            } else {
                newBalance = Math.max(0, currentBalance - amount);
            }
            
            await db.ref(`users/${userId}`).update({
                [fieldName]: newBalance
            });
            
            // Log the adjustment
            await db.ref('balanceAdjustments').push({
                userId: userId,
                userName: userName,
                balanceType: balanceType,
                action: action,
                amount: amount,
                previousBalance: currentBalance,
                newBalance: newBalance,
                reason: reason,
                timestamp: Date.now()
            });
            
            showToast(`‚úÖ Balance ${action === 'add' ? 'added' : 'deducted'} successfully`, 'success');
            document.querySelector('div[style*=fixed]').remove();
            loadUsers();
            
        } catch (error) {
            console.error('Balance adjustment error:', error);
            showToast('Failed to adjust balance', 'error');
        }
    }

    // ==================== FCM PUSH NOTIFICATION SYSTEM ====================

    // ==================== DATABASE-BASED NOTIFICATION SYSTEM ====================
    // This method doesn't require FCM Server Key!
    // Notifications are stored in Firebase Database and users listen for them
    
    // Send Room Details Notification to Joined Players
    async function sendRoomDetailsNotification(matchId, matchData) {
        try {
            // Get all participants of this match
            const participantsSnapshot = await db.ref(`matchParticipants/${matchId}`).once('value');
            const participants = participantsSnapshot.val();
            
            if (!participants) {
                console.log('No participants found for this match');
                showToast('‚ö†Ô∏è No participants in this match', 'warning');
                return;
            }
            
            const userIds = Object.keys(participants);
            let notificationsSent = 0;
            
            // Create notification for each participant
            for (const userId of userIds) {
                const userSnapshot = await db.ref(`users/${userId}`).once('value');
                const userData = userSnapshot.val();
                
                if (userData && userData.notificationsEnabled) {
                    // Create notification in database
                    const notificationData = {
                        type: 'room_details',
                        title: 'üéÆ Room Details Updated!',
                        body: `${matchData.title}\nRoom ID: ${matchData.roomId}\nPassword: ${matchData.roomPassword}`,
                        matchId: matchId,
                        matchTitle: matchData.title,
                        roomId: matchData.roomId,
                        roomPassword: matchData.roomPassword,
                        timestamp: Date.now(),
                        read: false
                    };
                    
                    // Save to user's notifications
                    await db.ref(`userNotifications/${userId}`).push(notificationData);
                    notificationsSent++;
                }
            }
            
            if (notificationsSent > 0) {
                showToast(`‚úÖ Notification sent to ${notificationsSent} players!`, 'success');
            } else {
                showToast('‚ö†Ô∏è No users have notifications enabled', 'warning');
            }
            
        } catch (error) {
            console.error('Error sending room details notification:', error);
            showToast('‚ùå Failed to send notification', 'error');
        }
    }
    
    // Send Match Reminder Notification (Manual Button)
    async function sendMatchReminder(matchId, matchData) {
        try {
            // Get all participants
            const participantsSnapshot = await db.ref(`matchParticipants/${matchId}`).once('value');
            const participants = participantsSnapshot.val();
            
            if (!participants) {
                showToast('‚ö†Ô∏è No participants in this match', 'warning');
                return;
            }
            
            const userIds = Object.keys(participants);
            let notificationsSent = 0;
            
            const matchTime = new Date(matchData.dateTime).toLocaleString('bn-BD', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // Create notification for each participant
            for (const userId of userIds) {
                const userSnapshot = await db.ref(`users/${userId}`).once('value');
                const userData = userSnapshot.val();
                
                if (userData && userData.notificationsEnabled) {
                    const notificationData = {
                        type: 'match_reminder',
                        title: '‚è∞ Match Starting Soon!',
                        body: `${matchData.title}\n‡¶∏‡¶Æ‡¶Ø‡¶º: ${matchTime}\n\n‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶∞‡ßá‡¶°‡¶ø ‡¶π‡¶Ø‡¶º‡ßá ‡¶Ø‡¶æ‡¶®! üéÆ`,
                        matchId: matchId,
                        matchTitle: matchData.title,
                        timestamp: Date.now(),
                        read: false
                    };
                    
                    await db.ref(`userNotifications/${userId}`).push(notificationData);
                    notificationsSent++;
                }
            }
            
            if (notificationsSent > 0) {
                showToast(`‚úÖ Reminder sent to ${notificationsSent} players!`, 'success');
            } else {
                showToast('‚ö†Ô∏è No users have notifications enabled', 'warning');
            }
            
        } catch (error) {
            console.error('Error sending match reminder:', error);
            showToast('‚ùå Failed to send reminder', 'error');
        }
    }
    
    // Send Empty Slot Alert (Manual Button)
    async function sendEmptySlotAlert(matchId, matchData) {
        try {
            // Get all users who have notifications enabled
            const usersSnapshot = await db.ref('users').once('value');
            const users = usersSnapshot.val();
            
            if (!users) {
                showToast('‚ö†Ô∏è No users found', 'warning');
                return;
            }
            
            // Calculate available slots
            const availableSlots = matchData.slots - (matchData.participants || 0);
            
            if (availableSlots <= 0) {
                showToast('‚ö†Ô∏è Match is full!', 'warning');
                return;
            }
            
            const matchTime = new Date(matchData.dateTime).toLocaleString('bn-BD', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            let notificationsSent = 0;
            
            // Send notification to all users
            for (const userId in users) {
                const userData = users[userId];
                
                if (userData && userData.notificationsEnabled) {
                    const notificationData = {
                        type: 'empty_slot_alert',
                        title: '‚ö° ‡¶ú‡¶≤‡¶¶‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®! ‡¶∏‡¶ø‡¶ü ‡¶ñ‡¶æ‡¶≤‡¶ø ‡¶Ü‡¶õ‡ßá!',
                        body: `${matchData.title}\n‡¶∏‡¶Æ‡¶Ø‡¶º: ${matchTime}\n\n${availableSlots} ‡¶ü‡¶ø ‡¶∏‡¶ø‡¶ü ‡¶è‡¶ñ‡¶®‡ßã ‡¶ñ‡¶æ‡¶≤‡¶ø! ‡¶è‡¶ñ‡¶®‡¶á ‡¶ú‡¶Ø‡¶º‡ßá‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® üéÆ`,
                        matchId: matchId,
                        matchTitle: matchData.title,
                        availableSlots: availableSlots,
                        timestamp: Date.now(),
                        read: false
                    };
                    
                    await db.ref(`userNotifications/${userId}`).push(notificationData);
                    notificationsSent++;
                }
            }
            
            if (notificationsSent > 0) {
                showToast(`‚úÖ Alert sent to ${notificationsSent} users!`, 'success');
            } else {
                showToast('‚ö†Ô∏è No users have notifications enabled', 'warning');
            }
            
        } catch (error) {
            console.error('Error sending empty slot alert:', error);
            showToast('‚ùå Failed to send alert', 'error');
        }
    }

    // ======= TOURNAMENT GUIDE FUNCTIONS =======
    async function loadGuides() {
        const el = document.getElementById('guideList');
        el.innerHTML = '<div style="text-align:center;padding:20px;color:#999;">‚è≥ Loading...</div>';
        try {
            const snap = await db.ref('tournament_guides').once('value');
            const guides = snap.val() || {};
            if (!Object.keys(guides).length) {
                el.innerHTML = `<div style="text-align:center; padding:40px; color:#999;">
                    <i class="fas fa-book" style="font-size:48px; margin-bottom:10px; opacity:0.3;"></i>
                    <p>No guides added yet. Click "Add Guide" to create one.</p>
                </div>`;
                return;
            }
            el.innerHTML = Object.keys(guides).map(gid => {
                const g = guides[gid];
                return `<div class="card">
                    <div class="card-row"><span class="card-title" style="font-size:15px">üìö ${g.title||'Untitled Guide'}</span></div>
                    <div class="card-row"><span class="card-label">Link</span><span class="card-value" style="font-size:12px; word-break:break-all;">${g.link||'N/A'}</span></div>
                    <div class="card-actions" style="margin-top:10px;">
                        <button class="btn-sm" style="background:#1a73e8; color:#fff;" onclick="editGuide('${gid}')">‚úèÔ∏è Edit</button>
                        <button class="btn-sm btn-reject" onclick="deleteGuide('${gid}')">üóëÔ∏è Delete</button>
                    </div>
                </div>`;
            }).join('');
        } catch(e) {
            el.innerHTML = '<div style="text-align:center;padding:20px;color:#f00;">Error loading guides</div>';
        }
    }

    function openAddGuideModal() {
        document.getElementById('guideModalTitle').textContent = 'Add Tournament Guide';
        document.getElementById('editGuideId').value = '';
        document.getElementById('guideTitle').value = '';
        document.getElementById('guideLink').value = '';
        openSheet('sheetGuide');
    }

    async function editGuide(gid) {
        try {
            const snap = await db.ref('tournament_guides/' + gid).once('value');
            const g = snap.val();
            if (!g) { showToast('Guide not found','error'); return; }
            document.getElementById('guideModalTitle').textContent = 'Edit Tournament Guide';
            document.getElementById('editGuideId').value = gid;
            document.getElementById('guideTitle').value = g.title || '';
            document.getElementById('guideLink').value = g.link || '';
            openSheet('sheetGuide');
        } catch(e) { showToast(e.message,'error'); }
    }

    async function saveGuide() {
        const editId = document.getElementById('editGuideId').value;
        const data = {
            title: document.getElementById('guideTitle').value.trim(),
            link: document.getElementById('guideLink').value.trim(),
            updatedAt: Date.now()
        };
        if (!data.title || !data.link) { showToast('Please fill all fields','error'); return; }

        try {
            if (editId) {
                await db.ref('tournament_guides/' + editId).update(data);
                showToast('‚úÖ Guide updated!');
            } else {
                data.createdAt = Date.now();
                await db.ref('tournament_guides').push(data);
                showToast('‚úÖ Guide added!');
            }
            closeSheet('sheetGuide');
            loadGuides();
        } catch(e) { showToast(e.message,'error'); }
    }

    async function deleteGuide(gid) {
        if (!confirm('Delete this guide?')) return;
        try {
            await db.ref('tournament_guides/' + gid).remove();
            showToast('üóëÔ∏è Guide deleted!');
            loadGuides();
        } catch(e) { showToast(e.message,'error'); }
    }

    // ============ HISTORY SECTION ============
    
    async function loadHistoryByType() {
        const selectedType = document.getElementById('historyTypeSelect').value;
        const container = document.getElementById('historyContentContainer');
        
        container.innerHTML = '<div class="empty"><div class="empty-icon">‚è≥</div><p>Loading...</p></div>';
        
        if (selectedType === 'withdraw') {
            await loadWithdrawHistory();
        } else if (selectedType === 'deposit') {
            await loadDepositHistory();
        } else if (selectedType === 'winner') {
            await loadWinnerHistory();
        }
    }
    
    // Load Withdraw History
    async function loadWithdrawHistory() {
        const container = document.getElementById('historyContentContainer');
        
        try {
            const snapshot = await db.ref('withdrawRequests').once('value');
            
            if (!snapshot.exists()) {
                container.innerHTML = '<div class="empty"><div class="empty-icon">üì§</div><p>No withdraw history yet</p></div>';
                return;
            }
            
            const withdrawals = [];
            snapshot.forEach(child => {
                const w = child.val();
                w.id = child.key;
                if (w.status) withdrawals.push(w);
            });
            
            withdrawals.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            
            let html = '';
            for (const w of withdrawals.slice(0, 100)) {
                const userSnap = await db.ref(`users/${w.userId}`).once('value');
                const user = userSnap.val() || {};
                
                const date = new Date(w.timestamp || Date.now()).toLocaleString('bn-BD', {
                    day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit'
                });
                
                const statusBadge = w.status === 'approved' 
                    ? '<span class="badge badge-approved">‚úÖ Approved</span>'
                    : '<span class="badge badge-rejected">‚ùå Rejected</span>';
                
                const userName = user.username || user.displayName || user.name || w.userName || 'Unknown';
                const userEmail = user.email || w.userEmail || (w.userId ? 'No email' : 'N/A');
                
                html += `
                    <div class="card" style="margin-bottom:12px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                            <div>
                                <div style="font-size:15px; font-weight:700;">${userName}</div>
                                <div style="font-size:11px; color:var(--text-muted); margin-top:2px;">
                                    üìß ${userEmail}<br>
                                    üÜî ${w.userId.substring(0, 15)}...
                                </div>
                            </div>
                            ${statusBadge}
                        </div>
                        <div style="border-top:1px solid var(--border); padding-top:10px; margin-top:10px;">
                            <div style="font-size:13px; margin-bottom:4px;">üí∞ Amount: <strong>‡ß≥${w.amount}</strong></div>
                            <div style="font-size:12px; color:var(--text-muted); margin-bottom:4px;">üè¶ ${w.method || 'Bkash'} - ${w.accountNumber || '-'}</div>
                            <div style="font-size:11px; color:var(--text-muted);">‚è∞ ${date}</div>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html || '<div class="empty"><p>No records found</p></div>';
        } catch (error) {
            console.error('Error loading withdraw history:', error);
            container.innerHTML = '<div class="empty"><p>Error loading data</p></div>';
        }
    }
    
    // Load Deposit History
    async function loadDepositHistory() {
        const container = document.getElementById('historyContentContainer');
        
        try {
            const snapshot = await db.ref('depositRequests').once('value');
            
            if (!snapshot.exists()) {
                container.innerHTML = '<div class="empty"><div class="empty-icon">üì•</div><p>No deposit history yet</p></div>';
                return;
            }
            
            const deposits = [];
            snapshot.forEach(child => {
                const d = child.val();
                d.id = child.key;
                if (d.status) deposits.push(d);
            });
            
            deposits.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            
            let html = '';
            for (const d of deposits.slice(0, 100)) {
                const userSnap = await db.ref(`users/${d.userId}`).once('value');
                const user = userSnap.val() || {};
                
                const date = new Date(d.timestamp || Date.now()).toLocaleString('bn-BD', {
                    day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit'
                });
                
                const statusBadge = d.status === 'approved' 
                    ? '<span class="badge badge-approved">‚úÖ Approved</span>'
                    : '<span class="badge badge-rejected">‚ùå Rejected</span>';
                
                const userName = user.username || user.displayName || user.name || d.userName || 'Unknown';
                const userEmail = user.email || d.userEmail || (d.userId ? 'No email' : 'N/A');
                
                html += `
                    <div class="card" style="margin-bottom:12px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                            <div>
                                <div style="font-size:15px; font-weight:700;">${userName}</div>
                                <div style="font-size:11px; color:var(--text-muted); margin-top:2px;">
                                    üìß ${userEmail}<br>
                                    üÜî ${d.userId.substring(0, 15)}...
                                </div>
                            </div>
                            ${statusBadge}
                        </div>
                        <div style="border-top:1px solid var(--border); padding-top:10px; margin-top:10px;">
                            <div style="font-size:13px; margin-bottom:4px;">üí∞ Amount: <strong>‡ß≥${d.amount}</strong></div>
                            <div style="font-size:12px; color:var(--text-muted); margin-bottom:4px;">üè¶ ${d.method || 'Bkash'}</div>
                            <div style="font-size:12px; color:var(--text-muted); margin-bottom:4px;">üÜî TrxID: ${d.transactionId || '-'}</div>
                            <div style="font-size:11px; color:var(--text-muted);">‚è∞ ${date}</div>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html || '<div class="empty"><p>No records found</p></div>';
        } catch (error) {
            console.error('Error loading deposit history:', error);
            container.innerHTML = '<div class="empty"><p>Error loading data</p></div>';
        }
    }
    
    // Load Winner History
    async function loadWinnerHistory() {
        const container = document.getElementById('historyContentContainer');
        
        try {
            // Read from winnerBoard where prize distribution data is stored
            const snapshot = await db.ref('winnerBoard').once('value');
            
            if (!snapshot.exists()) {
                container.innerHTML = '<div class="empty"><div class="empty-icon">üèÜ</div><p>No winner history yet</p></div>';
                return;
            }
            
            const winnerData = snapshot.val();
            const matches = [];
            
            // Convert to array with tournament info
            for (const tid in winnerData) {
                const data = winnerData[tid];
                if (data.winners && data.winners.length > 0) {
                    matches.push({
                        id: tid,
                        title: data.tournamentTitle || data.title || 'Unknown Match',
                        timestamp: data.timestamp || data.distributedAt || Date.now(),
                        winners: data.winners
                    });
                }
            }
            
            if (matches.length === 0) {
                container.innerHTML = '<div class="empty"><div class="empty-icon">üèÜ</div><p>No winners found</p></div>';
                return;
            }
            
            // Sort by timestamp (newest first)
            matches.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            
            let html = '';
            for (const match of matches) {
                const matchDate = match.timestamp 
                    ? new Date(match.timestamp).toLocaleString('bn-BD', { day: '2-digit', month: 'short', year: 'numeric' })
                    : 'N/A';
                
                html += `
                    <div class="card" style="margin-bottom:20px; border:2px solid var(--primary);">
                        <div style="background:linear-gradient(135deg, var(--primary), #FF6347); padding:12px; border-radius:8px 8px 0 0; margin:-1px -1px 0 -1px;">
                            <div style="font-size:16px; font-weight:800; color:#fff; margin-bottom:4px;">üèÜ ${match.title}</div>
                            <div style="font-size:11px; color:rgba(255,255,255,0.9);">üìÖ ${matchDate}</div>
                        </div>
                        
                        <div style="padding:16px;">
                `;
                
                // Show all winners
                for (let i = 0; i < match.winners.length; i++) {
                    const winner = match.winners[i];
                    const rank = i + 1;
                    const rankEmoji = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : 'üèÖ';
                    
                    // Get user details
                    let userName = 'Unknown';
                    let userEmail = winner.leaderEmail || winner.email || 'N/A';
                    let userId = winner.leaderId || winner.userId || 'N/A';
                    
                    if (winner.leaderId || winner.userId) {
                        try {
                            const userSnap = await db.ref(`users/${winner.leaderId || winner.userId}`).once('value');
                            const user = userSnap.val();
                            if (user) {
                                userName = user.username || user.displayName || user.name || winner.leaderEmail || 'Unknown';
                                userEmail = user.email || winner.leaderEmail || winner.email || userEmail;
                            } else {
                                userName = winner.leaderEmail || winner.email || 'Unknown';
                            }
                        } catch (e) {
                            console.error('Error loading user:', e);
                            userName = winner.leaderEmail || winner.email || winner.userName || 'Unknown';
                        }
                    } else {
                        userName = winner.leaderEmail || winner.email || winner.userName || 'Unknown';
                    }
                    
                    html += `
                        <div style="background:${rank <= 3 ? 'linear-gradient(135deg, rgba(255,215,0,0.1), rgba(255,215,0,0.05))' : 'var(--bg-input)'}; 
                                    padding:12px; 
                                    border-radius:8px; 
                                    margin-bottom:10px; 
                                    border:1px solid ${rank <= 3 ? 'rgba(255,215,0,0.3)' : 'var(--border)'};">
                            <div style="display:flex; justify-content:space-between; align-items:start;">
                                <div style="flex:1;">
                                    <div style="font-size:14px; font-weight:700; color:var(--text); margin-bottom:6px;">
                                        ${rankEmoji} #${rank} - ${userName}
                                    </div>
                                    <div style="font-size:11px; color:var(--text-muted); margin-bottom:3px;">
                                        üìß ${userEmail}
                                    </div>
                                    <div style="font-size:11px; color:var(--text-muted);">
                                        üÜî ${userId !== 'N/A' && typeof userId === 'string' ? userId.substring(0, 15) + '...' : userId}
                                    </div>
                                </div>
                                <div style="text-align:right;">
                                    <div style="font-size:18px; font-weight:800; color:var(--success);">
                                        ‡ß≥${winner.totalPrize || winner.winPrize || winner.prize || 0}
                                    </div>
                                    <div style="font-size:10px; color:var(--text-muted); margin-top:2px;">Prize</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        } catch (error) {
            console.error('Error loading winner history:', error);
            container.innerHTML = '<div class="empty"><p>Error loading data</p></div>';
        }
    }

</script>

<!-- ======= IMAGE VIEWER MODAL ======= -->
<div id="imageViewerOverlay" class="image-viewer-overlay" onclick="closeImageViewer(event)">
    <div class="image-viewer-container">
        <button class="image-viewer-close" onclick="closeImageViewer()">√ó</button>
        <img id="imageViewerImg" class="image-viewer-img" src="" alt="Payment Screenshot">
        <div class="image-viewer-title" id="imageViewerTitle">Payment Screenshot</div>
    </div>
</div>




</body>
</html>
